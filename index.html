<!DOCTYPE html>
<html lang="hu">
<head>
    <!-- Tov√°bbi favicon t√°mogat√°s k√ºl√∂nb√∂z≈ë eszk√∂z√∂kh√∂z -->
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
    <meta charset="UTF-8" />
    <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <link rel="manifest" href="manifest.json" crossorigin="use-credentials">
    <link rel="icon" type="image/png" href="./icon.png">
    <title>M≈±szak Napt√°r</title>
    <style>
    @font-face {
        font-family: 'Verdana';
        src: url('verdana.woff2') format('woff2'),
                url('verdana.woff') format('woff'),
                url('verdana.ttf') format('truetype');
        font-weight: bold;
        font-style: normal;
    }
    
    * {
        font-family: Verdana, Arial, Helvetica, sans-serif;
        font-weight: bold;
        box-sizing: border-box;
        margin: 0;
        padding: 0;
        touch-action: manipulation;
    }

    body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
        sans-serif;
        background-color: #f4f4f4;
        height: 100vh;
        display: flex;
        flex-direction: column;
        padding-top: 100px;
    }

    #navbar {
        background-color: #000;
        color: white;
        display: flex;
        width: 100%;
        height: 90px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        position: fixed;
        top: 0;
        left: 0;
        z-index: 1000;
        justify-content: space-between;
        padding: 0 5px;
        gap: 2px;
    }
    
    #navbar button {
        background-color: transparent;
        border: none;
        color: white;
        height: 90px;
        font-size: 16px;
        padding: 0 10px;
        white-space: nowrap;
        display: flex;
        align-items: center;
        justify-content: center;
        flex: 0 1 auto;
    }
    
    #calendar-btn {
        flex: 1.2;
    }
    
    #payroll-btn {
        flex: 1.5;
    }
    
    #settings-btn {
        flex: 1.3;
    }
    
    #help-btn {
        flex: 0.8;
    }


    .section {
        display: none;
    }

    .section.active {
        display: block;
    }

    #content {
    width: 100%;
    box-sizing: border-box;
    height: calc(100vh - 90px);
    overflow-y: auto;
    }

    #calendar-header {
        display: flex;
        flex-shrink: 0;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
    }

    #calendar-header button {
        background-color: #000;
        color: white;
        border: none;
        margin: 5px;
        padding: 10px 15px;
        font-size: 30px;
        border-radius: 5px;
    }

    #current-month {
        font-size: 30px;
        margin: 0;
    }

    #current-payroll-month {
        font-size: 30px;
        margin: 0;   
    }

    #calendarTable {
        flex-grow: 1;
        min-height: 80%;
        height: 85%;
        width: 100%;
        border-collapse: collapse;
        table-layout: fixed;
        margin-bottom: 0;
    }

    #calendarTable th {
        border: 3px groove #000;
        border-radius: 10px;
        padding: 1px;
        text-align: center;
        vertical-align: center;
        height: 40px;
        width: 14.28571%;   
    }
    #calendarTable td {
        border: 3px groove #ddd;
        border-radius: 10px;
        padding: 1px;
        text-align: center;
        vertical-align: top;
        height: 80px;
        width: 14.28571%;
    }

    .date-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        height: 100%;
        width: 100%;
        user-select: none;
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
    }

    .date-number {
        font-weight: bold;
        margin: 3px 3px;
        font-size: 10px;
        color: #333;
        width: 30px;
        height: 40px;
        background-color: #f0f0f0;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        align-self: center;
    }

    /* Sz√≠nbe√°ll√≠t√°sok st√≠lusai */
    .color-row {
        display: flex;
        align-items: center;
        margin: 10px 0;
        padding: 10px;
        background-color: #f5f5f5;
        border-radius: 8px;
        min-width: 0; /* Flexbox t√∫lcsordul√°s megakad√°lyoz√°sa */
        flex-wrap: wrap; /* Mobilon t√∂rdel√©s enged√©lyez√©se */
        gap: 10px; /* Elemek k√∂z√∂tti t√°vols√°g */
    }

    .color-row span {
        width: 33.3%;
        margin-right: 10px;
    }

    .color-buttons {
        display: flex;
        flex: 1;
        gap: 10px;
        min-width: 0; /* Flexbox t√∫lcsordul√°s megakad√°lyoz√°sa */
    }
    
    .color-picker {
        flex: 1;
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        background: white;
        cursor: pointer;
        min-width: 0; /* Flexbox t√∫lcsordul√°s megakad√°lyoz√°sa */
        white-space: nowrap; /* Sz√∂veg egy sorban tart√°sa */
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .color-picker:hover {
        background: #f0f0f0;
    }

    .color-preview {
        width: 100%;
        max-width: 120px; /* Maximum sz√©less√©g megad√°sa */
        min-width: 80px; /* Minimum sz√©less√©g megad√°sa */
        height: 50px;
        border: 1px solid #ddd;
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        text-align: center;
        padding: 4px;
        font-size: 12px;
        font-weight: bold;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        flex-shrink: 0; /* Megakad√°lyozza a zsugorod√°st */
    }

    @media (max-width: 480px) {
        .color-row {
            padding: 8px;
        }
    
        .color-preview {
            width: 100%;
            max-width: none;
            margin-bottom: 5px;
        }
    
        .color-buttons {
            width: 100%;
            flex-direction: row;
        }
    
        .color-picker {
            padding: 6px 8px;
            font-size: 14px;
        }
    }

    /* Alap√©rtelmezett sz√≠nek a preview-khoz */
    .nappal-preview {
        background-color: #ffd700;
        color: black;
    }

    .ejszaka-preview {
        background-color: #4169e1;
        color: white;
    }

    .szabadsag-preview {
        background-color: #09fd00;
        color: black;
    }

    .tulora-preview {
        background-color: #ff0000;
        color: white;
    }

    .csuszo-preview {
        background-color: #dda0dd;
        color: black;
    }

    .tappenz-preview {
        background-color: #000000;
        color: white;
    }

    /* H√©tv√©g√©k kiemel√©se */
    #calendarTable tr td:nth-child(6),
    #calendarTable tr td:nth-child(7) {
        background-color: #f9f9f9;
    }

    /* √únnepnapok piros sz√≠nnel */
    .holiday {
        background-color: #ff5353 !important; /* Halv√°ny piros */
        border-radius: 0 !important;
    }
    
    .holiday .date-number {
        color: #ff0000 !important; /* S√∂t√©tpiros sz√∂veg */
        font-weight: bold;
    }

    #calendar-section {
        touch-action: pan-y;
        flex-grow: 1;
        height: 100%;
        display: flex;
        flex-direction: column;
    }

    .mobile-button {
        display: block;
        width: 100%;
        padding: 15px;
        margin: 10px 0;
        background-color: #fff;
        color: black;
        border: black 1px solid;
        border-radius: 5px;
        font-size: 16px;
        text-align: center;
    }

    /* Be√°ll√≠t√°sok szekci√≥ st√≠lusai */
    #settings-section {
        padding: 20px;
        text-align: center;
    }

    .settings-group {
        display: flex;
        align-items: center;
        justify-content: space-between;
        width: 100%;
        padding: 10px 0;
      }
      
    .settings-group > * {
        flex: 1;
    }

    /* √öj st√≠lusok a settings szekci√≥hoz */
    .settings-content {
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
    }

    .flex-row {
        display: flex;
        gap: 10px;
        margin-bottom: 10px;
    }

    .flex-row > * {
        flex: 1;
    }

    .checkbox-container {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 10px;
        padding: 10px;
        background: #f5f5f5;
        border-radius: 5px;
    }

    .midyear-change-container {
        display: flex;
        align-items: center;
        justify-content: space-between;
        width: 100%;
      }
      
      .midyear-change-container > * {
        flex: 1;
      }

    #settings-header {
        font-size: 30px;
        margin: 0;
    }

    #settings-header button {
        background-color: #000;
        color: white;
        border: none;
        padding: 10px 15px;
        font-size: 24px;
        border-radius: 5px;
    }

    .midyear-change-item {
        background: white;
        padding: 10px;
        margin-top: 10px;
        border-radius: 5px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        width: 100%;
    }

    #color-settings {
        max-width: 100%;
        overflow-x: hidden; /* V√≠zszintes g√∂rget√©s megakad√°lyoz√°sa */
        padding: 15px;
        background-color: white;
        border: 1px solid black;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    /* Alap st√≠lusok minden shift-select elemre */
    .shift-select {
        width: 100%;
        font-size: 10px;
        padding: 0px;
        margin-top: 3px;
        border: 1px solid #ddd;
        border-radius: 4px;
        height: 100%;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: wrap;
        cursor: pointer;
        text-align: center;
        word-break: break-all;
    }

    select.shift-select {
        appearance: menulist;
        -webkit-appearance: menulist;
        -moz-appearance: menulist;
    }

    div.shift-select {
        display: flex;
        align-items: center;
        justify-content: center;
    }


    .shift-select-modal {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 80%;
        max-width: 400px;
        max-height: 80vh; /* Maximum magass√°g a viewport 80%-a */
        background-color: white;
        border: 2px solid #4a90e2;
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        z-index: 1000;
        overflow-y: auto; /* G√∂rget√©s enged√©lyez√©se */
        -webkit-overflow-scrolling: touch; /* Jobb g√∂rget√©s mobilon */
    }

    /* Opcion√°lis: g√∂rget≈ës√°v st√≠lusa */
    .shift-select-modal::-webkit-scrollbar {
        width: 8px;
    }

    .shift-select-modal::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 4px;
    }

    .shift-select-modal::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 4px;
    }

    .shift-select-modal::-webkit-scrollbar-thumb:hover {
        background: #555;
    }

    .shift-select-modal select {
        width: 100%;
        font-size: 16px;
        padding: 10px;
        margin-bottom: 7px;
    }

    .shift-select-modal button {
        font-size: 14px; /* Nagyobb bet≈±m√©ret a modal gomboknak */
        padding: 12px; /* T√∂bb padding */
    }

    .shift-select-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 999;
    }

    #payroll-table {
        width: 100%;
        border-collapse: collapse;
    }

    #payroll-table th,
    #payroll-table td {
        border: 5px groove #000;
        padding: 8px;
        text-align: left;
        font-weight: bold;
    }

    #payroll-table tr:nth-child(even) {
        background-color: #f2f2f2;
    }

    #payroll-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
    }

    #payroll-header button {
        background-color: #000;
        color: white;
        border: none;
        margin: 5px;
        padding: 10px 15px;
        font-size: 30px;
        border-radius: 5px;
    }

    .w-24 {
        width: 6rem;
    }

    .text-right {
        text-align: right;
    }

    .px-2 {
        padding-left: 0.5rem;
        padding-right: 0.5rem;
    }

    .py-1 {
        padding-top: 0.25rem;
        padding-bottom: 0.25rem;
    }

    .border {
        border: 1px solid #e2e8f0;
    }

    .rounded {
        border-radius: 0.25rem;
    }

    /* Input mez≈ë st√≠lusok */
    #payroll-body input[type="number"] {
        border: 1px solid #e2e8f0;
        padding: 4px 8px;
        font-size: 16px;
        font-weight: bold;
        width: 100px;
        text-align: center;
    }

    #payroll-body input[type="number"]:focus {
        outline: none;
        border-color: #4a90e2;
        box-shadow: 0 0 0 2px rgba(74, 144, 226, 0.2);
    }

    salary-container {
      position: relative;
      display: flex;
      align-items: center;
      width: 100%;
    }
    
    .salary-input {
      width: 100%;
      transition: all 0.3s ease;
    }
    
    .visibility-toggle {
      position: absolute;
      right: 10px;
      background: none;
      border: none;
      cursor: pointer;
      padding: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 40px;
      height: 40px;
      transition: transform 0.3s ease;
    }
    
    .visibility-toggle:active {
      transform: scale(0.9);
    }
    
    @keyframes fadeMask {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    .masked-value {
      animation: fadeMask 0.3s ease;
    }

    @keyframes slideInRight {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
    
    @keyframes slideInLeft {
        from {
            transform: translateX(-100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
    
    @keyframes slideOutRight {
        from {
            transform: translateX(0);
            opacity: 1;
        }
        to {
            transform: translateX(100%);
            opacity: 0;
        }
    }
    
    @keyframes slideOutLeft {
        from {
            transform: translateX(0);
            opacity: 1;
        }
        to {
            transform: translateX(-100%);
            opacity: 0;
        }
    }
    
    #calendar-section, #payroll-section {
        position: relative;
        overflow: hidden;
    }
    
    #calendar-body, #payroll-body {
        animation-duration: 0.2s;
        animation-fill-mode: both;
    }
    
    .slide-in-right {
        animation-name: slideInRight;
    }
    
    .slide-in-left {
        animation-name: slideInLeft;
    }
    
    .slide-out-right {
        animation-name: slideOutRight;
    }
    
    .slide-out-left {
        animation-name: slideOutLeft;
    }

    @keyframes slideYearInRight {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
    
    @keyframes slideYearInLeft {
        from {
            transform: translateX(-100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
    
    @keyframes slideYearOutRight {
        from {
            transform: translateX(0);
            opacity: 1;
        }
        to {
            transform: translateX(100%);
            opacity: 0;
        }
    }
    
    @keyframes slideYearOutLeft {
        from {
            transform: translateX(0);
            opacity: 1;
        }
        to {
            transform: translateX(-100%);
            opacity: 0;
        }
    }
    
    #settings-content {
        position: relative;
        overflow: hidden;
    }
    
    .slide-year-in-right {
        animation: slideYearInRight 0.2s forwards;
    }
    
    .slide-year-in-left {
        animation: slideYearInLeft 0.2s forwards;
    }
    
    .slide-year-out-right {
        animation: slideYearOutRight 0.2s forwards;
    }
    
    .slide-year-out-left {
        animation: slideYearOutLeft 0.2s forwards;
    }
        
    </style>
</head>
<body>
    <div id="navbar">
    <button id="calendar-btn">NAPT√ÅR</button>
    <button id="payroll-btn">B√âR</button>
    <button id="settings-btn">BE√ÅLL√çT√ÅSOK</button>
    <button id="help-btn">S√öG√ì</button>
    </div>

    <div id="content">
    <div id="calendar-section" class="section active">
        <div id="calendar-header">
        <button id="prev-month-btn">‚Üê</button>
        <h2 id="current-month">Janu√°r 2024</h2>
        <button id="next-month-btn">‚Üí</button>
        </div>
        <table id="calendarTable">
        <thead>
            <tr>
            <th>H</th>
            <th>K</th>
            <th>SZE</th>
            <th>CS</th>
            <th>P</th>
            <th>SZO</th>
            <th>V</th>
            </tr>
        </thead>
        <tbody id="calendar-body">
            <!-- Napt√°r tartalma ide gener√°l√≥dik -->
        </tbody>
        </table>
    </div>

    <div id="payroll-section" class="section">
        <div id="payroll-header">
        <button id="prev-payroll-month-btn">‚Üê</button>
        <h2 id="current-payroll-month">Janu√°r 2024</h2>
        <button id="next-payroll-month-btn">‚Üí</button>
        </div>
        <div id="payroll-content">
        <table id="payroll-table">
            <thead>
            <tr>
                <th>T√©tel</th>
                <th>√ârt√©k</th>
            </tr>
            </thead>
            <tbody id="payroll-body">
            <!-- Ide gener√°l√≥dnak a b√©rsz√°mfejt√©si t√©telek -->
            </tbody>
        </table>
        </div>
    </div>

    <div id="settings-section" class="section">
        <!-- Fejl√©c az √©v v√°lt√°shoz -->
        <div
        id="settings-header"
        style="
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        "
        >
        <button
            id="prev-settings-year-btn"
            style="
            background-color: #000;
            color: white;
            border: none;
            padding: 10px 15px;
            font-size: 40px;
            margin-left: -10px;
            border-radius: 5px;
            "
        >
            ‚Üê
        </button>
        <h2 id="current-settings-year"></h2>
        <button
            id="next-settings-year-btn"
            style="
            background-color: #000;
            color: white;
            border: none;
            padding: 10px 15px;
            font-size: 30px;
            margin-right: -10px;
            border-radius: 5px;
            "
        >
            ‚Üí
        </button>
        </div>

        <!-- M≈±szakrend -->
        <div class="setting-group">
        <h3>M≈±szakrend</h3>
        <select id="shift-pattern-select" class="mobile-button">
            <option value="1">1.</option>
            <option value="2">2.</option>
            <option value="3">3.</option>
            <option value="4">4.</option>
            <option value="A">A</option>
            <option value="B">B</option>
            <option value="C">C</option>
        </select>
        </div>

        <!-- Besorol√°si b√©r -->
        <div class="setting-group">
        <h3>Besorol√°si b√©r</h3>
        <div style="position: relative;">
            <input
                type="number"
                id="base-salary"
                class="mobile-button salary-input"
                placeholder="Besorol√°si b√©r"
                style="padding-right: 45px;"
            />
        </div>
        <div class="setting-group">
            <h3>√âves szabads√°g</h3>
            <input type="number" id="vacation-days" class="mobile-button" placeholder="√âves szabads√°gnapok" step="0.5">
        </div>

        <!-- √âvk√∂zi v√°ltoz√°s -->
        <div style="margin-top: 10px">
            <h3>√âvk√∂zi b√©rv√°ltoz√°s be√°ll√≠t√°sa</h3>
            <select
            id="midyear-month"
            class="mobile-button"
            style="width: 65%; display: inline-block"
            >
            <option value="">V√°lassz h√≥napot...</option>
            <option value="0">Janu√°r</option>
            <option value="1">Febru√°r</option>
            <option value="2">M√°rcius</option>
            <option value="3">√Åprilis</option>
            <option value="4">M√°jus</option>
            <option value="5">J√∫nius</option>
            <option value="6">J√∫lius</option>
            <option value="7">Augusztus</option>
            <option value="8">Szeptember</option>
            <option value="9">Okt√≥ber</option>
            <option value="10">November</option>
            <option value="11">December</option>
            </select>
            <input
            type="number"
            id="midyear-salary"
            class="mobile-button"
            placeholder="√öj besorol√°si b√©r"
            style="width: 65%; display: inline-block"
            />
        </div>
        <button id="add-midyear-change" class="mobile-button">
            √âvk√∂zi v√°ltoz√°s hozz√°ad√°sa
        </button>
        <div id="midyear-changes-list" style="margin-top: 10px"></div>
        </div>

        <div class="setting-group">
            <h3>Csal√°di ad√≥kedvezm√©ny</h3>
            <input type="number" id="children-count" class="mobile-button" placeholder="Gyermekek sz√°ma" min="0" max="99"/>
        </div>

        <!-- Egy√©b j√∂vedelem -->
        <div class="setting-group">
        <h3>Egy√©b j√∂vedelem</h3>
        <input
            type="number"
            id="other-income"
            class="mobile-button"
            placeholder="Egy√©b j√∂vedelem"
        />
        </div>

        <!-- 25 √©v alatti kedvezm√©ny -->
        <div class="setting-group">
        <h3>25 √©v alatti kedvezm√©ny</h3>
        <div style="margin-bottom: 10px">
            <input
            type="checkbox"
            id="under25-checkbox"
            style="margin-right: 10px"
            />
            <label for="under25-checkbox">25 √©v alatti vagyok</label>
        </div>
        <div id="birth-date-container" style="display: none">
            <input
            type="number"
            id="birth-year"
            class="mobile-button"
            placeholder="Sz√ºlet√©si √©v"
            style="width: 49%; display: inline-block"
            />
            <select
            id="birth-month"
            class="mobile-button"
            style="width: 49%; display: inline-block"
            >
            <option value="">Sz√ºlet√©si h√≥nap</option>
            <option value="1">Janu√°r</option>
            <option value="2">Febru√°r</option>
            <option value="3">M√°rcius</option>
            <option value="4">√Åprilis</option>
            <option value="5">M√°jus</option>
            <option value="6">J√∫nius</option>
            <option value="7">J√∫lius</option>
            <option value="8">Augusztus</option>
            <option value="9">Szeptember</option>
            <option value="10">Okt√≥ber</option>
            <option value="11">November</option>
            <option value="12">December</option>
            </select>
        </div>
        </div>

        <!-- Sz√≠nbe√°ll√≠t√°sok -->
        <div class="setting-group">
        <h3>Sz√≠nbe√°ll√≠t√°sok</h3>
        <div id="color-settings">
            <!-- Nappali m≈±szak -->
            <div class="color-row">
            <div class="color-preview nappal-preview">Nappal</div>
            <div class="color-buttons">
                <button
                class="color-picker"
                data-shift-type="nappal"
                data-color-type="bg"
                >
                H√°tt√©rsz√≠n
                </button>
                <button
                class="color-picker"
                data-shift-type="nappal"
                data-color-type="text"
                >
                Sz√∂vegsz√≠n
                </button>
            </div>
            </div>

            <!-- √âjszakai m≈±szak -->
            <div class="color-row">
            <div class="color-preview ejszaka-preview">√âjszaka</div>
            <div class="color-buttons">
                <button
                class="color-picker"
                data-shift-type="ejszaka"
                data-color-type="bg"
                >
                H√°tt√©rsz√≠n
                </button>
                <button
                class="color-picker"
                data-shift-type="ejszaka"
                data-color-type="text"
                >
                Sz√∂vegsz√≠n
                </button>
            </div>
            </div>

            <!-- Szabads√°g -->
            <div class="color-row">
            <div class="color-preview szabadsag-preview">Szabads√°g</div>
            <div class="color-buttons">
                <button
                class="color-picker"
                data-shift-type="szabadsag"
                data-color-type="bg"
                >
                H√°tt√©rsz√≠n
                </button>
                <button
                class="color-picker"
                data-shift-type="szabadsag"
                data-color-type="text"
                >
                Sz√∂vegsz√≠n
                </button>
            </div>
            </div>

            <!-- T√∫l√≥ra -->
            <div class="color-row">
            <div class="color-preview tulora-preview">T√∫l√≥ra</div>
            <div class="color-buttons">
                <button
                class="color-picker"
                data-shift-type="tulora"
                data-color-type="bg"
                >
                H√°tt√©rsz√≠n
                </button>
                <button
                class="color-picker"
                data-shift-type="tulora"
                data-color-type="text"
                >
                Sz√∂vegsz√≠n
                </button>
            </div>
            </div>

            <!-- Cs√∫sz√≥ -->
            <div class="color-row">
            <div class="color-preview csuszo-preview">Cs√∫sz√≥</div>
            <div class="color-buttons">
                <button
                class="color-picker"
                data-shift-type="csuszo"
                data-color-type="bg"
                >
                H√°tt√©rsz√≠n
                </button>
                <button
                class="color-picker"
                data-shift-type="csuszo"
                data-color-type="text"
                >
                Sz√∂vegsz√≠n
                </button>
            </div>
            </div>

            <!-- T√°pp√©nz -->
            <div class="color-row">
            <div class="color-preview tappenz-preview">T√°pp√©nz</div>
            <div class="color-buttons">
                <button
                class="color-picker"
                data-shift-type="tappenz"
                data-color-type="bg"
                >
                H√°tt√©rsz√≠n
                </button>
                <button
                class="color-picker"
                data-shift-type="tappenz"
                data-color-type="text"
                >
                Sz√∂vegsz√≠n
                </button>
            </div>
            </div>
        </div>
        </div>

        <!-- Ment√©s gomb --> 
        <button id="save-settings" class="mobile-button">Ment√©s</button>
    </div>

    <div id="help-section" class="section">
    <div style="margin: 15px; text-align: left; padding: 15px; line-height: 1.6;">
        <h3>A program haszn√°lata:</h3>
        
        <h4>√âv v√°laszt√≥:</h4>
        <p>Az aktu√°lisan kiv√°lasztott √©v Napt√°r, B√©rsz√°mfejt√©s √©s Be√°ll√≠t√°sai fognak megjelenni mindig. Ha egy m√°sik √©vet szeretn√©l szerkeszteni, akkor az √âv v√°laszt√≥ban csak v√°laszd ki az √∫j √©vet.</p>
        
        <h4>Be√°ll√≠t√°sok:</h4>
        <ol>
            <li><strong>Besorol√°si b√©r:</strong> Ebb≈ël az adatb√≥l fogja kisz√°molni a program mennyit keresel a h√≥napban.</li>
            <li><strong>√âves szabads√°g:</strong> Ide az √©ves szabads√°godat kell be√≠rni (pl. 25). A b√©rsz√°mfejt√©sben nyomon tudod k√∂vetni, mennyi szabads√°god marad a h√≥nap v√©g√©n.</li>
            <li><strong>M≈±szakrend (1-2-3-4-A-B-C):</strong> A program a kiv√°lasztott m≈±szakrend szerint elk√©sz√≠ti a m≈±szakrendet a kiv√°laszott √©vre. Hogyha √∫j m≈±szakrendet adsz meg, akkor az t√∂r√∂lni fogja a Napt√°rba bevitt adatokat p√©ld√°ul Szabads√°g, T√∫l√≥ra stb. ez√©rt √∫jra be kell ≈ëket √≠rni.</li>
            <li><strong>Egy√©b j√∂vedelmek:</strong> Ide √≠rhatod az olyan j√∂vedelmeket mint p√©ld√°ul a gyerekek ut√°n j√°r√≥ kedvezm√©ny. Fontos hogy nett√≥ban √≠rd be az √∂sszeget. Ha csak a brutt√≥t tudod, akkor azt az √©rt√©ket p√©ld√°ul 50.000, szorozd meg 0,665-el √©s √≠gy megkapod a nett√≥ √©rt√©ket. Ha nem tudod mennyi a Brutt√≥ √©s a Nett√≥ sem, akkor √©rdemes az interneten kutatni.</li>
            <li><strong>25 √©v alatti kedvezm√©ny:</strong> Ha bepip√°lod akkor meg kell adnod a sz√ºlet√©si √©ved √©s h√≥napod, a program eszerint fogja a kedvezm√©nyt megadni. Minden √©vben meg kell adni. A 2026-os √©vre el≈ëre nem lehet tudni mennyi lesz a kedvezm√©ny, √∫gyhogy a 2025-√∂s √©vet haszn√°lja a program.</li>
            <li><strong>√âv k√∂zbeni besorol√°si b√©r v√°ltoz√°s:</strong> Ha √©v k√∂zben √∫j besorol√°si b√©rt kapsz, akkor azt ide kell be√≠rnod √©s att√≥l a h√≥napt√≥l kezdve amit kiv√°lasztasz, a program m√°r az √∫j b√©reddel fog sz√°molni. Az eredeti besorol√°si b√©rt NE v√°ltoztasd meg, illetve figyelj oda hogy a megfelel≈ë √©v van kiv√°lasztva.</li>
        </ol>

        <h4>Napt√°r:</h4>
        <ol>
            <li>A Napt√°rt a m≈±szakrend szerint a program elk√©sz√≠ti, amit ut√°na b√°rmikor m√≥dos√≠thatsz.</li>
            <li><strong>FONTOS</strong> hogy a megfelel≈ë adat legyen kiv√°lasztva, teh√°t ha √âjszak√°s vagy √©s szabads√°gra m√©sz, akkor a Szabads√°g √©jszaka opci√≥k k√∂z√ºl kell v√°lasztanod √©s ugyan√≠gy mindenhol ahol ilyen opci√≥ van.</li>
            <li>Ha rossz adatokat v√°lasztasz ki, akkor a program nem fog pontosan sz√°molni. (Szabads√°g, T√∫l√≥ra, Cs√∫sz√≥)</li>
            <li>Nem mindegy hogym≈±szakot cs√∫szol le, vagy pedig a t√∫l√≥ra keretedb≈ël veszel el. Ha csak m≈±szakot cs√∫szol vagy m≈±szakot cser√©lsz, akkor az eredeti m≈±szakodat t√∂r√∂ld ki √©s az √∫j d√°tum hely√©re add meg a m≈±szakot.</li>
            <li>Ha a t√∫l√≥ra keretedb≈ël veszel el, akkor kell haszn√°lni a "Cs√∫sz√≥" adatokat. Itt is odafigyelve hogy √©jszaka vagy sima nappal. Ha kombin√°lod a Cs√∫sz√≥t √©s a Szabads√°got, akkor csak a Szabads√°got kell kiv√°lasztani. P√©lda: 8 √≥ra szabads√°g + 4 √≥ra Cs√∫sz√≥, akkor csak a Szabads√°g 8 √≥ra adatot kell kiv√°lasztani.</li>
        </ol>

        <h4>B√©rsz√°mfejt√©si Sz√°m√≠t√°sok Magyar√°zata:</h4>
        <p>A program a Napt√°rba √©s a Be√°ll√≠t√°sokba bevitt adatok alapj√°n dolgozik, kiv√©vel a B√≥nusz(0,1 vagy 2) √©s az √âttermi fogyaszt√°st. Ezeket k√©zzel kell be√≠rni minden h√≥napban(√©s √©vben). Mindig ellen≈ërizd hogy meg-e volt mindk√©t b√≥nuszod, mivel ha m√°r az egyik nem volt meg, akkor az m√°r k√∂nnyen megl√°tsz√≥dik a nett√≥ b√©ren.</p>
        <div style="background-color: #fff3cd; color: #856404; padding: 15px; border: 1px solid #ffeeba; border-radius: 5px; margin-bottom: 20px;">
            <h4 style="color: #856404; margin-top: 0;">Figyelmeztet√©s!</h4>
            <p>Ez a program kiz√°r√≥lag t√°j√©koztat√≥ jelleg≈± sz√°m√≠t√°sokat v√©gez. A programban szerepl≈ë sz√°m√≠t√°sok √©s eredm√©nyek nem tekinthet≈ëk hivatalos b√©rsz√°mfejt√©snek. A program haszn√°lata saj√°t felel≈ëss√©gre t√∂rt√©nik. Elt√©r√©s eset√©n el≈ësz√∂r bizonyosodj meg hogy val√≥ban hiba t√∂rt√©nt √©s nem a program nem j√≥ haszn√°lata miatt t√∂rt√©nt hiba. A program hib√°zhat, ezt mindig vedd figyelembe.</p>
        </div>
    </div>
    </div>
    </div>

    <script>
    let app;

    function initSalaryVisibility() {
        const salaryInput = document.getElementById('base-salary');
        const toggleButton = document.createElement('button');
        toggleButton.id = 'toggle-salary-visibility';
        toggleButton.className = 'visibility-toggle';
        toggleButton.innerHTML = 'üëÅÔ∏è‚Äçüó®Ô∏è';
        let isVisible = false;
        let originalValue = salaryInput?.value || '';
        let hideTimeout;
    
        // CSS anim√°ci√≥k
        const style = document.createElement('style');
        style.textContent = `
            .salary-input {
                transition: opacity 0.3s ease-in-out;
            }
            .salary-fade {
                opacity: 0.5;
            }
            .visibility-toggle {
                transition: transform 0.2s ease;
            }
            .visibility-toggle:active {
                transform: translateY(-50%) scale(0.9);
            }
        `;
        document.head.appendChild(style);
    
        // St√≠lusok be√°ll√≠t√°sa
        toggleButton.style.cssText = `
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            padding: 15px;
            font-size: 24px;
            z-index: 10;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        `;
    
        // √ârt√©k maszkol√°sa
        const maskValue = (value) => '‚Ä¢'.repeat(String(value).length);
    
        // √ârt√©k megjelen√≠t√©s kezel√©se
        const updateInputVisibility = () => {
            if (isVisible) {
                salaryInput.type = 'number';
                salaryInput.value = originalValue;
            } else {
                // El≈ësz√∂r √°ll√≠tsuk be text t√≠pus√∫ra
                salaryInput.type = 'text';
                // Majd maszkoljuk az √©rt√©ket
                salaryInput.value = maskValue(originalValue);
            }
        };
    
        if (salaryInput) {
            salaryInput.parentElement.style.position = 'relative';
            salaryInput.style.paddingRight = '45px';
            salaryInput.parentElement.appendChild(toggleButton);
    
            // Kezdeti √°llapot be√°ll√≠t√°sa
            updateInputVisibility();
    
            // Input esem√©nykezel≈ë
            salaryInput.addEventListener('input', function(e) {
                clearTimeout(hideTimeout);
                if (this.type === 'number') {
                    originalValue = this.value;
                    
                    if (!isVisible) {
                        hideTimeout = setTimeout(() => {
                            this.type = 'text';
                            this.value = maskValue(originalValue);
                        }, 1500);
                    }
                }
            });
    
            // L√°that√≥s√°g v√°lt√°s kezel√©se
            const toggleVisibility = (e) => {
                e.preventDefault();
                e.stopPropagation();
                
                isVisible = !isVisible;
                clearTimeout(hideTimeout);
                
                updateInputVisibility();
                toggleButton.innerHTML = isVisible ? 'üëÅÔ∏è' : 'üëÅÔ∏è‚Äçüó®Ô∏è';
            };
    
            // Touch √©s click esem√©nyek
            toggleButton.addEventListener('touchstart', toggleVisibility, { passive: false });
            toggleButton.addEventListener('touchend', (e) => {
                e.preventDefault();
                e.stopPropagation();
            }, { passive: false });
            toggleButton.addEventListener('click', toggleVisibility);
    
            // Focus esem√©nyek
            salaryInput.addEventListener('focus', function() {
                clearTimeout(hideTimeout);
                if (!isVisible) {
                    this.type = 'number';
                    this.value = originalValue;
                }
            });
    
            salaryInput.addEventListener('blur', function() {
                if (!isVisible) {
                    originalValue = this.value;
                    this.type = 'text';
                    this.value = maskValue(originalValue);
                }
            });
        }
    
        return {
            getValue: () => originalValue,
            setValue: (value) => {
                originalValue = value;
                if (salaryInput) {
                    if (!isVisible) {
                        salaryInput.type = 'text';
                        salaryInput.value = maskValue(value);
                    } else {
                        salaryInput.type = 'number';
                        salaryInput.value = value;
                    }
                }
            }
        };
    }
    
    const SHIFT_COLORS = {
        Nappal: ["#FFD700", "black"],
        √âjszaka: ["#4169E1", "white"],
        Szabads√°g: ["#09fd00", "black"],
        T√∫l√≥ra: ["#FF0000", "white"],
        Cs√∫sz√≥: ["#DDA0DD", "black"],
        T√°pp√©nz: ["#000000", "white"],
    };

    const MINIMUM_WAGE = {
        2024: 266800,
        2025: 290812,
        2026: 328618,
        2027: 374624,
    };

    function normalizeKey(key) {
        return key
        .toLowerCase()
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "");
    }

    // Az ablak validateBonus f√ºggv√©ny√©nek jav√≠t√°sa
    window.validateBonus = function(entry, monthIndex) {
        try {
            let bonus = entry.value === "" ? 2 : parseInt(entry.value);
            
            // √ârt√©k korl√°toz√°sa 0 √©s 2 k√∂z√©
            if (isNaN(bonus) || bonus < 0) {
                bonus = 0;
            } else if (bonus > 2) {
                bonus = 2;
            }
            
            // Az input mez≈ë √©rt√©k√©nek friss√≠t√©se
            entry.value = bonus.toString();
            
            // Ellen≈ërizz√ºk √©s inicializ√°ljuk az √©vet √©s a bonusEntries objektumot
            const currentYear = window.app.currentPayrollYear;
            if (!window.app.yearlyData[currentYear]) {
                window.app.yearlyData[currentYear] = {
                    settings: {
                        besorolasi_ber: "300000",
                        szabadsag: "25",
                        muszakrend: "1",
                        other_income: "0",
                        under25: {
                            enabled: false,
                            birthYear: "",
                            birthMonth: ""
                        },
                        midyear_changes: []
                    },
                    calendar_data: {},
                    bonusEntries: {},
                    restaurantEntries: {}
                };
            }

            // Inicializ√°ljuk a bonusEntries objektumot, ha nem l√©tezik
            if (!window.app.yearlyData[currentYear].bonusEntries) {
                window.app.yearlyData[currentYear].bonusEntries = {};
            }
            
            // Friss√≠tj√ºk a bonusEntries √©rt√©k√©t
            window.app.yearlyData[currentYear].bonusEntries[monthIndex] = bonus;
            
            // √öjrasz√°moljuk a kapcsol√≥d√≥ √©rt√©keket
            window.app.generatePayrollTable();
            window.app.saveYearlyData();
            
            return true;
        } catch (error) {
            console.error("B√≥nusz valid√°l√°si hiba:", error);
            return false;
        }
    };

    // Az ablak validateRestaurant f√ºggv√©ny√©nek jav√≠t√°sa
    window.validateRestaurant = function(entry, monthIndex) {
        try {
            const restaurant = entry.value === "" ? 0 : parseInt(entry.value);
            if (isNaN(restaurant) || restaurant < 0) {
                entry.value = "0";
                throw new Error("Az √©ttermi fogyaszt√°s nem lehet negat√≠v");
            }

            // Ellen≈ërizz√ºk √©s inicializ√°ljuk az √©vet √©s a restaurantEntries objektumot
            const currentYear = window.app.currentPayrollYear;
            if (!window.app.yearlyData[currentYear]) {
                window.app.yearlyData[currentYear] = {
                    settings: {
                        besorolasi_ber: "300000",
                        szabadsag: "25",
                        muszakrend: "1",
                        other_income: "0",
                        under25: {
                            enabled: false,
                            birthYear: "",
                            birthMonth: ""
                        },
                        midyear_changes: []
                    },
                    calendar_data: {},
                    bonusEntries: {},
                    restaurantEntries: {}
                };
            }

            // Inicializ√°ljuk a restaurantEntries objektumot, ha nem l√©tezik
            if (!window.app.yearlyData[currentYear].restaurantEntries) {
                window.app.yearlyData[currentYear].restaurantEntries = {};
            }

            // Friss√≠tj√ºk a restaurantEntries √©rt√©k√©t
            window.app.yearlyData[currentYear].restaurantEntries[monthIndex] = restaurant;

            // √öjrasz√°moljuk a kapcsol√≥d√≥ √©rt√©keket
            window.app.generatePayrollTable();
            window.app.saveYearlyData();

            return true;
        } catch (error) {
            console.error("√âttermi fogyaszt√°s valid√°l√°si hiba:", error);
            return false;
        }
    };

    class BerszamfejtoCalculator {
        constructor(app) {
            if (!app) {
                throw new Error("App must be provided to BerszamfejtoCalculator");
            }
            this.app = app;
            this.tavolletCache = new Map();
            this.MINIMUM_WAGE = {
                2024: 266800,
                2025: 290812,
                2026: 328618,
                2027: 374624,
                2028: 426160,
            };
        }

        isShiftType(shiftValue, type) {
        // Normaliz√°ljuk a stringeket
        const normalizedShift = String(shiftValue || "")
            .toLowerCase()
            .trim();
        const normalizedType = type.toLowerCase().trim();

        // Rugalmas illeszked√©s
        return normalizedShift.includes(normalizedType);
        }

        calculateEaster(year) {
            const a = year % 19;
            const b = Math.floor(year / 100);
            const c = year % 100;
            const d = Math.floor(b / 4);
            const e = b % 4;
            const f = Math.floor((b + 8) / 25);
            const g = Math.floor((b - f + 1) / 3);
            const h = (19 * a + b - d - g + 15) % 30;
            const i = Math.floor(c / 4);
            const k = c % 4;
            const l = (32 + 2 * e + 2 * i - h - k) % 7;
            const m = Math.floor((a + 11 * h + 22 * l) / 451);
            const month = Math.floor((h + l - 7 * m + 114) / 31) - 1;
            const day = ((h + l - 7 * m + 114) % 31) + 1;
            
            return new Date(year, month, day);
        }
    
        getHolidays(year) {
            try {
                // Fix √ºnnepnapok
                const fixedHolidays = [
                    { month: 0, day: 1 },    // √öj√©v
                    { month: 2, day: 15 },   // M√°rcius 15.
                    { month: 4, day: 1 },    // Munka √ºnnepe
                    { month: 7, day: 20 },   // √Ållamalap√≠t√°s √ºnnepe
                    { month: 9, day: 23 },   // Okt√≥ber 23.
                    { month: 10, day: 1 },   // Mindenszentek
                    { month: 11, day: 25 },  // Kar√°csony
                    { month: 11, day: 26 }   // Kar√°csony m√°snapja
                ];
    
                // H√∫sv√©t √©s kapcsol√≥d√≥ √ºnnepek kisz√°m√≠t√°sa
                const easter = this.calculateEaster(year);
                
                // Nagyp√©ntek (H√∫sv√©t vas√°rnap el≈ëtti p√©ntek)
                const goodFriday = new Date(easter);
                goodFriday.setDate(easter.getDate() - 2);
                
                // H√∫sv√©tvas√°rnap
                const easterSunday = new Date(easter);
                
                // H√∫sv√©th√©tf≈ë
                const easterMonday = new Date(easter);
                easterMonday.setDate(easter.getDate() + 1);
                
                // P√ºnk√∂sdh√©tf≈ë (H√∫sv√©t ut√°n 50 nappal)
                const pentecostMonday = new Date(easter);
                pentecostMonday.setDate(easter.getDate() + 50);
    
                // Mozg√≥ √ºnnepek hozz√°ad√°sa
                const movingHolidays = [
                    { month: goodFriday.getMonth(), day: goodFriday.getDate() },           // Nagyp√©ntek
                    { month: easterSunday.getMonth(), day: easterSunday.getDate() },       // H√∫sv√©tvas√°rnap
                    { month: easterMonday.getMonth(), day: easterMonday.getDate() },       // H√∫sv√©th√©tf≈ë
                    { month: pentecostMonday.getMonth(), day: pentecostMonday.getDate() }  // P√ºnk√∂sdh√©tf≈ë
                ];
    
                // √ñsszes √ºnnep √∂sszef≈±z√©se
                const allHolidays = [...fixedHolidays, ...movingHolidays];
    
                return allHolidays;
            } catch (error) {
                console.error("Hiba az √ºnnepnapok meghat√°roz√°sa sor√°n:", error);
                return [];
            }
        }
    
        isHoliday(year, month, day) {
            try {
                const holidays = this.getHolidays(year);
                return holidays.some(
                    (holiday) => holiday.month === month && holiday.day === day
                );
            } catch (error) {
                console.error("Hiba az √ºnnepnap ellen≈ërz√©se sor√°n:", error);
                return false;
            }
        }

        calculateHolidayValue(year, month) {
        const holidays = this.getHolidays(year);
        let holidayValue = 0;
        let holidayCount = 0;

        holidays.forEach((holiday) => {
            if (holiday.month === month) {
            const calendarData = this.yearData.calendar_data[month] || {};
            const dayData = calendarData[holiday.day];

            if (
                dayData &&
                (dayData.includes("Nappal") || dayData.includes("√âjszaka"))
            ) {
                holidayValue += 12;
                holidayCount += 1;
            }
            }
        });

        return { holidayValue, holidayCount };
        }

        calculateChildTaxBenefit(childCount, date) {
            if (childCount <= 0) return 0;
            
            const currentDate = new Date(date);
            let benefitPerChild = 0;
            
            if (currentDate < new Date('2025-06-30')) {
                if (childCount === 1) benefitPerChild = 10000;
                else if (childCount === 2) benefitPerChild = 20000;
                else if (childCount >= 3) benefitPerChild = 33000;
            } 
            else if (currentDate < new Date('2026-01-01')) {
                if (childCount === 1) benefitPerChild = 15000;
                else if (childCount === 2) benefitPerChild = 30000;
                else if (childCount >= 3) benefitPerChild = 49500;
            }
            else {
                if (childCount === 1) benefitPerChild = 20000;
                else if (childCount === 2) benefitPerChild = 40000;
                else if (childCount >= 3) benefitPerChild = 66000;
            }
            
            return childCount * benefitPerChild;
        }

        getYearData(year) {
        if (year < 2024 || year > 2028) {
            throw new Error(`√ârv√©nytelen √©v: ${year}`);
        }
        return this.app.yearlyData[year];
        }

        getMonthData(year, month) {
        const yearData = this.getYearData(year);
        return yearData.calendar_data[month] || {};
        }

        getEffectiveSalary(year, month) {
            try {
                // √ârv√©nyes√≠tj√ºk az √©vet
                if (year < 2024 || year > 2028) {
                    console.warn(`√ârv√©nytelen √©v: ${year}, az alap√©rtelmezett 2024 lesz haszn√°lva`);
                    year = 2024;
                }
        
                const yearData = this.app.yearlyData[year];
                if (!yearData) {
                    console.warn(`Nem tal√°lhat√≥ adat a ${year} √©vre`);
                    return 300000; // Alap√©rtelmezett √©rt√©k
                }
        
                // Az alapb√©r lek√©r√©se
                const baseSalary = parseInt(yearData.settings?.besorolasi_ber) || 300000;
                
                // √âvk√∂zi v√°ltoz√°sok ellen≈ërz√©se
                if (yearData.settings?.midyear_changes?.length > 0) {
                    // Rendezz√ºk a v√°ltoz√°sokat d√°tum szerint cs√∂kken≈ë sorrendbe
                    const sortedChanges = [...yearData.settings.midyear_changes]
                        .sort((a, b) => b.month - a.month);
        
                    // Keress√ºk meg az els≈ë v√°ltoz√°st, ami a jelenlegi h√≥nap el≈ëtt vagy abban t√∂rt√©nt
                    const applicableChange = sortedChanges.find(change => 
                        change.month <= month
                    );
        
                    if (applicableChange) {
                        console.log(`√âvk√∂zi v√°ltoz√°s alkalmazva: ${applicableChange.salary} Ft (${year}.${month + 1})`);
                        return parseInt(applicableChange.salary);
                    }
                }

                return baseSalary;
                
            } catch (error) {
                console.error("Hiba az √©rv√©nyes b√©r meghat√°roz√°sa sor√°n:", error);
                return 300000; // Alap√©rtelmezett √©rt√©k hiba eset√©n
            }
        }

        getTuloraOrak(monthIndex, year) {
            try {
                if (!this.app.yearlyData[year]?.calendar_data?.[monthIndex]) {
                    return { normal: 0, sunday: 0 };
                }
        
                const monthData = this.app.yearlyData[year].calendar_data[monthIndex];
                const pattern = this.app.yearlyData[year]?.settings?.muszakrend || "1";
                let normalOrak = 0;
                let vasarnapiOrak = 0;
        
                Object.entries(monthData).forEach(([day, shiftValue]) => {
                    if (shiftValue && shiftValue.includes("T√∫l√≥ra")) {
                        const date = new Date(year, monthIndex, parseInt(day));
                        const isSunday = date.getDay() === 0;
                        let hours = 0;
        
                        // √ìr√°k meghat√°roz√°sa
                        if (shiftValue.includes("12 √≥ra")) hours = 12;
                        else if (shiftValue.includes("8 √≥ra")) hours = 8;
                        else if (shiftValue.includes("4 √≥ra")) hours = 4;
        
                        // A-B-C m≈±szakrend speci√°lis kezel√©se
                        if (["A", "B", "C"].includes(pattern) && isSunday) {
                            vasarnapiOrak += hours;
                        } else {
                            normalOrak += hours;
                        }
                    }
                });
        
                return { normal: normalOrak, sunday: vasarnapiOrak };
            } catch (error) {
                console.error("Hiba a t√∫l√≥ra √≥r√°k sz√°m√≠t√°s√°ban:", error);
                return { normal: 0, sunday: 0 };
            }
        }

        calculateQuarterlyOvertime(year, monthIndex) {
    try {
        const startMonth = Math.floor(monthIndex / 3) * 3;
        const months = [startMonth, startMonth + 1, startMonth + 2];
        
        let totalWorkingDays = 0;
        let totalHavi8 = 0;
        let totalLedolgozottOrak = 0;
        let totalCsuszoHours = 0;

        months.forEach(month => {
            const monthData = this.app.yearlyData[year]?.calendar_data[month] || {};
            
            let monthWorkingDays = 0;
            Object.entries(monthData).forEach(([day, shiftValue]) => {
                if (!shiftValue) return;

                // Ledolgozott napok sz√°mol√°sa
                if (shiftValue?.includes("Nappal") || 
                    shiftValue?.includes("√âjszaka") ||
                    shiftValue?.includes("Szabads√°g") ||
                    shiftValue?.includes("Cs√∫sz√≥") ||
                    shiftValue?.includes("T√°pp√©nz")) {
                    monthWorkingDays++;
                }

                // Ledolgozott √≥r√°k sz√°mol√°sa (cs√∫sz√≥k n√©lk√ºl)
                if (shiftValue?.includes("Nappal") || shiftValue?.includes("√âjszaka")) {
                    if (shiftValue.includes("12 √≥ra")) {
                        totalLedolgozottOrak += 12;
                    } else if (shiftValue.includes("8 √≥ra")) {
                        totalLedolgozottOrak += 8;
                    } else if (shiftValue.includes("4 √≥ra")) {
                        totalLedolgozottOrak += 4;
                    }
                }
                
                // Cs√∫sz√≥ √≥r√°k sz√°mol√°sa
                if (shiftValue?.includes("Cs√∫sz√≥")) {
                    if (shiftValue.includes("12 √≥ra")) {
                        totalCsuszoHours += 12;
                    } else if (shiftValue.includes("8 √≥ra")) {
                        totalCsuszoHours += 8;
                    } else if (shiftValue.includes("4 √≥ra")) {
                        totalCsuszoHours += 4;
                    }
                }
            });
            
            totalWorkingDays += monthWorkingDays;
            const havi8 = this.calculateWorkingDays(year, month) * 8;
            totalHavi8 += havi8;
        });

        // T√∫l√≥ra keret sz√°m√≠t√°sa:
        // 1. El≈ësz√∂r kisz√°moljuk az √∂sszes ledolgozand√≥ √≥r√°t (12 √≥r√°s m≈±szakok)
        const totalRequiredHours = totalWorkingDays * 12;
        
        // 2. Kivonjuk bel≈ële a havi 8 √≥r√°s munkaid≈ët
        // 3. Kivonjuk a cs√∫sz√≥ √≥r√°kat
        const tuloraKeret = totalRequiredHours - totalHavi8 - totalCsuszoHours;
        
        console.log(`T√∫l√≥ra keret sz√°m√≠t√°s (${monthIndex + 1}. h√≥nap):
            - 3 havi ledolgozand√≥ napok: ${totalWorkingDays} (${totalRequiredHours} √≥ra)
            - 3 havi havi8: ${totalHavi8} √≥ra
            - Levont cs√∫sz√≥ √≥r√°k: ${totalCsuszoHours} √≥ra
            - T√∫l√≥ra keret: ${Math.max(0, tuloraKeret)} √≥ra`);

        return Math.max(0, tuloraKeret);
    } catch (error) {
        console.error("Hiba a negyed√©ves t√∫l√≥ra sz√°m√≠t√°s√°ban:", error);
        return 0;
    }
        }

        calculateWorkingDays(year, month) {
            try {
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const holidays = this.getHolidays(year);
                let workingDays = 0;
        
                for (let day = 1; day <= daysInMonth; day++) {
                    const date = new Date(year, month, day);
                    const dayOfWeek = date.getDay();
                    
                    // Csak h√©tk√∂znapi napok (h√©tf≈ë-p√©ntek) vizsg√°lata
                    const isWeekday = dayOfWeek >= 1 && dayOfWeek <= 5;
                    
                    // √únnepnap ellen≈ërz√©s
                    const isHoliday = holidays.some(
                        (h) => h.month === month && h.day === day
                    );
                    
                    // H√©tv√©gi √ºnnepnapok kiz√°r√°sa
                    const isWeekendHoliday = isHoliday && (dayOfWeek === 0 || dayOfWeek === 6);
                    
                    // Csak h√©tk√∂znapi nem h√©tv√©gi √ºnnepnapok sz√°m√≠t√°sa
                    if (isWeekday && isHoliday && !isWeekendHoliday) {
                        // H√©tk√∂znapi √ºnnepnap
                        workingDays += 0; // Nem sz√°moljuk munkanapnak
                    } else if (isWeekday && !isHoliday) {
                        // Norm√°l munkanap
                        workingDays += 1;
                    }
                }
        
                return workingDays;
            } catch (error) {
                console.error("Hiba a munkanapok sz√°m√≠t√°s√°n√°l:", error);
                return 0;
            }
        }

        calculateShiftValues(monthData, date) {
        try {
            const isWeekend = date.getDay() === 0;
            const isHoliday = this.isHoliday(
            date.getFullYear(),
            date.getMonth(),
            date.getDate()
            );

            return {
            isWeekend,
            isHoliday,
            shiftHours: this.getShiftHours(monthData),
            nightShiftHours: this.getNightShiftHours(monthData),
            weekendHours: isWeekend ? this.getWeekendHours(monthData) : 0,
            holidayHours: isHoliday ? this.getHolidayHours(monthData) : 0,
            };
        } catch (error) {
            console.error("Hiba a m≈±szak √©rt√©kek sz√°m√≠t√°s√°n√°l:", error);
            return {
            isWeekend: false,
            isHoliday: false,
            shiftHours: 0,
            nightShiftHours: 0,
            weekendHours: 0,
            holidayHours: 0,
            };
        }
        }

        calculateMonthlyValue(label, monthIndex, year) {
            try {
                // √ârv√©nyes√≠tj√ºk az √©vet
                if (!year || year < 2024 || year > 2028) {
                    console.warn(`√ârv√©nytelen √©v: ${year}, alap√©rtelmezett 2024 haszn√°lata`);
                    year = 2024;
                }
        
                const yearData = this.app.yearlyData[year];
                const monthData = yearData.calendar_data[monthIndex] || {};
                
                // Az √©rv√©nyes besorol√°si b√©r lek√©r√©se az adott h√≥napra
                const effectiveSalary = this.getEffectiveSalary(year, monthIndex);
                
                // Munkanapok sz√°m√≠t√°sa
                const workingDays = this.calculateWorkingDays(year, monthIndex);
                const havi8 = workingDays * 8;
        
                // Alapv√°ltoz√≥k inicializ√°l√°sa
                let ledolgozando = 0;
                let ledolgozott = 0;
                let szabadsagOra = 0;
                let tappenzNapok = 0;
                let tulora100 = 0;
                let hetvegiPotlek50 = 0;
                let muszakPotlek40 = 0;
                let holidayCount = 0;
                let holidayValue = 0;
        
                // Napi √©rt√©kek sz√°m√≠t√°sa
                Object.entries(monthData).forEach(([day, shiftValue]) => {
                    if (!shiftValue) return;
        
                    const date = new Date(year, monthIndex, parseInt(day));
                    const isWeekend = date.getDay() === 0 || date.getDay() === 6;
                    const isHoliday = this.isHoliday(year, monthIndex, parseInt(day));
        
                    // Ledolgozand√≥ napok sz√°m√≠t√°sa
                    if (shiftValue.includes("Nappal") || 
                        shiftValue.includes("√âjszaka") ||
                        shiftValue.includes("Szabads√°g") ||
                        shiftValue.includes("Cs√∫sz√≥") ||
                        shiftValue.includes("T√°pp√©nz")) {
                        ledolgozando += 1;
                    }
        
                    // Ledolgozott napok sz√°m√≠t√°sa
                    if (shiftValue.includes("Nappal") || shiftValue.includes("√âjszaka") || shiftValue.includes("Cs√∫sz√≥")) {
                        ledolgozott += 1;
                    } else if (shiftValue.includes("Szabads√°g")) {
                        if (shiftValue.includes("12 √≥ra")) {
                            ledolgozott += 0;
                        } else if (shiftValue.includes("8 √≥ra")) {
                            ledolgozott += 1/3;
                        } else if (shiftValue.includes("4 √≥ra")) {
                            ledolgozott += 2/3;
                        }
                    }
        
                    // Szabads√°g √≥r√°k sz√°m√≠t√°sa
                    if (shiftValue.includes("Szabads√°g 12 √≥ra") ||
                        shiftValue.includes("Szabads√°g √©j 12 √≥ra")) {
                        szabadsagOra += 12;
                    } else if (shiftValue.includes("Szabads√°g 8 √≥ra") ||
                              shiftValue.includes("Szabads√°g √©j 8 √≥ra")) {
                        szabadsagOra += 8;
                    } else if (shiftValue.includes("Szabads√°g 4 √≥ra") ||
                              shiftValue.includes("Szabads√°g √©j 4 √≥ra")) {
                        szabadsagOra += 4;
                    }
        
                    // T√∫l√≥ra sz√°m√≠t√°sa
                    if (shiftValue.includes("T√∫l√≥ra 12 √≥ra") ||
                        shiftValue.includes("T√∫l√≥ra √©j 12 √≥ra")) {
                        tulora100 += 12;
                    } else if (shiftValue.includes("T√∫l√≥ra 8 √≥ra") ||
                              shiftValue.includes("T√∫l√≥ra √©j 8 √≥ra")) {
                        tulora100 += 8;
                    }
        
                    // H√©tv√©gi p√≥tl√©k sz√°m√≠t√°sa
                    if (isWeekend) {
                        if (shiftValue.includes("Nappal") ||
                            shiftValue.includes("√âjszaka")) {
                            hetvegiPotlek50 += 12;
                        } else if (shiftValue.includes("Szabads√°g 8 √≥ra") ||
                                shiftValue.includes("Szabads√°g √©j 8 √≥ra") ||
                                   shiftValue.includes("Cs√∫sz√≥ √©j 8 √≥ra") ||
                                  shiftValue.includes("Cs√∫sz√≥ 8 √≥ra")) {
                            hetvegiPotlek50 += 4;
                        } else if (shiftValue.includes("Szabads√°g 4 √≥ra") ||
                                   shiftValue.includes("Szabads√°g √©j 4 √≥ra") ||
                                   shiftValue.includes("Cs√∫sz√≥ √©j 4 √≥ra") ||
                                  shiftValue.includes("Cs√∫sz√≥ 4 √≥ra")) {
                            hetvegiPotlek50 += 8;
                        }
                    }
        
                    // M≈±szakp√≥tl√©k sz√°m√≠t√°sa
                    if (shiftValue.includes("√âjszaka") ||
                        shiftValue.includes("T√∫l√≥ra √©j 12 √≥ra")) {
                        muszakPotlek40 += 12;
                    } else if (shiftValue.includes("T√∫l√≥ra √©j 8 √≥ra")) {
                        muszakPotlek40 += 8;
                    } else if (shiftValue.includes("Szabads√°g √©j 4 √≥ra") ||
                              shiftValue.includes("Cs√∫sz√≥ √©j 4 √≥ra")) {
                        muszakPotlek40 += 8;
                    } else if (shiftValue.includes("Szabads√°g √©j 8 √≥ra") ||
                              shiftValue.includes("Cs√∫sz√≥ √©j 8 √≥ra")) {
                        muszakPotlek40 += 4;
                    }
        
                    // √únnepnap sz√°m√≠t√°sa
                    if (isHoliday) {
                        if (shiftValue.includes("Nappal") ||
                            shiftValue.includes("√âjszaka")) {
                            holidayCount += 1;
                            holidayValue += 12;
                        } else if (shiftValue.includes("Szabads√°g 12 √≥ra") ||
                                  shiftValue.includes("Szabads√°g 8 √≥ra")) {
                            holidayCount += 1/3;
                            holidayValue += shiftValue.includes("12 √≥ra") ? 12 : 8;
                        } else if (shiftValue.includes("Szabads√°g 4 √≥ra")) {
                            holidayCount += 2/3;
                            holidayValue += 4;
                        }
                    }
        
                    // T√°pp√©nz sz√°m√≠t√°sa
                    if (shiftValue.includes("T√°pp√©nz")) {
                        tappenzNapok += 1;
                    }
                });
        
                // √ârt√©kek visszaad√°sa a label alapj√°n
                switch (label) {
                    case "Ledolgozand√≥ napok":
                        return ledolgozando;
                    case "Ledolgozott napok":
                        return ledolgozott;
                    case "Szabads√°g kiv√©t (√≥ra)":
                        return szabadsagOra;
                    case "T√∫l√≥ra": {
                        if ((monthIndex + 1) % 3 === 0) {
                            const tuloraKeret = this.calculateQuarterlyOvertime(year, monthIndex);
                            return tulora100 + tuloraKeret;
                        }
                        return tulora100;
                    }
                    case "H√©tv√©gi p√≥tl√©k 50%": {
                        const monthData = this.app.yearlyData[year]?.calendar_data[monthIndex] || {};
                        let totalWeekendHours = 0;
                        const pattern = this.app.yearlyData[year]?.settings?.muszakrend;
                    
                        Object.entries(monthData).forEach(([day, shiftValue]) => {
                            if (!shiftValue) return;
                            const date = new Date(year, monthIndex, parseInt(day));
                            const isSunday = date.getDay() === 0;  // Csak vas√°rnapra ellen≈ërz√ºnk
                    
                            if (isSunday) {  // Csak vas√°rnapi napokra sz√°molunk
                                if (shiftValue.includes("Nappal") || shiftValue.includes("√âjszaka")) {
                                    totalWeekendHours += 12;
                                } else if (shiftValue.includes("Szabads√°g 8 √≥ra") || 
                                          shiftValue.includes("Cs√∫sz√≥ 8 √≥ra") ||
                                          shiftValue.includes("Szabads√°g √©j 8 √≥ra") || 
                                          shiftValue.includes("Cs√∫sz√≥ √©j 8 √≥ra")) {
                                    totalWeekendHours += 4;
                                } else if (shiftValue.includes("Szabads√°g 4 √≥ra") || 
                                          shiftValue.includes("Cs√∫sz√≥ 4 √≥ra") ||
                                          shiftValue.includes("Szabads√°g √©j 4 √≥ra") || 
                                          shiftValue.includes("Cs√∫sz√≥ √©j 4 √≥ra")) {
                                    totalWeekendHours += 8;
                                }
                    
                                // A-B-C m≈±szakrendek eset√©n a vas√°rnapi t√∫l√≥r√°k hozz√°ad√°sa
                                if (["A", "B", "C"].includes(pattern) && shiftValue.includes("T√∫l√≥ra")) {
                                    if (shiftValue.includes("12 √≥ra")) {
                                        totalWeekendHours += 12;
                                    } else if (shiftValue.includes("8 √≥ra")) {
                                        totalWeekendHours += 8;
                                    } else if (shiftValue.includes("4 √≥ra")) {
                                        totalWeekendHours += 4;
                                    }
                                }
                            }
                        });
                    
                        return totalWeekendHours;
                    }

                    case "M≈±szakp√≥tl√©k 40%":
                        return muszakPotlek40;
                    case "Alapb√©r":
                        return ledolgozando > 0 ? (effectiveSalary / ledolgozando) * ledolgozott : 0;
                    case "T√∫l√≥ra alap": {
                        const workingDays = this.calculateWorkingDays(year, monthIndex);
                        const havi8 = workingDays * 8;
                        const effectiveSalary = this.getEffectiveSalary(year, monthIndex);
                        const tuloraOrak = this.getTuloraOrak(monthIndex, year);
                        // Negyed√©ves t√∫l√≥ra keret sz√°m√≠t√°sa
    let tuloraKeret = 0;
    if ((monthIndex + 1) % 3 === 0) {
        tuloraKeret = this.calculateQuarterlyOvertime(year, monthIndex);
    }
                    
                        // A teljes t√∫l√≥ra √≥rasz√°m figyelembe v√©tele
                        const osszTuloraOrak = tuloraOrak.normal + tuloraOrak.sunday + tuloraKeret;
                    
                        // T√∫l√≥ra alapj√°nak sz√°m√≠t√°sa a havi 8 √≥ra alapj√°n
                        const tuloraAlap = osszTuloraOrak > 0 
                            ? (effectiveSalary / havi8) * osszTuloraOrak 
                            : 0;
                    
                        return Math.round(tuloraAlap);
                    }
                    case "Szabads√°gra jut√≥ fizet√©s":
                        return ledolgozando > 0 ? (effectiveSalary / (ledolgozando * 12)) * szabadsagOra : 0;
                    case "T√°voll√©ti d√≠j":
                        return this.calculateTavolletDij(monthIndex, year);
                    case "Fizetett √ºnnepnap":
                        return ledolgozando > 0 ? (effectiveSalary / ledolgozando) * holidayCount : 0;
                    case "T√∫l√≥rap√≥tl√©k": {
                        const effectiveSalary = this.getEffectiveSalary(year, monthIndex);
                        const workingDays = this.calculateWorkingDays(year, monthIndex);
                        const havi8 = workingDays * 8;
                        const tuloraOrak = this.getTuloraOrak(monthIndex, year);
                        const pattern = this.app.yearlyData[year]?.settings?.muszakrend || "1";

                        
    // Negyed√©ves t√∫l√≥ra keret sz√°m√≠t√°sa
    let tuloraKeret = 0;
    if ((monthIndex + 1) % 3 === 0) {
        tuloraKeret = this.calculateQuarterlyOvertime(year, monthIndex);
    }
                    
                        // Norm√°l t√∫l√≥rap√≥tl√©k (100%)
                        const normalTulorapotlek = (effectiveSalary / 174) * (tuloraOrak.normal + tuloraKeret);
                    
                        // Vas√°rnapi t√∫l√≥rap√≥tl√©k speci√°lis kezel√©se A, B, C m≈±szakrendn√©l
                        let vasarnapiTulorapotlek = 0;
                        if (["A", "B", "C"].includes(pattern)) {
                            // Vas√°rnapi t√∫l√≥ra 200%-os p√≥tl√©ka
                            vasarnapiTulorapotlek = (effectiveSalary / 174) * tuloraOrak.sunday * 2;
                        } else {
                            // Egy√©b m≈±szakrendek norm√°l 100%-os p√≥tl√©ka
                            vasarnapiTulorapotlek = (effectiveSalary / 174) * tuloraOrak.sunday;
                        }
                    
                        return Math.round(normalTulorapotlek + vasarnapiTulorapotlek);
                    }
                    case "H√©tv√©gi p√≥tl√©k (50%)": {
                        const weekendHours = this.calculateMonthlyValue("H√©tv√©gi p√≥tl√©k 50%", monthIndex, year);
                        const effectiveSalary = this.getEffectiveSalary(year, monthIndex);
                        return Math.round((effectiveSalary / 174) * weekendHours * 0.5);
                    }
                    case "M≈±szakp√≥tl√©k (40%)":
                        return (effectiveSalary / 174) * muszakPotlek40 * 0.4;
                        case "Teljes√≠tm√©ny pr√©mium": {
                            const yearData = this.app.yearlyData[year];
                            const bonusValue = yearData.bonusEntries?.[monthIndex] || 0;
                            return effectiveSalary * 0.05 * bonusValue;
                        }
                    case "TB J√°rul√©k 18,5%": {
                        const bruttoBer = this.calculateMonthlyValue("Brutt√≥ b√©r", monthIndex, year);
                        return Math.round(bruttoBer * 0.185);
                    }
        
                    case "Rendszeres SZJA el≈ëleg": {
                        const bruttoBer = this.calculateMonthlyValue("Brutt√≥ b√©r", monthIndex, year);
                        return Math.round(bruttoBer * 0.15);
                    }

                    case "Csal√°di ad√≥kedvezm√©ny": {
                        const yearData = this.app.yearlyData[year];
                        const childCount = parseInt(yearData.settings.children_count || 0);
                        const date = new Date(year, monthIndex);
                        return this.calculateChildTaxBenefit(childCount, date);
                    }
        
                    case "Nett√≥": {
                        const yearData = this.app.yearlyData[year];
                        const bruttoBer = this.calculateMonthlyValue("Brutt√≥ b√©r", monthIndex, year);
                        const otherIncome = parseFloat(yearData.settings.other_income || 0);
                        const restaurantEntry = yearData.restaurantEntries?.[monthIndex] || 0;
                        const under25Discount = this.app.calculateUnder25Discount(year, monthIndex, bruttoBer);
                        const childBenefit = this.calculateMonthlyValue("Csal√°di ad√≥kedvezm√©ny", monthIndex, year);
                        
                        const tbJarulek = this.calculateMonthlyValue("TB J√°rul√©k 18,5%", monthIndex, year);
                        const szja = this.calculateMonthlyValue("Rendszeres SZJA el≈ëleg", monthIndex, year);
                        
                        return Math.round(bruttoBer + under25Discount + otherIncome + childBenefit - tbJarulek - szja - restaurantEntry);
                    }                    
        
                    case "Megmaradt szabads√°gok": {
                        const yearData = this.app.yearlyData[year];
                        const totalVacationDays = parseInt(yearData.settings.szabadsag || 25);
                        
                        // Az √©v elej√©t≈ël a jelenlegi h√≥napig √∂sszes√≠tj√ºk a szabads√°gokat
                        let totalUsedVacationHours = 0;
                        for (let i = 0; i <= monthIndex; i++) {
                            totalUsedVacationHours += this.calculateMonthlyValue("Szabads√°g kiv√©t (√≥ra)", i, year);
                        }
                        
                        // √ìr√°k √°tv√°lt√°sa napokra (8 √≥r√°s munkanappal sz√°molva)
                        const totalUsedVacationDays = totalUsedVacationHours / 8;
                        
                        // Megmaradt szabads√°gnapok
                        const remainingVacationDays = Math.max(0, totalVacationDays - totalUsedVacationDays);
                        
                        return Math.round(remainingVacationDays * 10) / 10; // Kerek√≠t√©s 1 tizedesjegyre
                    }

                    case "Brutt√≥ b√©r": {
                        try {
                            // Minden komponens √∂sszegz√©se
                            const components = [
                                "Alapb√©r",
                                "T√∫l√≥ra alap",
                                "Szabads√°gra jut√≥ fizet√©s",
                                "T√°voll√©ti d√≠j",
                                "Fizetett √ºnnepnap",
                                "T√∫l√≥rap√≥tl√©k",
                                "H√©tv√©gi p√≥tl√©k (50%)",
                                "M≈±szakp√≥tl√©k (40%)",
                                "Teljes√≠tm√©ny pr√©mium"
                            ];
        
                            const total = components.reduce((sum, component) => {
                                const value = this.calculateMonthlyValue(component, monthIndex, year);
                                return sum + value;
                            }, 0);
        
                            return Math.round(total);
                        } catch (error) {
                            console.error("Hiba a brutt√≥ b√©r sz√°m√≠t√°sa sor√°n:", error);
                            return 0; 
                        }
                    }
                    default:
                        console.warn(`Ismeretlen t√©tel: ${label}`);
                        return 0;
                }
            } catch (error) {
                console.error("Hiba a havi √©rt√©k sz√°m√≠t√°sa sor√°n:", error, {
                    label, monthIndex, year
                });
                return 0;
            }
        }

        getMonthData(monthIndex, year) {
        console.log("Current month:", this.currentMonth);
        console.log("Current year:", this.currentYear);
        const yearData = this.app.yearData;
        const monthData = {
            workedDays: 0,
            totalWorkingDays: this.calculateWorkingDays(year, monthIndex),
            vacationHours: 0,
            overtimeHours: 0,
            nightShiftHours: 0,
            weekendHours: 0,
            sickDays: 0,
        };

        const calendarData =
            this.app.yearData.calendar_data[monthIndex] || {};

        // Ha √ºres a calendar_data, t√©rj√ºnk vissza az alap√©rtelmezett adatokkal
        if (Object.keys(calendarData).length === 0) {
            return monthData;
        }

        Object.entries(calendarData).forEach(([day, shiftValue]) => {
            const date = new Date(year, monthIndex, parseInt(day));
            const isWeekend = date.getDay() === 0 || date.getDay() === 6;

            switch (shiftValue) {
            case "Nappal":
                monthData.workedDays += 1;
                if (isWeekend) monthData.weekendHours += 12;
                break;

            case "√âjszaka":
                monthData.workedDays += 1;
                monthData.nightShiftHours += 12;
                if (isWeekend) monthData.weekendHours += 12;
                break;

            case "Szabads√°g 12 √≥ra":
                monthData.vacationHours += 12;
                break;

            case "Szabads√°g √©j 12 √≥ra":
                monthData.vacationHours += 12;
                monthData.nightShiftHours += 12;
                break;

            case "Szabads√°g 8 √≥ra":
                monthData.vacationHours += 8;
                break;

            case "Szabads√°g √©j 8 √≥ra":
                monthData.vacationHours += 8;
                monthData.nightShiftHours += 8;
                break;

            case "Szabads√°g 4 √≥ra":
                monthData.vacationHours += 4;
                break;

            case "Szabads√°g √©j 4 √≥ra":
                monthData.vacationHours += 4;
                monthData.nightShiftHours += 4;
                break;

            case "T√∫l√≥ra 12 √≥ra":
                monthData.workedDays += 1;
                monthData.overtimeHours += 12;
                if (isWeekend) monthData.weekendHours += 12;
                break;

            case "T√∫l√≥ra √©j 12 √≥ra":
                monthData.workedDays += 1;
                monthData.overtimeHours += 12;
                monthData.nightShiftHours += 12;
                if (isWeekend) monthData.weekendHours += 12;
                break;

            case "T√∫l√≥ra 8 √≥ra":
                monthData.overtimeHours += 8;
                if (isWeekend) monthData.weekendHours += 8;
                break;

            case "T√∫l√≥ra √©j 8 √≥ra":
                monthData.overtimeHours += 8;
                monthData.nightShiftHours += 8;
                if (isWeekend) monthData.weekendHours += 8;
                break;

            case "T√°pp√©nz":
                monthData.sickDays += 1;
                break;
            }
        });
        return monthData;
        }

        calculateTavolletDij(monthIndex, year) {
            try {
                const yearData = this.app.yearlyData[year];
                const settings = yearData?.settings || {};
                const monthData = yearData?.calendar_data[monthIndex] || {};
                const besorolas = parseInt(settings.besorolasi_ber) || 300000;
        
                // T√°pp√©nz v√°ltoz√≥k (ezek maradnak a r√©giek)
                let tappenzTavollet = 0;
                let tappenzKiegeszites = 0;
                let tappenzCount = 0;
                let betegszabadsagCount = settings.felhasznalt_betegszabadsag || 0;
                let szabadsagPotlekDij = 0;
        
                // El≈ëz≈ë 6 h√≥nap p√≥tl√©kainak √©s munka√≥r√°inak √∂sszegz√©se
                let osszesEjszakaiPotlek = 0;
                let osszesVasarnapiPotlek = 0;
                let osszesLedolgozottOra = 0;
        
                // El≈ëz≈ë 6 h√≥nap vizsg√°lata
                for (let i = 1; i <= 6; i++) {
                    let vizsgaltHonap = monthIndex - i;
                    let vizsgaltEv = year;
                    
                    if (vizsgaltHonap < 0) {
                        vizsgaltHonap += 12;
                        vizsgaltEv--;
                    }
                    
                    const honapiAdat = yearData.calendar_data[vizsgaltHonap] || {};
                    
                    Object.entries(honapiAdat).forEach(([nap, shiftValue]) => {
                        if (!shiftValue) return;
        
                        let orak = 12;
                        if (shiftValue.includes("8 √≥ra")) orak = 8;
                        if (shiftValue.includes("4 √≥ra")) orak = 4;
        
                        // Csak a t√©nylegesen ledolgozott √≥r√°k sz√°m√≠tanak
                        if (shiftValue.includes("Nappal") || shiftValue.includes("√âjszaka")) {
                            osszesLedolgozottOra += orak;
                            
                            // √âjszakai p√≥tl√©k sz√°m√≠t√°sa
                            if (shiftValue.includes("√âjszaka")) {
                                osszesEjszakaiPotlek += (besorolas / 174) * orak * 0.4;
                            }
        
                            // Vas√°rnapi p√≥tl√©k sz√°m√≠t√°sa
                            const date = new Date(vizsgaltEv, vizsgaltHonap, parseInt(nap));
                            if (date.getDay() === 0) {
                                osszesVasarnapiPotlek += (besorolas / 174) * orak * 0.5;
                            }
                        }
                    });
                }
        
                // √ìr√°nk√©nti √°tlagos p√≥tl√©kok sz√°m√≠t√°sa
                const atlagEjszakaiPotlek = osszesLedolgozottOra > 0 ? osszesEjszakaiPotlek / osszesLedolgozottOra : 0;
                const atlagVasarnapiPotlek = osszesLedolgozottOra > 0 ? osszesVasarnapiPotlek / osszesLedolgozottOra : 0;
        
                // Aktu√°lis h√≥nap szabads√°gainak √©s t√°pp√©nzeinek feldolgoz√°sa
                Object.entries(monthData).forEach(([day, shiftValue]) => {
                    if (!shiftValue) return;
        
                    if (shiftValue.includes("T√°pp√©nz")) {
                        const napiBer = Math.min(besorolas / 30, Math.round((this.MINIMUM_WAGE[year] || this.MINIMUM_WAGE[2024] * 2) / 30));
                        
                        if (betegszabadsagCount < 15) {
                            tappenzTavollet += napiBer * 0.7;
                            tappenzKiegeszites += napiBer * 0.5;
                            betegszabadsagCount++;
                            tappenzCount++;
                        } else {
                            if (tappenzCount < 15) {
                                tappenzTavollet += napiBer * 0.6;
                                tappenzKiegeszites += napiBer * 0.5;
                                tappenzCount++;
                            } else {
                                tappenzTavollet += napiBer * 0.5;
                                tappenzKiegeszites += napiBer * 0.5;
                            }
                        }
                    } else if (shiftValue.includes("Szabads√°g")) {
                        let orak = 12;
                        if (shiftValue.includes("8 √≥ra")) orak = 8;
                        if (shiftValue.includes("4 √≥ra")) orak = 4;
                        szabadsagPotlekDij += (atlagEjszakaiPotlek + atlagVasarnapiPotlek) * orak;
                    }
                });
        
                if (yearData.settings) {
                    yearData.settings.felhasznalt_betegszabadsag = betegszabadsagCount;
                }
        
                return Math.round(tappenzTavollet + tappenzKiegeszites + szabadsagPotlekDij);
            } catch (error) {
                console.error("Hiba a t√°voll√©ti d√≠j sz√°m√≠t√°s√°ban:", error);
                return 0;
            }
        }
    }

    const SHIFT_START_DATE = new Date(Date.UTC(2024, 0, 1));

    // √Åltal√°nos seg√©df√ºggv√©ny a napok k√∂z√∂tti k√ºl√∂nbs√©g sz√°mol√°s√°hoz
    function getDaysBetween(startDate, endDate) {
        try {
            // Mindk√©t d√°tumot UTC-ben kezelj√ºk √©s az id≈ët 00:00:00-ra √°ll√≠tjuk
            const start = new Date(Date.UTC(
                startDate.getFullYear(),
                startDate.getMonth(),
                startDate.getDate()
            ));
            const end = new Date(Date.UTC(
                endDate.getFullYear(), 
                endDate.getMonth(), 
                endDate.getDate()
            ));
    
            const millisecondsPerDay = 24 * 60 * 60 * 1000;
            return Math.floor((end - start) / millisecondsPerDay);
        } catch (error) {
            console.error("Hiba a napok k√∂z√∂tti k√ºl√∂nbs√©g sz√°m√≠t√°s√°n√°l:", error);
            return 0;
        }
    }

    class EventHandlers {
        constructor(app) {
        this.app = app;

        // √âv v√°lt√°s esem√©nykezel≈ëk
        this.initYearChangeHandlers();

        // Be√°ll√≠t√°sok esem√©nykezel≈ëk
        this.initSettingsHandlers();

        // Sz√≠nbe√°ll√≠t√°sok esem√©nykezel≈ëk
        this.initColorHandlers();
        }

        initYearChangeHandlers() {
        // Napt√°r √©v v√°lt√°s
        document
            .getElementById("prev-month-btn")
            ?.addEventListener("click", () => {
            this.app.changeYear(-1, "calendar");
            });

        document
            .getElementById("next-month-btn")
            ?.addEventListener("click", () => {
            this.app.changeYear(1, "calendar");
            });

        // B√©rsz√°mfejt√©s √©v v√°lt√°s
        document
            .getElementById("prev-payroll-month-btn")
            ?.addEventListener("click", () => {
            this.app.changeYear(-1, "payroll");
            });

        document
            .getElementById("next-payroll-month-btn")
            ?.addEventListener("click", () => {
            this.app.changeYear(1, "payroll");
            });

        // Be√°ll√≠t√°sok √©v v√°lt√°s
        document
            .getElementById("prev-settings-year-btn")
            ?.addEventListener("click", () => {
            this.app.changeYear(-1, "settings");
            });

        document
            .getElementById("next-settings-year-btn")
            ?.addEventListener("click", () => {
            this.app.changeYear(1, "settings");
            });
        }

        initSettingsHandlers() {
        // Under 25 checkbox kezel√©se
        const under25Checkbox = document.getElementById("under25-checkbox");
        const birthDateContainer = document.getElementById(
            "birth-date-container"
        );

        under25Checkbox?.addEventListener("change", (e) => {
            if (birthDateContainer) {
            birthDateContainer.style.display = e.target.checked
                ? "block"
                : "none";
            this.app.yearlyData[
                this.app.currentSettingsYear
            ].settings.under25.enabled = e.target.checked;
            }
        });

        // √âvk√∂zi v√°ltoz√°s hozz√°ad√°sa
        document
            .getElementById("add-midyear-change")
            ?.addEventListener("click", () => {
            const monthSelect = document.getElementById("midyear-month");
            const salaryInput = document.getElementById("midyear-salary");

            if (!monthSelect?.value || !salaryInput?.value) {
                alert("K√©rlek v√°lassz h√≥napot √©s adj meg √∫j besorol√°si b√©rt!");
                return;
            }

            this.app.addMidyearChange(monthSelect.value, salaryInput.value);

            // Mez≈ëk t√∂rl√©se
            monthSelect.value = "";
            salaryInput.value = "";
            });

        // Be√°ll√≠t√°sok ment√©se
        document
            .getElementById("save-settings")
            ?.addEventListener("click", () => {
            try {
                this.app.saveSettings();
                alert("Be√°ll√≠t√°sok sikeresen mentve!");
            } catch (error) {
                alert("Hiba t√∂rt√©nt a be√°ll√≠t√°sok ment√©se sor√°n!");
                console.error(error);
            }
            });
        }

        initColorHandlers() {
        const colorPickers = document.querySelectorAll(".color-picker");

        colorPickers.forEach((button) => {
            button.addEventListener("click", (e) => {
            e.preventDefault();

            const input = document.createElement("input");
            input.type = "color";

            const shiftType = button.getAttribute("data-shift-type");
            const colorType = button.getAttribute("data-color-type");

            if (shiftType && colorType) {
                this.handleColorPicker(input, shiftType, colorType);
            }
            });
        });
        }

        handleColorPicker(input, shiftType, colorType) {
        const key = this.findShiftColorKey(shiftType);
        if (!key) return;

        input.value =
            colorType === "bg" ? SHIFT_COLORS[key][0] : SHIFT_COLORS[key][1];

        input.addEventListener("input", (event) => {
            if (colorType === "bg") {
            SHIFT_COLORS[key][0] = event.target.value;
            } else {
            SHIFT_COLORS[key][1] = event.target.value;
            }

            this.app.updateColorPreviews();
            this.app.generateCalendar();
            this.app.saveColorSettings();
        });

        input.click();
        }

        findShiftColorKey(shiftType) {
        return Object.keys(SHIFT_COLORS).find(
            (key) =>
            key
                .toLowerCase()
                .normalize("NFD")
                .replace(/[\u0300-\u036f]/g, "") ===
            shiftType
                .toLowerCase()
                .normalize("NFD")
                .replace(/[\u0300-\u036f]/g, "")
        );
        }
    }

    class ErrorHandler {
        static handle(error, context) {
        console.error(`Hiba a k√∂vetkez≈ë m≈±velet sor√°n: ${context}`, error);

        let userMessage;
        switch (context) {
            case "saveSettings":
            userMessage =
                "Nem siker√ºlt menteni a be√°ll√≠t√°sokat. K√©rlek pr√≥b√°ld √∫jra!";
            break;
            case "loadSettings":
            userMessage =
                "Nem siker√ºlt bet√∂lteni a be√°ll√≠t√°sokat. Alap√©rtelmezett √©rt√©kek ker√ºlnek haszn√°latra.";
            break;
            case "calculateSalary":
            userMessage =
                "Hiba t√∂rt√©nt a b√©rsz√°m√≠t√°s sor√°n. K√©rlek ellen≈ërizd a megadott adatokat!";
            break;
            default:
            userMessage = "V√°ratlan hiba t√∂rt√©nt. K√©rlek pr√≥b√°ld √∫jra!";
        }

        alert(userMessage);
        return null;
        }

        static validateInput(value, type) {
        switch (type) {
            case "salary":
            return !isNaN(value) && value >= 0;
            case "year":
            return !isNaN(value) && value >= 2024 && value <= 2028;
            case "month":
            return !isNaN(value) && value >= 0 && value <= 11;
            default:
            return true;
        }
        }
    }

    class BerszamfejtoApp {
        constructor() {
            console.log("App constructor started");
            
            try {
                // Alapvet≈ë d√°tumok inicializ√°l√°sa
                const currentDate = new Date();
                const currentYear = currentDate.getFullYear();
                
                console.log("Current date initialized:", currentDate);
                
                this.currentYear = currentYear >= 2024 && currentYear <= 2028 ? currentYear : 2024;
                this.currentMonth = currentDate.getMonth();
                this.currentPayrollYear = this.currentYear;
                this.currentPayrollMonth = this.currentMonth;
                this.currentSettingsYear = this.currentYear;
                this.calculator = new BerszamfejtoCalculator(this);
        
                console.log("Years initialized:", {
                    currentYear: this.currentYear,
                    currentMonth: this.currentMonth
                });
        
                // Adatstrukt√∫r√°k inicializ√°l√°sa
                this.initializeYearlyData();
                console.log("YearlyData initialized");
        
                // Bet√∂ltj√ºk a mentett adatokat
                this.loadYearlyData();
                console.log("YearlyData loaded");
        
                // Tov√°bbi inicializ√°l√°sok
                document.getElementById('current-settings-year').textContent = this.currentSettingsYear;
                this.loadColorSettings();
                
                console.log("Starting navigation initialization");
                this.initNavigation();
                this.initEventListeners();
                this.initSettingsNavigation();
                this.initTouchNavigation();
                this.initSettings();
                this.salaryVisibility = initSalaryVisibility();
        
                console.log("Starting calendar generation");
                this.generateCalendar();
                
                console.log("Starting payroll initialization");
                this.initPayrollNavigation();
                this.generatePayrollTable();
        
            } catch (error) {
                console.error("Hiba az alkalmaz√°s inicializ√°l√°sa sor√°n:", error);
                console.error("Hiba r√©szletei:", error.message);
                console.error("Hiba stack:", error.stack);
            }
        }
    
        initializeYearlyData() {
            console.log("YearlyData inicializ√°l√°sa kezd≈ëdik");
            this.yearlyData = {};
            // Inicializ√°ljuk az √∂sszes √©vet
            for (let year = 2024; year <= 2028; year++) {
                this.yearlyData[year] = {
                    settings: {
                        besorolasi_ber: "300000",
                        szabadsag: "25",
                        muszakrend: "1",
                        other_income: "0",
                        children_count: "0",
                        under25: {
                            enabled: false,
                            birthYear: "",
                            birthMonth: ""
                        },
                        midyear_changes: []
                    },
                    calendar_data: {},
                    bonusEntries: {},
                    restaurantEntries: {}
                };
    
                console.log(`${year} √©v adatainak gener√°l√°sa...`);
                // Inicializ√°ljuk a h√≥napokat √©s gener√°ljuk a m≈±szakrendet
                for (let month = 0; month < 12; month++) {
                    if (!this.yearlyData[year].calendar_data[month]) {
                        this.yearlyData[year].calendar_data[month] = {};
                    }
                    
                    // M≈±szakrend gener√°l√°sa minden napra
                    const daysInMonth = new Date(year, month + 1, 0).getDate();
                    for (let day = 1; day <= daysInMonth; day++) {
                        const currentYear = this.currentYear; // Mentj√ºk az eredeti √©rt√©ket
                        const currentMonth = this.currentMonth;
                        
                        // Be√°ll√≠tjuk ideiglenesen a gener√°l√°shoz sz√ºks√©ges √©rt√©keket
                        this.currentYear = year;
                        this.currentMonth = month;
                        
                        const shiftValue = this.generateShiftPattern(day);
                        if (shiftValue !== " ") {
                            this.yearlyData[year].calendar_data[month][day] = shiftValue;
                        }
                        
                        // Vissza√°ll√≠tjuk az eredeti √©rt√©keket
                        this.currentYear = currentYear;
                        this.currentMonth = currentMonth;
                    }
                    
                    // Alap√©rtelmezett b√≥nusz √©rt√©kek be√°ll√≠t√°sa (2)
                    if (!this.yearlyData[year].bonusEntries[month]) {
                        this.yearlyData[year].bonusEntries[month] = 2;
                    }
                }
            }
            console.log("YearlyData inicializ√°l√°sa befejezve");
        }       
    
        saveYearlyData() {
            try {
                // Debug: ki√≠rjuk a ment√©s el≈ëtti adatokat
                console.log('Ment√©s el≈ëtti adatok:', 
                    JSON.stringify(this.yearlyData[this.currentYear].calendar_data[this.currentMonth]));
                
                // Ment√©s el≈ëtt kitiszt√≠tjuk az undefined √©rt√©keket
                const yearData = JSON.parse(JSON.stringify(this.yearlyData));
                Object.keys(yearData).forEach(year => {
                    if (yearData[year].calendar_data) {
                        Object.keys(yearData[year].calendar_data).forEach(month => {
                            Object.keys(yearData[year].calendar_data[month]).forEach(day => {
                                if (yearData[year].calendar_data[month][day] === undefined) {
                                    yearData[year].calendar_data[month][day] = " ";
                                }
                            });
                        });
                    }
                });
                
                localStorage.setItem("berszamfejtoYearlyData", JSON.stringify(yearData));
                
                // Debug: ki√≠rjuk a ment√©s ut√°ni adatokat
                console.log('Ment√©s ut√°ni adatok:', 
                    JSON.stringify(yearData[this.currentYear].calendar_data[this.currentMonth]));
            } catch (error) {
                console.error("Hiba az adatok ment√©se sor√°n:", error);
            }
        }
    
        loadYearlyData() {
            try {
                console.log("Mentett adatok bet√∂lt√©se kezd≈ëdik");
                const savedData = localStorage.getItem("berszamfejtoYearlyData");
                if (savedData) {
                    const parsedData = JSON.parse(savedData);
                    
                    // √ñsszes √©v v√©gigiter√°l√°sa
                    for (let year = 2024; year <= 2028; year++) {
                        console.log(`${year} √©v adatainak bet√∂lt√©se...`);
                        if (parsedData[year]) {
                            // Settings m√°sol√°sa
                            this.yearlyData[year].settings = parsedData[year].settings || this.yearlyData[year].settings;
                            
                            // Calendar data ellen≈ërz√©se √©s gener√°l√°sa ha sz√ºks√©ges
                            for (let month = 0; month < 12; month++) {
                                // Ha nincs adat az adott h√≥napra, gener√°ljuk
                                if (!parsedData[year].calendar_data?.[month] || 
                                    Object.keys(parsedData[year].calendar_data[month]).length === 0) {
                                    
                                    if (!this.yearlyData[year].calendar_data[month]) {
                                        this.yearlyData[year].calendar_data[month] = {};
                                    }
                                    
                                    const daysInMonth = new Date(year, month + 1, 0).getDate();
                                    for (let day = 1; day <= daysInMonth; day++) {
                                        const currentYear = this.currentYear;
                                        const currentMonth = this.currentMonth;
                                        
                                        this.currentYear = year;
                                        this.currentMonth = month;
                                        
                                        const shiftValue = this.generateShiftPattern(day);
                                        if (shiftValue !== " ") {
                                            this.yearlyData[year].calendar_data[month][day] = shiftValue;
                                        }
                                        
                                        this.currentYear = currentYear;
                                        this.currentMonth = currentMonth;
                                    }
                                } else {
                                    // Ha van mentett adat, azt haszn√°ljuk
                                    this.yearlyData[year].calendar_data[month] = {
                                        ...parsedData[year].calendar_data[month]
                                    };
                                }
                            }
                            
                            // B√≥nuszok √©s √©ttermi fogyaszt√°s m√°sol√°sa
                            this.yearlyData[year].bonusEntries = {
                                ...parsedData[year].bonusEntries
                            };
                            this.yearlyData[year].restaurantEntries = {
                                ...parsedData[year].restaurantEntries
                            };
                        }
                    }
                    
                    // Mentj√ºk az esetleges √∫j gener√°lt adatokat
                    this.saveYearlyData();
                    console.log("Adatok bet√∂lt√©se √©s ment√©se befejezve");
                } else {
                    console.log("Nincs mentett adat, az alap√©rtelmezett √©rt√©kek maradnak");
                }
            } catch (error) {
                console.error("Hiba a mentett adatok bet√∂lt√©se sor√°n:", error);
                console.error("Hiba r√©szletei:", error.stack);
            }
        }

        addMidyearChange(month, salary) {
            try {
                // Ellen≈ërizz√ºk, hogy van-e m√°r ilyen h√≥napra v√°ltoz√°s
                if (!this.yearlyData[this.currentSettingsYear].settings.midyear_changes) {
                    this.yearlyData[this.currentSettingsYear].settings.midyear_changes = [];
                }
        
                // Ellen≈ërizz√ºk, hogy van-e m√°r v√°ltoz√°s erre a h√≥napra
                const existingChangeIndex = this.yearlyData[this.currentSettingsYear].settings.midyear_changes
                    .findIndex(change => change.month === parseInt(month));
        
                const change = {
                    month: parseInt(month),
                    salary: salary,
                    id: Date.now()
                };
        
                if (existingChangeIndex !== -1) {
                    // Ha m√°r van v√°ltoz√°s erre a h√≥napra, friss√≠tj√ºk
                    this.yearlyData[this.currentSettingsYear].settings.midyear_changes[existingChangeIndex] = change;
                } else {
                    // Ha nincs m√©g v√°ltoz√°s erre a h√≥napra, hozz√°adjuk
                    this.yearlyData[this.currentSettingsYear].settings.midyear_changes.push(change);
                }
        
                this.displayMidyearChanges();
                this.saveYearlyData();
                
                // Friss√≠tj√ºk a b√©rsz√°mfejt√©si t√°bl√°zatot is
                this.generatePayrollTable();
            } catch (error) {
                console.error("Hiba az √©vk√∂zi v√°ltoz√°s hozz√°ad√°sa sor√°n:", error);
                alert("Hiba t√∂rt√©nt az √©vk√∂zi v√°ltoz√°s hozz√°ad√°sa sor√°n!");
            }
        }

        // √âvk√∂zi v√°ltoz√°sok megjelen√≠t√©se
        // A BerszamfejtoApp oszt√°lyban m√≥dos√≠tsuk ezt a f√ºggv√©nyt:
        removeMidyearChange(id) {
            try {
                // Ellen≈ërizz√ºk, hogy l√©tezik-e az √©v √©s a midyear_changes t√∂mb
                if (!this.yearlyData[this.currentSettingsYear] ||
                    !this.yearlyData[this.currentSettingsYear].settings ||
                    !this.yearlyData[this.currentSettingsYear].settings.midyear_changes) {
                    console.error("Hi√°nyz√≥ adatstrukt√∫ra az √©vk√∂zi v√°ltoz√°sok kezel√©s√©hez");
                    return;
                }

                // T√∂r√∂lj√ºk a v√°ltoz√°st a t√∂mbb≈ël
                this.yearlyData[this.currentSettingsYear].settings.midyear_changes = 
                    this.yearlyData[this.currentSettingsYear].settings.midyear_changes.filter(
                        change => change.id !== id
                    );

                // Friss√≠tj√ºk a megjelen√≠t√©st √©s mentj√ºk az adatokat
                this.displayMidyearChanges();
                this.saveYearlyData();

                // Friss√≠tj√ºk a b√©rsz√°mfejt√©si t√°bl√°zatot is
                this.generatePayrollTable();
                
                console.log(`√âvk√∂zi v√°ltoz√°s t√∂r√∂lve: ${id}`);
            } catch (error) {
                console.error("Hiba az √©vk√∂zi v√°ltoz√°s t√∂rl√©se sor√°n:", error);
                alert("Hiba t√∂rt√©nt a v√°ltoz√°s t√∂rl√©se sor√°n!");
            }
        }

        displayMidyearChanges() {
            try {
                const container = document.getElementById('midyear-changes-list');
                if (!container) return;
        
                container.innerHTML = '';
        
                if (!this.yearlyData[this.currentSettingsYear]) {
                    this.yearlyData[this.currentSettingsYear] = {
                        settings: {
                            besorolasi_ber: "300000",
                            szabadsag: "25",
                            muszakrend: "1",
                            other_income: "0",
                            under25: {
                                enabled: false,
                                birthYear: "",
                                birthMonth: ""
                            },
                            midyear_changes: []
                        },
                        calendar_data: {},
                        bonusEntries: {},
                        restaurantEntries: {}
                    };
                }
        
                const changes = this.yearlyData[this.currentSettingsYear].settings.midyear_changes;
                const months = [
                    "JANU√ÅR", "FEBRU√ÅR", "M√ÅRCIUS", "√ÅPRILIS", "M√ÅJUS", "J√öNIUS",
                    "J√öLIUS", "AUGUSZTUS", "SZEPTEMBER", "OKT√ìBER", "NOVEMBER", "DECEMBER"
                ];
        
                changes.forEach(change => {
                    const div = document.createElement('div');
                    div.className = 'midyear-change-item';
        
                    div.innerHTML = `
                        <span>${months[change.month]}: ${parseInt(change.salary).toLocaleString('hu-HU')} Ft</span>
                        <button 
                            data-change-id="${change.id}"
                            class="remove-midyear-change"
                            style="background: none; border: none; color: red; cursor: pointer;"
                        >
                            T√∂rl√©s
                        </button>
                    `;
                    container.appendChild(div);
                });
        
                // Esem√©nykezel≈ë hozz√°ad√°sa a dinamikusan l√©trehozott gombokhoz
                container.addEventListener('click', (event) => {
                    const removeButton = event.target.closest('.remove-midyear-change');
                    if (removeButton) {
                        const changeId = parseInt(removeButton.getAttribute('data-change-id'));
                        
                        // Biztons√°gos h√≠v√°s, ha az app objektum l√©tezik
                        if (window.app && typeof window.app.removeMidyearChange === 'function') {
                            window.app.removeMidyearChange(changeId);
                        } else {
                            console.error('Az app objektum nem el√©rhet≈ë a t√∂rl√©sn√©l');
                        }
                    }
                });
            } catch (error) {
                console.error("Hiba az √©vk√∂zi v√°ltoz√°sok megjelen√≠t√©se sor√°n:", error);
            }
        }

        changeYear(direction, type = "calendar") {
            let currentYear;
            let minYear = 2024;
            let maxYear = 2028;
        
            switch (type) {
                case "calendar":
                    currentYear = this.currentYear + direction;
                    if (currentYear >= minYear && currentYear <= maxYear) {
                        this.currentYear = currentYear;
                        if (direction < 0 && this.currentMonth === 0) {
                            this.currentMonth = 11;
                            this.currentYear--;
                        } else if (direction > 0 && this.currentMonth === 11) {
                            this.currentMonth = 0;
                            this.currentYear++;
                        }
                    } else {
                        // Ha el√©rn√© a korl√°tokat, nem csin√°lunk semmit
                        return;
                    }
                    this.generateCalendar();
                    break;
        
                case "payroll":
                    currentYear = this.currentPayrollYear + direction;
                    if (currentYear >= minYear && currentYear <= maxYear) {
                        this.currentPayrollYear = currentYear;
                        if (direction < 0 && this.currentPayrollMonth === 0) {
                            this.currentPayrollMonth = 11;
                            this.currentPayrollYear--;
                        } else if (direction > 0 && this.currentPayrollMonth === 11) {
                            this.currentPayrollMonth = 0;
                            this.currentPayrollYear++;
                        }
                    } else {
                        // Ha el√©rn√© a korl√°tokat, nem csin√°lunk semmit
                        return;
                    }
                    this.generatePayrollTable();
                    break;
        
                case "settings":
                    currentYear = this.currentSettingsYear + direction;
                    if (currentYear >= minYear && currentYear <= maxYear) {
                        this.currentSettingsYear = currentYear;
                        this.loadYearSettings(this.currentSettingsYear);
                    } else {
                        // Ha el√©rn√© a korl√°tokat, nem csin√°lunk semmit
                        return;
                    }
                    break;
            }
        }

        // 25 √©v alatti kedvezm√©ny sz√°m√≠t√°sa
        calculateUnder25Discount(year, month, grossSalary) {
            if (year < 2024 || year > 2028) return 0;
        
            const yearData = this.yearlyData[year];
            if (!yearData?.settings?.under25?.enabled) return 0;
        
            const birthYear = parseInt(yearData.settings.under25.birthYear);
            const birthMonth = parseInt(yearData.settings.under25.birthMonth);
        
            if (!birthYear || !birthMonth) return 0;
        
            // Pontos √©letkor sz√°m√≠t√°s
            const birthDate = new Date(birthYear, birthMonth - 1);
            const currentDate = new Date(year, month);
            
            // √âletkor sz√°m√≠t√°sa pontosan
            let age = currentDate.getFullYear() - birthDate.getFullYear();
            if (currentDate < new Date(currentDate.getFullYear(), birthDate.getMonth(), birthDate.getDate())) {
                age--;
            }
        
            if (age >= 25) return 0;
        
            const maxDiscount = {
                2024: 1037880,
                2025: 1182213,
                2026: 1182213,
                2027: 1182213,
                2028: 1182213,
            };
        
            const maxMonthlyDiscount = maxDiscount[year] / 12;
        
            // Havi ar√°nyos√≠t√°s, ha az adott √©vben nem teljes √©vig jogosult
            const firstEligibleMonth = birthDate.getMonth() + (birthDate.getFullYear() === year ? 1 : 0);
            const lastEligibleMonth = birthDate.getMonth() + 12;
            const eligibleMonthsInYear = Math.min(12, lastEligibleMonth - firstEligibleMonth + 1);
        
            const monthlyDiscountRate = eligibleMonthsInYear / 12;
            const adjustedMaxMonthlyDiscount = maxMonthlyDiscount * monthlyDiscountRate;
        
            // A brutt√≥ b√©r 15%-a √©s a maxim√°lis havi kedvezm√©ny k√∂z√ºl a kisebb
            return Math.min(grossSalary * 0.15, adjustedMaxMonthlyDiscount);
        }

        debugCalendarData() {
        // Aktu√°lis h√≥nap napjainak sz√°ma
        const daysInMonth = new Date(
            this.currentYear,
            this.currentMonth + 1,
            0
        ).getDate();

        console.log("Debug - Napt√°r adatok ellen≈ërz√©se:");
        console.log(
            `√âv: ${this.currentYear}, H√≥nap: ${this.currentMonth + 1}`
        );
        console.log(`Napok sz√°ma ebben a h√≥napban: ${daysInMonth}`);

        if (this.yearData.calendar_data[this.currentMonth]) {
            Object.entries(this.yearData.calendar_data[this.currentMonth])
            .sort(([a], [b]) => parseInt(a) - parseInt(b))
            .forEach(([day, shift]) => {
                const dayNum = parseInt(day);
                if (dayNum <= daysInMonth) {
                console.log(`Nap ${dayNum}: ${shift}`);
                } else {
                console.error(`√ârv√©nytelen nap tal√°lt: ${dayNum}`);
                }
            });
        } else {
            console.log("Nincs adat erre a h√≥napra.");
        }
        }

        initTouchNavigation() {
        const calendarSection = document.getElementById("calendar-section");
        let startX = 0;
        let endX = 0;

        calendarSection.addEventListener("touchstart", (e) => {
            startX = e.touches[0].clientX;
        });

        calendarSection.addEventListener("touchend", (e) => {
            endX = e.changedTouches[0].clientX;
            this.handleSwipe(startX, endX);
        });
        }

        handleSwipe(startX, endX) {
        // Minimum elmozdul√°s √©rz√©kel√©s√©hez
        const minSwipeDistance = 100;

        if (startX - endX > minSwipeDistance) {
            // Balra h√∫z√°s - k√∂vetkez≈ë h√≥nap
            this.changeMonth(1);
        } else if (endX - startX > minSwipeDistance) {
            // Jobbra h√∫z√°s - el≈ëz≈ë h√≥nap
            this.changeMonth(-1);
        }
        }

        initNavigation() {
        const navButtons = {
            "calendar-btn": "calendar-section",
            "payroll-btn": "payroll-section",
            "settings-btn": "settings-section",
            "help-btn": "help-section",
        };

        Object.entries(navButtons).forEach(([btnId, sectionId]) => {
            document.getElementById(btnId).addEventListener("click", () => {
            this.showSection(sectionId);
            });
        });
        }

        showSection(sectionId) {
            // Elrejtj√ºk az √∂sszes szekci√≥t, de meg≈ërizz√ºk az esetleges anim√°ci√≥s oszt√°lyokat
            document.querySelectorAll(".section").forEach((section) => {
                const classes = Array.from(section.classList)
                    .filter(cls => !cls.includes('section') && !cls.includes('active'));
                section.className = `section ${classes.join(' ')}`;
                section.style.display = "none";
            });
        
            // Kijel√∂lt szekci√≥ megjelen√≠t√©se
            const selectedSection = document.getElementById(sectionId);
            if (selectedSection) {
                const classes = Array.from(selectedSection.classList)
                    .filter(cls => !cls.includes('section') && !cls.includes('active'));
                selectedSection.className = `section active ${classes.join(' ')}`;
                selectedSection.style.display = "block";
            }
        }

        loadSettings() {
        const savedSettings = localStorage.getItem("appSettings");
        return savedSettings
            ? JSON.parse(savedSettings)
            : {
                shiftPattern: "1",
                baseSalary: 0,
                vacationDays: 20,
            };
        }

        initEventListeners() {
        try {
            // H√≥nap navig√°ci√≥
            const prevMonthBtn = document.getElementById("prev-month-btn");
            const nextMonthBtn = document.getElementById("next-month-btn");

            if (prevMonthBtn) {
            prevMonthBtn.addEventListener("click", () =>
                this.changeMonth(-1)
            );
            }
            if (nextMonthBtn) {
            nextMonthBtn.addEventListener("click", () => this.changeMonth(1));
            }

            // M≈±szakrend √©s egy√©b be√°ll√≠t√°sok inicializ√°l√°sa
            const shiftPatternSelect = document.getElementById(
            "shift-pattern-select"
            );
            const baseSalaryInput = document.getElementById("base-salary");
            const vacationDaysInput = document.getElementById("vacation-days");

            // Ellen≈ërizz√ºk, hogy l√©teznek-e az elemek √©s van-e settings objektum
            if (
            shiftPatternSelect &&
            this.yearlyData[this.currentYear].settings
            ) {
            shiftPatternSelect.value =
                this.yearlyData[this.currentYear].settings.muszakrend || "1";
            }
            if (baseSalaryInput && this.yearlyData[this.currentYear].settings) {
            baseSalaryInput.value =
                this.yearlyData[this.currentYear].settings.besorolasi_ber ||
                "300000";
            }
            if (
            vacationDaysInput &&
            this.yearlyData[this.currentYear].settings
            ) {
            vacationDaysInput.value =
                this.yearlyData[this.currentYear].settings.szabadsag || "25";
            }

            // 25 √©v alatti checkbox kezel√©se
            const under25Checkbox = document.getElementById("under25-checkbox");
            if (under25Checkbox) {
            under25Checkbox.addEventListener("change", (e) => {
                const birthDateContainer = document.getElementById(
                "birth-date-container"
                );
                if (birthDateContainer) {
                birthDateContainer.style.display = e.target.checked
                    ? "block"
                    : "none";
                }
            });
            }

            // √âvk√∂zi v√°ltoz√°s hozz√°ad√°sa
            const midyearAddButton =
            document.getElementById("add-midyear-change");
            if (midyearAddButton) {
            midyearAddButton.addEventListener("click", () => {
                const monthSelect = document.getElementById("midyear-month");
                const salaryInput = document.getElementById("midyear-salary");

                if (
                monthSelect &&
                salaryInput &&
                monthSelect.value &&
                salaryInput.value
                ) {
                this.addMidyearChange(monthSelect.value, salaryInput.value);
                }
            });
            }
        } catch (error) {
            console.error(
            "Hiba az esem√©nykezel≈ëk inicializ√°l√°sa sor√°n:",
            error
            );
        }
        }

        initSettingsNavigation() {
        document
            .getElementById("prev-settings-year-btn")
            .addEventListener("click", () => {
            this.changeSettingsYear(-1);
            });

        document
            .getElementById("next-settings-year-btn")
            .addEventListener("click", () => {
            this.changeSettingsYear(1);
            });
        }

        changeSettingsYear(direction) {
            const settingsContent = document.getElementById("settings-section");
            
            // Add slide out animation
            settingsContent.className = `section ${direction > 0 ? 'slide-year-out-left' : 'slide-year-out-right'}`;
            
            setTimeout(() => {
                this.currentSettingsYear += direction;
        
                // Korl√°tozzuk az √©veket 2024 √©s 2028 k√∂z√∂tt
                if (this.currentSettingsYear < 2024) {
                    this.currentSettingsYear = 2024;
                    return;
                } else if (this.currentSettingsYear > 2028) {
                    this.currentSettingsYear = 2028;
                    return;
                }
        
                // Friss√≠ts√ºk az √©v kijelz√©st
                document.getElementById("current-settings-year").textContent = this.currentSettingsYear;
        
                // T√∂lts√ºk be az adott √©v be√°ll√≠t√°sait
                this.loadYearSettings(this.currentSettingsYear);
                
                // Add slide in animation
                settingsContent.className = `section active ${direction > 0 ? 'slide-year-in-right' : 'slide-year-in-left'}`;
            }, 200);
        }

        loadYearSettings(year) {
            console.log(`loadYearSettings megh√≠vva a k√∂vetkez≈ë √©vvel: ${year}`);
            console.log(`Jelenlegi rendszerid≈ë √©ve: ${new Date().getFullYear()}`);
            
            // Friss√≠ts√ºk a kijelzett √©vet
            document.getElementById('current-settings-year').textContent = year;
            this.currentSettingsYear = year;
        
            // Biztos√≠tjuk, hogy l√©tezik az adott √©v
            if (!this.yearlyData[year]) {
                this.yearlyData[year] = {
                    settings: {
                        besorolasi_ber: "300000",
                        szabadsag: "25",
                        muszakrend: "1", // Alap√©rtelmezett √©rt√©k vissza√°ll√≠t√°sa
                        other_income: "0",
                        under25: {
                            enabled: false,
                            birthYear: "",
                            birthMonth: ""
                        },
                        midyear_changes: []
                    },
                    calendar_data: {},
                    bonusEntries: {},
                    restaurantEntries: {}
                };
            }
        
            const yearData = this.yearlyData[year];
            
            // Form mez≈ëk felt√∂lt√©se
            const shiftPatternSelect = document.getElementById('shift-pattern-select');
            if (shiftPatternSelect) {
                // Ha nem l√©tezik be√°ll√≠tott m≈±szakrend, alap√©rtelmezetten '1'-et haszn√°ljuk
                shiftPatternSelect.value = yearData.settings.muszakrend || "1";
            }
            
            const baseSalaryInput = document.getElementById('base-salary');
            if (baseSalaryInput && this.salaryVisibility) {
                this.salaryVisibility.setValue(yearData.settings.besorolasi_ber || "300000");
            }
            
            const otherIncomeInput = document.getElementById('other-income');
            if (otherIncomeInput) {
                otherIncomeInput.value = yearData.settings.other_income || "0";
            }

            const vacationDaysInput = document.getElementById('vacation-days');
            if (vacationDaysInput) {
                vacationDaysInput.value = yearData.settings.szabadsag || "25";
            }
            
            // 25 √©v alatti be√°ll√≠t√°sok
            const under25 = yearData.settings.under25 || { enabled: false };
            const under25Checkbox = document.getElementById('under25-checkbox');
            const birthYearInput = document.getElementById('birth-year');
            const birthMonthInput = document.getElementById('birth-month');
            const birthDateContainer = document.getElementById('birth-date-container');
        
            if (under25Checkbox) under25Checkbox.checked = under25.enabled;
            if (birthYearInput) birthYearInput.value = under25.birthYear || '';
            if (birthMonthInput) birthMonthInput.value = under25.birthMonth || '';
            if (birthDateContainer) birthDateContainer.style.display = under25.enabled ? 'block' : 'none';
        
            // √âvk√∂zi v√°ltoz√°sok megjelen√≠t√©se
            this.displayMidyearChanges();
            
            console.log(`Bet√∂lt√∂tt √©v: ${year}, m≈±szakrend: ${yearData.settings.muszakrend}`); // Debug log
        }

        initSettings() {
            try {
                // Sz√≠nbe√°ll√≠t√°sok kezel√©se
                const colorPickers = document.querySelectorAll(".color-picker");
                colorPickers.forEach(button => {
                    button.addEventListener("click", (e) => this.handleColorPickerClick(e));
                });
        
                // Under 25 checkbox kezel√©se
                const under25Checkbox = document.getElementById("under25-checkbox");
                const birthDateContainer = document.getElementById("birth-date-container");
        
                if (under25Checkbox && birthDateContainer) {
                    under25Checkbox.addEventListener("change", (e) => {
                        birthDateContainer.style.display = e.target.checked ? "block" : "none";
                    });
                }
        
                // √âvk√∂zi v√°ltoz√°s hozz√°ad√°sa gomb kezel√©se
                const addMidyearChangeBtn = document.getElementById("add-midyear-change");
                if (addMidyearChangeBtn) {
                    addMidyearChangeBtn.addEventListener("click", () => {
                        const monthSelect = document.getElementById("midyear-month");
                        const salaryInput = document.getElementById("midyear-salary");
        
                        if (monthSelect && salaryInput && monthSelect.value && salaryInput.value) {
                            this.addMidyearChange(monthSelect.value, salaryInput.value);
                        }
                    });
                }
        
                // Be√°ll√≠t√°sok ment√©se gomb kezel√©se
                const saveSettingsBtn = document.getElementById("save-settings");
                    if (saveSettingsBtn) {
                        // El≈ësz√∂r t√∂r√∂lj√ºk az √∂sszes kor√°bban hozz√°adott esem√©nykezel≈ët
                        saveSettingsBtn.removeEventListener('click', this.saveSettingsHandler);
                
                        // Dedik√°lt esem√©nykezel≈ë met√≥dus
                        this.saveSettingsHandler = () => {
                            try {
                                this.saveSettings();
                                alert("Be√°ll√≠t√°sok sikeresen mentve!");
                            } catch (error) {
                                console.error("Hiba a be√°ll√≠t√°sok ment√©se sor√°n:", error);
                                alert("Hiba t√∂rt√©nt a be√°ll√≠t√°sok ment√©se sor√°n!");
                            }
                        };
                
                        // Esem√©nykezel≈ë hozz√°ad√°sa
                        saveSettingsBtn.addEventListener('click', this.saveSettingsHandler);
                    }
        
                // M≈±szakrend √©s egy√©b be√°ll√≠t√°sok inicializ√°l√°sa
                const shiftPatternSelect = document.getElementById("shift-pattern-select");
                const baseSalaryInput = document.getElementById("base-salary");
                const vacationDaysInput = document.getElementById("vacation-days");
                const otherIncomeInput = document.getElementById("other-income");
        
                // Ellen≈ërizz√ºk, hogy l√©teznek-e az elemek √©s van-e settings objektum
                if (shiftPatternSelect && this.yearlyData[this.currentYear]?.settings) {
                    shiftPatternSelect.value = this.yearlyData[this.currentYear].settings.muszakrend || "1";
                }
                if (baseSalaryInput && this.yearlyData[this.currentYear]?.settings) {
                    baseSalaryInput.value = this.yearlyData[this.currentYear].settings.besorolasi_ber || "300000";
                }
                if (vacationDaysInput && this.yearlyData[this.currentYear]?.settings) {
                    vacationDaysInput.value = this.yearlyData[this.currentYear].settings.szabadsag || "25";
                }
                if (otherIncomeInput && this.yearlyData[this.currentYear]?.settings) {
                    otherIncomeInput.value = this.yearlyData[this.currentYear].settings.other_income || "0";
                }
        
                // 25 √©v alatti be√°ll√≠t√°sok bet√∂lt√©se
                if (under25Checkbox && this.yearlyData[this.currentYear]?.settings?.under25) {
                    under25Checkbox.checked = this.yearlyData[this.currentYear].settings.under25.enabled;
                    if (birthDateContainer) {
                        birthDateContainer.style.display = under25Checkbox.checked ? "block" : "none";
                    }
        
                    const birthYearInput = document.getElementById("birth-year");
                    const birthMonthInput = document.getElementById("birth-month");
        
                    if (birthYearInput) {
                        birthYearInput.value = this.yearlyData[this.currentYear].settings.under25.birthYear || "";
                    }
                    if (birthMonthInput) {
                        birthMonthInput.value = this.yearlyData[this.currentYear].settings.under25.birthMonth || "";
                    }
                }
                            // Besorol√°si b√©r mez≈ë kezel√©se
                    const handleSalaryVisibility = () => {
                        const salaryInput = document.getElementById('base-salary');
                        const toggleButton = document.getElementById('toggle-salary-visibility');
                        let isVisible = false;
                        let hideTimeout;
                    
                        if (salaryInput && toggleButton) {
                    // Kezdeti √©rt√©k elrejt√©se funkci√≥ - most pontokat haszn√°lunk csillagok helyett
                    const maskValue = (value) => '‚Ä¢'.repeat(value.toString().length);
                    
                    // Input esem√©nykezel≈ë
                    salaryInput.addEventListener('input', function(e) {
                        clearTimeout(hideTimeout);
                        const value = e.target.value;
                        
                        // √ârt√©k ideiglenes megjelen√≠t√©se
                        this.type = 'number';
                        this.value = value;
                        
                        // Id≈ëz√≠t≈ë be√°ll√≠t√°sa az elrejt√©shez
                        if (!isVisible) {
                            hideTimeout = setTimeout(() => {
                                this.type = 'text';
                                this.value = maskValue(value);
                                this.classList.add('masked-value');
                            }, 1500);
                        }
                    });
            
                    // L√°that√≥s√°g kapcsol√≥
                    toggleButton.addEventListener('click', function() {
                        isVisible = !isVisible;
                        const currentValue = salaryInput.value.replace(/[‚Ä¢]/g, '');
                        
                        if (isVisible) {
                            salaryInput.type = 'number';
                            salaryInput.value = currentValue;
                            this.textContent = '√ó';
                            salaryInput.classList.remove('masked-value');
                        } else {
                            salaryInput.type = 'text';
                            salaryInput.value = maskValue(currentValue);
                            this.textContent = '‚Ä¢‚Ä¢‚Ä¢';
                            salaryInput.classList.add('masked-value');
                        }
                        
                        // Gomb anim√°ci√≥
                        this.style.transform = 'scale(0.8)';
                        setTimeout(() => {
                            this.style.transform = 'scale(1)';
                        }, 100);
                    });
            
                    // Kezdeti √°llapot be√°ll√≠t√°sa
                    salaryInput.type = 'text';
                    salaryInput.value = maskValue(salaryInput.value);
                    salaryInput.classList.add('masked-value');
            
                    // Mobilbar√°t √©rint√©s kezel√©s
                    toggleButton.addEventListener('touchstart', function(e) {
                        e.preventDefault(); // Megakad√°lyozza az alap√©rtelmezett √©rint√©s viselked√©st
                    });
                }
            };
        
                // Sz√≠nbe√°ll√≠t√°sok bet√∂lt√©se √©s el≈ën√©zetek friss√≠t√©se
                this.loadColorSettings();
                this.updateColorPreviews();
        
                // √âvk√∂zi v√°ltoz√°sok megjelen√≠t√©se
                this.displayMidyearChanges();
        
            } catch (error) {
                console.error("Hiba a be√°ll√≠t√°sok inicializ√°l√°sa sor√°n:", error);
            }
        }

        changeMonth(direction) {
            const calendarBody = document.getElementById("calendar-body");
            const currentMonthElement = document.getElementById("current-month");
            
            // Add slide out animation
            calendarBody.className = direction > 0 ? 'slide-out-left' : 'slide-out-right';
            
            setTimeout(() => {
                // Change month after slide out animation
                this.currentMonth += direction;
                
                if (this.currentMonth < 0) {
                    if (this.currentYear > 2024) {
                        this.currentMonth = 11;
                        this.currentYear--;
                    } else {
                        this.currentMonth = 0;
                        return;
                    }
                } else if (this.currentMonth > 11) {
                    if (this.currentYear < 2028) {
                        this.currentMonth = 0;
                        this.currentYear++;
                    } else {
                        this.currentMonth = 11;
                        return;
                    }
                }
        
                // Generate new calendar
                this.generateCalendar();
                
                // Add slide in animation
                calendarBody.className = direction > 0 ? 'slide-in-right' : 'slide-in-left';
            }, 200); // Match this with animation duration
        }
        
        changePayrollMonth(direction) {
            const payrollBody = document.getElementById("payroll-body");
            const currentPayrollMonthElement = document.getElementById("current-payroll-month");
            
            // Add slide out animation
            payrollBody.className = direction > 0 ? 'slide-out-left' : 'slide-out-right';
            
            setTimeout(() => {
                // Change month after slide out animation
                this.currentPayrollMonth += direction;
                
                if (this.currentPayrollMonth < 0) {
                    if (this.currentPayrollYear > 2024) {
                        this.currentPayrollMonth = 11;
                        this.currentPayrollYear--;
                    } else {
                        this.currentPayrollMonth = 0;
                        return;
                    }
                } else if (this.currentPayrollMonth > 11) {
                    if (this.currentPayrollYear < 2028) {
                        this.currentPayrollMonth = 0;
                        this.currentPayrollYear++;
                    } else {
                        this.currentPayrollMonth = 11;
                        return;
                    }
                }
        
                // Generate new payroll table
                this.generatePayrollTable();
                
                // Add slide in animation
                payrollBody.className = direction > 0 ? 'slide-in-right' : 'slide-in-left';
            }, 200); // Match this with animation duration
        }

        getHolidays(year) {
            // Fix √ºnnepnapok
            const fixedHolidays = [
                { month: 0, day: 1 },    // √öj√©v
                { month: 2, day: 15 },   // M√°rcius 15.
                { month: 4, day: 1 },    // Munka √ºnnepe
                { month: 7, day: 20 },   // √Ållamalap√≠t√°s √ºnnepe
                { month: 9, day: 23 },   // Okt√≥ber 23.
                { month: 10, day: 1 },   // Mindenszentek
                { month: 11, day: 25 },  // Kar√°csony
                { month: 11, day: 26 }   // Kar√°csony m√°snapja
            ];
        
            // H√∫sv√©t √©s kapcsol√≥d√≥ √ºnnepek kisz√°m√≠t√°sa
            const easter = this.calculateEaster(year);
            
            // Nagyp√©ntek (H√∫sv√©t vas√°rnap el≈ëtti p√©ntek)
            const goodFriday = new Date(easter);
            goodFriday.setDate(easter.getDate() - 2);
            
            // H√∫sv√©th√©tf≈ë
            const easterMonday = new Date(easter);
            easterMonday.setDate(easter.getDate() + 1);
            
            // P√ºnk√∂sd (H√∫sv√©t ut√°n 49 nappal)
            const pentecost = new Date(easter);
            pentecost.setDate(easter.getDate() + 49);
            
            // P√ºnk√∂sdh√©tf≈ë
            const pentecostMonday = new Date(pentecost);
            pentecostMonday.setDate(pentecost.getDate() + 1);
        
            // Mozg√≥ √ºnnepek hozz√°ad√°sa
            const movingHolidays = [
                { month: goodFriday.getMonth(), day: goodFriday.getDate() },           // Nagyp√©ntek
                { month: easterMonday.getMonth(), day: easterMonday.getDate() },       // H√∫sv√©th√©tf≈ë
                { month: pentecostMonday.getMonth(), day: pentecostMonday.getDate() }  // P√ºnk√∂sdh√©tf≈ë
            ];
        
            // √ñsszes √ºnnep √∂sszef≈±z√©se
            const allHolidays = [...fixedHolidays, ...movingHolidays];
        
            return allHolidays;
        }
        
        // H√∫sv√©t vas√°rnap kisz√°m√≠t√°sa (Meeus/Jones/Butcher algoritmus)
        calculateEaster(year) {
            const a = year % 19;
            const b = Math.floor(year / 100);
            const c = year % 100;
            const d = Math.floor(b / 4);
            const e = b % 4;
            const f = Math.floor((b + 8) / 25);
            const g = Math.floor((b - f + 1) / 3);
            const h = (19 * a + b - d - g + 15) % 30;
            const i = Math.floor(c / 4);
            const k = c % 4;
            const l = (32 + 2 * e + 2 * i - h - k) % 7;
            const m = Math.floor((a + 11 * h + 22 * l) / 451);
            const month = Math.floor((h + l - 7 * m + 114) / 31) - 1;
            const day = ((h + l - 7 * m + 114) % 31) + 1;
            
            return new Date(year, month, day);
        }

        isHoliday(year, month, day) {
            return this.calculator.isHoliday(year, month, day);
        }

        applyShiftColors(value, shiftDiv, dateSpan) {
            try {
                // Ha √ºres vagy undefined √©rt√©k, feh√©r h√°tt√©r fekete sz√∂veggel
                if (!value || value === undefined || value.trim() === " " || value.trim() === "") {
                    shiftDiv.style.backgroundColor = "white";
                    shiftDiv.style.color = "black";
                    dateSpan.style.backgroundColor = "#f0f0f0";
                    dateSpan.style.color = "#333";
                    return;
                }
        
                // Keress√ºk a megfelel≈ë sz√≠nt
                let found = false;
                Object.entries(SHIFT_COLORS).forEach(([type, [bgColor, textColor]]) => {
                    // Normaliz√°ljuk mindk√©t stringet az √∂sszehasonl√≠t√°shoz
                    const normalizedValue = value.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                    const normalizedType = type.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                    
                    if (normalizedValue.includes(normalizedType)) {
                        shiftDiv.style.backgroundColor = bgColor;
                        shiftDiv.style.color = textColor;
                        dateSpan.style.backgroundColor = bgColor;
                        dateSpan.style.color = textColor;
                        found = true;
                    }
                });
        
                // Ha nem tal√°ltunk sz√≠nt, alap√©rtelmezett sz√≠nek
                if (!found) {
                    console.log(`Nem tal√°lhat√≥ sz√≠n: ${value}`); // Debug log
                    shiftDiv.style.backgroundColor = "white";
                    shiftDiv.style.color = "black";
                    dateSpan.style.backgroundColor = "#f0f0f0";
                    dateSpan.style.color = "#333";
                }
            } catch (error) {
                console.error("Hiba a sz√≠nek alkalmaz√°sa sor√°n:", error);
            }
        }

        // Napt√°r gener√°l√°sa
        generateCalendar() {
            try {
                // DOM elemek lek√©r√©se
                const calendarBody = document.getElementById("calendar-body");
                const currentMonthElement = document.getElementById("current-month");
                
                if (!calendarBody || !currentMonthElement) {
                    throw new Error("Hi√°nyz√≥ DOM elemek a napt√°r gener√°l√°s√°hoz");
                }
        
                // √únnepnapok lek√©r√©se az aktu√°lis √©vre
                const holidays = this.calculator.getHolidays(this.currentYear);
        
                // H√≥napok nevei
                const months = [
                    "JANU√ÅR", "FEBRU√ÅR", "M√ÅRCIUS", "√ÅPRILIS", "M√ÅJUS", "J√öNIUS",
                    "J√öLIUS", "AUGUSZTUS", "SZEPTEMBER", "OKT√ìBER", "NOVEMBER", "DECEMBER"
                ];
        
                // H√≥nap √©s √©v ki√≠r√°sa a fejl√©cbe
                currentMonthElement.textContent = `${months[this.currentMonth]} ${this.currentYear}`;
        
                // Adatstrukt√∫r√°k inicializ√°l√°sa
                if (!this.yearlyData[this.currentYear]) {
                    this.yearlyData[this.currentYear] = {
                        settings: {
                            besorolasi_ber: "300000",
                            szabadsag: "25",
                            muszakrend: "1",
                            other_income: "0",
                            under25: {
                                enabled: false,
                                birthYear: "",
                                birthMonth: ""
                            },
                            midyear_changes: []
                        },
                        calendar_data: {},
                        bonusEntries: {},
                        restaurantEntries: {}
                    };
                }
        
                // Calendar_data inicializ√°l√°sa az aktu√°lis h√≥napra
                if (!this.yearlyData[this.currentYear].calendar_data[this.currentMonth]) {
                    this.yearlyData[this.currentYear].calendar_data[this.currentMonth] = {};
                }
        
                // Napt√°r gener√°l√°s el≈ëk√©sz√≠t√©se
                calendarBody.innerHTML = "";
                const firstDay = new Date(this.currentYear, this.currentMonth, 1).getDay();
                const daysInMonth = new Date(this.currentYear, this.currentMonth + 1, 0).getDate();
                const today = new Date();
                
                // Vas√°rnap (0) √°tkonvert√°l√°sa h√©tf≈ëre (6)
                const adjustedFirstDay = firstDay === 0 ? 6 : firstDay - 1;
        
                let currentDate = 1;
                let currentWeek = document.createElement("tr");
        
                // Els≈ë h√©t √ºres cell√°inak hozz√°ad√°sa
                for (let i = 0; i < adjustedFirstDay; i++) {
                    const emptyCell = document.createElement("td");
                    currentWeek.appendChild(emptyCell);
                }
        
                // Napt√°r felt√∂lt√©se
                while (currentDate <= daysInMonth) {
                    // Ha √∫j h√©t kezd≈ëdik
                    if ((adjustedFirstDay + currentDate - 1) % 7 === 0 && currentDate !== 1) {
                        calendarBody.appendChild(currentWeek);
                        currentWeek = document.createElement("tr");
                    }
        
                    const cell = document.createElement("td");
                    
                    // √únnepnap ellen≈ërz√©se
                    const isCurrentDayHoliday = holidays.some(holiday => 
                        holiday.month === this.currentMonth && holiday.day === currentDate
                    );
        
                    // Mai nap ellen≈ërz√©se
                    const isToday = 
                        this.currentYear === today.getFullYear() &&
                        this.currentMonth === today.getMonth() &&
                        currentDate === today.getDate();
        
                    // D√°tum kont√©ner l√©trehoz√°sa
                    const dateContainer = document.createElement("div");
                    dateContainer.className = "date-container";
        
                    // D√°tum sz√°m l√©trehoz√°sa
                    const dateSpan = document.createElement("span");
                    dateSpan.className = "date-number";
                    dateSpan.textContent = currentDate;
                    dateContainer.appendChild(dateSpan);
        
                    // M≈±szak div l√©trehoz√°sa
                    const shiftDiv = document.createElement("div");
                    shiftDiv.className = "shift-select";
        
                    // Esem√©nykezel≈ë hozz√°ad√°sa
                    shiftDiv.addEventListener("click", (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        
                        const clickedDay = parseInt(dateSpan.textContent);
                        console.log(`Kattint√°s a k√∂vetkez≈ë napra: ${clickedDay}`);
        
                        // Modal l√©trehoz√°sa
                        const overlay = document.createElement("div");
                        overlay.className = "shift-select-overlay";
                        
                        const modal = document.createElement("div");
                        modal.className = "shift-select-modal";
                        
                        // Modal c√≠me
                        const title = document.createElement("h2");
                        title.textContent = `${this.currentYear}. ${this.currentMonth + 1}. ${clickedDay}.`;
                        title.style.marginBottom = "15px";
                        modal.appendChild(title);
        
                        // M≈±szak opci√≥k
                        const shifts = [
                            "", // Szabadnap
                            "Nappal",
                            "√âjszaka",
                            "Szabads√°g 12 √≥ra",
                            "Szabads√°g √©j 12 √≥ra",
                            "Szabads√°g 8 √≥ra",
                            "Szabads√°g √©j 8 √≥ra",
                            "Szabads√°g 4 √≥ra",
                            "Szabads√°g √©j 4 √≥ra",
                            "T√∫l√≥ra 12 √≥ra",
                            "T√∫l√≥ra √©j 12 √≥ra",
                            "T√∫l√≥ra 8 √≥ra",
                            "T√∫l√≥ra √©j 8 √≥ra",
                            "Cs√∫sz√≥ 12 √≥ra",
                            "Cs√∫sz√≥ √©j 12 √≥ra",
                            "Cs√∫sz√≥ 8 √≥ra",
                            "Cs√∫sz√≥ √©j 8 √≥ra",
                            "Cs√∫sz√≥ 4 √≥ra",
                            "Cs√∫sz√≥ √©j 4 √≥ra",
                            "T√°pp√©nz"
                        ];
        
                        shifts.forEach(shiftName => {
                            const button = document.createElement("button");
                            button.textContent = shiftName === "" ? "Szabadnap" : shiftName;
                            button.style.display = "block";
                            button.style.width = "100%";
                            button.style.padding = "10px";
                            button.style.marginBottom = "20px";
                            button.style.border = "none";
                            button.style.borderRadius = "5px";
                            
                            const matchedKey = Object.keys(SHIFT_COLORS).find(
                                key => shiftName.includes(key)
                            );
                            
                            if (matchedKey) {
                                const [bgColor, textColor] = SHIFT_COLORS[matchedKey];
                                button.style.backgroundColor = bgColor;
                                button.style.color = textColor;
                            } else if (shiftName === "") {
                                button.style.backgroundColor = "white";
                                button.style.color = "black";
                                button.style.border = "1px solid #ddd";
                            } else {
                                button.style.backgroundColor = "#4a90e2";
                                button.style.color = "white";
                            }
        
                            button.addEventListener("click", () => {
                                const newShift = shiftName === "" ? " " : shiftName;  // √úres string helyett sz√≥k√∂z
                                
                                shiftDiv.textContent = newShift;
                                this.applyShiftColors(newShift, shiftDiv, dateSpan);
                                
                                // Mindig ments√ºk el az √©rt√©ket, m√©g ha √ºres is
                                this.yearlyData[this.currentYear].calendar_data[this.currentMonth][clickedDay] = newShift;
                                
                                console.log(`M√≥dos√≠t√°s: ${this.currentYear}.${this.currentMonth+1}.${clickedDay} - √öj √©rt√©k: "${newShift}"`);
                                console.log('M√≥dos√≠t√°s ut√°n a h√≥nap adatai:', 
                                    JSON.stringify(this.yearlyData[this.currentYear].calendar_data[this.currentMonth]));
                                
                                this.saveYearlyData();
                                
                                this.currentPayrollMonth = this.currentMonth;
                                this.currentPayrollYear = this.currentYear;
                                this.generatePayrollTable();
                                
                                document.body.removeChild(overlay);
                            });
                            
                            modal.appendChild(button);
                        });
        
                        // M√©gsem gomb
                        const closeButton = document.createElement("button");
                        closeButton.textContent = "M√©gsem";
                        closeButton.style.display = "block";
                        closeButton.style.width = "100%";
                        closeButton.style.padding = "10px";
                        closeButton.style.backgroundColor = "#ff4d4d";
                        closeButton.style.color = "white";
                        closeButton.style.border = "none";
                        closeButton.style.borderRadius = "5px";
                        
                        closeButton.addEventListener("click", () => {
                            document.body.removeChild(overlay);
                        });
                        
                        modal.appendChild(closeButton);
                        overlay.appendChild(modal);
                        document.body.appendChild(overlay);
        
                        overlay.addEventListener("click", (event) => {
                            if (event.target === overlay) {
                                document.body.removeChild(overlay);
                            }
                        });
                    });
        
                    // M≈±szak √©rt√©k meghat√°roz√°sa
                    let shiftValue = this.yearlyData[this.currentYear].calendar_data[this.currentMonth][currentDate];

                    // Csak akkor gener√°ljunk √∫j √©rt√©ket, ha nincs mentett √©rt√©k
                    if (shiftValue === undefined) {
                        shiftValue = this.generateShiftPattern(currentDate);
                        
                        // Ha a gener√°lt √©rt√©k nem √ºres, akkor ments√ºk el
                        if (shiftValue !== " ") {
                            this.yearlyData[this.currentYear].calendar_data[this.currentMonth][currentDate] = shiftValue;
                        }
                    }
        
                    shiftDiv.textContent = shiftValue;
                    this.applyShiftColors(shiftValue, shiftDiv, dateSpan);
        
                    if (isToday) {
                        cell.classList.add("today");
                    }
                    if (isCurrentDayHoliday) {
                        cell.classList.add("holiday");
                    }
        
                    dateContainer.appendChild(shiftDiv);
                    cell.appendChild(dateContainer);
                    currentWeek.appendChild(cell);
        
                    currentDate++;
                }
        
                // Utols√≥ h√©t hozz√°ad√°sa
                if (currentWeek.hasChildNodes()) {
                    calendarBody.appendChild(currentWeek);
                }
        
                // Adatok ment√©se
                this.saveYearlyData();
                
            } catch (error) {
                console.error("Hiba a napt√°r gener√°l√°sa sor√°n:", error);
            }
        }

        // √únnepnapok ellen≈ërz√©se
        isHoliday(year, month, day) {
        const holidays = [
            { month: 0, day: 1 }, // √öj√©v
            { month: 2, day: 15 }, // M√°rcius 15.
            { month: 3, day: 1 }, // Munka √ºnnepe
            { month: 4, day: 19 }, // P√ºnk√∂sd
            { month: 7, day: 20 }, // √Ållamalap√≠t√°s √ºnnepe
            { month: 9, day: 23 }, // Nemzeti √ºnnep
            { month: 11, day: 25 }, // Kar√°csony
            { month: 11, day: 26 }, // Kar√°csony m√°snapja
        ];

        return holidays.some(
            (holiday) => holiday.month === month && holiday.day === day
        );
        }

        generateShiftPattern(day) {
            try {
                const currentDate = new Date(this.currentYear, this.currentMonth, day);
                const currentPattern = this.yearlyData[this.currentYear]?.settings?.muszakrend || "1";
                let shiftValue;
                
                switch (currentPattern) {
                    case "A":
                        // A, B, C m≈±szakrendn√©l ne gener√°ljon m≈±szakot √ºnnepnapon
                        if (this.calculator.isHoliday(this.currentYear, this.currentMonth, day)) {
                            return " ";
                        }
                        shiftValue = this.generateAShiftPattern(this.currentYear, this.currentMonth, day);
                        break;
                    case "B":
                        if (this.calculator.isHoliday(this.currentYear, this.currentMonth, day)) {
                            return " ";
                        }
                        shiftValue = this.generateBShiftPattern(this.currentYear, this.currentMonth, day);
                        break;
                    case "C":
                        if (this.calculator.isHoliday(this.currentYear, this.currentMonth, day)) {
                            return " ";
                        }
                        shiftValue = this.generateCShiftPattern(this.currentYear, this.currentMonth, day);
                        break;
                    case "1":
                        shiftValue = this.generateClassicShiftPattern1(currentDate);
                        break;
                    case "2":
                        shiftValue = this.generateClassicShiftPattern2(currentDate);
                        break;
                    case "3":
                        shiftValue = this.generateClassicShiftPattern3(currentDate);
                        break;
                    case "4":
                        shiftValue = this.generateClassicShiftPattern4(currentDate);
                        break;
                    default:
                        shiftValue = " ";
                }
                
                return shiftValue;
            } catch (error) {
                console.error("Hiba a m≈±szakrend gener√°l√°s√°n√°l:", error);
                return " ";
            }
        }
        
        generateAShiftPattern(year, month, day) {
            const shiftCycle = [
                "Nappal", "Nappal", " ", 
                "√âjszaka", "√âjszaka", " ", " ", " ", " ", 
                "Nappal", "Nappal", "Nappal", " ", " ", 
                "√âjszaka", "√âjszaka", "√âjszaka", " ", " ", " ", " "
            ];
        
            // Ha √ºnnepnap, azonnal t√©rj√ºnk vissza √ºres √©rt√©kkel
            if (this.calculator.isHoliday(year, month, day)) {
                return " ";
            }
        
            // UTC d√°tumokat haszn√°lunk
            const startDate = new Date(Date.UTC(2025, 0, 6));  // 2025. janu√°r 6.
            const currentDate = new Date(Date.UTC(year, month, day));
            const daysDiff = getDaysBetween(startDate, currentDate);
        
            if (daysDiff < 0) {
                const negativeDaysDiff = Math.abs(daysDiff);
                const cycleLength = shiftCycle.length;
                const negativeIndex = (cycleLength - (negativeDaysDiff % cycleLength)) % cycleLength;
                return shiftCycle[negativeIndex];
            }
        
            return shiftCycle[daysDiff % shiftCycle.length];
        }
        
        generateBShiftPattern(year, month, day) {
            const shiftCycle = [
                "Nappal", "Nappal", " ", 
                "√âjszaka", "√âjszaka", " ", " ", " ", " ", 
                "Nappal", "Nappal", "Nappal", " ", " ", 
                "√âjszaka", "√âjszaka", "√âjszaka", " ", " ", " ", " "
            ];
        
            // Ha √ºnnepnap, azonnal t√©rj√ºnk vissza √ºres √©rt√©kkel
            if (this.calculator.isHoliday(year, month, day)) {
                return " ";
            }
        
            const startDate = new Date(Date.UTC(2025, 0, 20));  // 2025. janu√°r 20.
            const currentDate = new Date(Date.UTC(year, month, day));
            const daysDiff = getDaysBetween(startDate, currentDate);
        
            if (daysDiff < 0) {
                const negativeDaysDiff = Math.abs(daysDiff);
                const cycleLength = shiftCycle.length;
                const negativeIndex = (cycleLength - (negativeDaysDiff % cycleLength)) % cycleLength;
                return shiftCycle[negativeIndex];
            }
        
            return shiftCycle[daysDiff % shiftCycle.length];
        }
        
        generateCShiftPattern(year, month, day) {
            const shiftCycle = [
                "Nappal", "Nappal", " ", 
                "√âjszaka", "√âjszaka", " ", " ", " ", " ", 
                "Nappal", "Nappal", "Nappal", " ", " ", 
                "√âjszaka", "√âjszaka", "√âjszaka", " ", " ", " ", " "
            ];
        
            // Ha √ºnnepnap, azonnal t√©rj√ºnk vissza √ºres √©rt√©kkel
            if (this.calculator.isHoliday(year, month, day)) {
                return " ";
            }
        
            const startDate = new Date(Date.UTC(2025, 0, 13));  // 2025. janu√°r 13.
            const currentDate = new Date(Date.UTC(year, month, day));
            const daysDiff = getDaysBetween(startDate, currentDate);
        
            if (daysDiff < 0) {
                const negativeDaysDiff = Math.abs(daysDiff);
                const cycleLength = shiftCycle.length;
                const negativeIndex = (cycleLength - (negativeDaysDiff % cycleLength)) % cycleLength;
                return shiftCycle[negativeIndex];
            }
        
            return shiftCycle[daysDiff % shiftCycle.length];
        }

        generateClassicShiftPattern1(currentDate) {
            const utcDate = new Date(
                Date.UTC(
                    currentDate.getFullYear(),
                    currentDate.getMonth(),
                    currentDate.getDate()
                )
            );
            const startDate = new Date(Date.UTC(2024, 0, 1));
        
            const daysFromStart = getDaysBetween(startDate, utcDate);
            const cycleDay = ((daysFromStart % 8) + 8) % 8;
        
            return [6, 7].includes(cycleDay)
                ? "Nappal"
                : [2, 3].includes(cycleDay)
                ? "√âjszaka"
                : " ";
        }
        
        generateClassicShiftPattern2(currentDate) {
            const utcDate = new Date(
                Date.UTC(
                    currentDate.getFullYear(),
                    currentDate.getMonth(),
                    currentDate.getDate()
                )
            );
            const startDate = new Date(Date.UTC(2024, 0, 1));
        
            const daysFromStart = getDaysBetween(startDate, utcDate);
            const cycleDay = ((daysFromStart % 8) + 8) % 8;
        
            return [6, 7].includes(cycleDay)
                ? "√âjszaka"
                : [2, 3].includes(cycleDay)
                ? "Nappal"
                : " ";
        }
        
        generateClassicShiftPattern3(currentDate) {
            const utcDate = new Date(
                Date.UTC(
                    currentDate.getFullYear(),
                    currentDate.getMonth(),
                    currentDate.getDate()
                )
            );
            const startDate = new Date(Date.UTC(2024, 0, 1));
        
            const daysFromStart = getDaysBetween(startDate, utcDate);
            const cycleDay = ((daysFromStart % 8) + 8) % 8;
        
            return [0, 1].includes(cycleDay)
                ? "√âjszaka"
                : [4, 5].includes(cycleDay)
                ? "Nappal"
                : " ";
        }
        
        generateClassicShiftPattern4(currentDate) {
            const utcDate = new Date(
                Date.UTC(
                    currentDate.getFullYear(),
                    currentDate.getMonth(),
                    currentDate.getDate()
                )
            );
            const startDate = new Date(Date.UTC(2024, 0, 1));
        
            const daysFromStart = getDaysBetween(startDate, utcDate);
            const cycleDay = ((daysFromStart % 8) + 8) % 8;
        
            return [0, 1].includes(cycleDay)
                ? "Nappal"
                : [4, 5].includes(cycleDay)
                ? "√âjszaka"
                : " ";
        }

        initPayrollNavigation() {
            document.getElementById("prev-payroll-month-btn").addEventListener("click", () => {
                this.changePayrollMonth(-1);
                
                // √âvv√°lt√°s kezel√©se a 2024-2028 k√∂z√∂tti korl√°tokon bel√ºl
                if (this.currentPayrollMonth < 0) {
                    if (this.currentPayrollYear > 2024) {
                        this.currentPayrollMonth = 11;
                        this.currentPayrollYear--;
                    } else {
                        // Ha 2024 janu√°rj√°n√°l kor√°bbra pr√≥b√°lunk menni, nem csin√°lunk semmit
                        this.currentPayrollMonth = 0;
                        return;
                    }
                }
        
                this.generatePayrollTable();
            });
        
            document.getElementById("next-payroll-month-btn").addEventListener("click", () => {
                this.changePayrollMonth(1);
                
                // √âvv√°lt√°s kezel√©se a 2024-2028 k√∂z√∂tti korl√°tokon bel√ºl
                if (this.currentPayrollMonth > 11) {
                    if (this.currentPayrollYear < 2028) {
                        this.currentPayrollMonth = 0;
                        this.currentPayrollYear++;
                    } else {
                        // Ha 2028 december√©n√©l k√©s≈ëbbre pr√≥b√°lunk menni, nem csin√°lunk semmit
                        this.currentPayrollMonth = 11;
                        return;
                    }
                }
        
                this.generatePayrollTable();
            });

            const payrollSection = document.getElementById("payroll-section");
                let startX = 0;
                let endX = 0;

                payrollSection.addEventListener("touchstart", (e) => {
                    startX = e.touches[0].clientX;
                });

                payrollSection.addEventListener("touchend", (e) => {
                    endX = e.changedTouches[0].clientX;
                    this.handlePayrollSwipe(startX, endX);
                });
        }

        handlePayrollSwipe(startX, endX) {
            // Minimum elmozdul√°s √©rz√©kel√©s√©hez
            const minSwipeDistance = 100;
        
            if (startX - endX > minSwipeDistance) {
                // Balra h√∫z√°s - k√∂vetkez≈ë h√≥nap
                this.changePayrollMonth(1);
            } else if (endX - startX > minSwipeDistance) {
                // Jobbra h√∫z√°s - el≈ëz≈ë h√≥nap
                this.changePayrollMonth(-1);
            }
        }

        initColorSettings() {
        const colorSettingsContainer =
            document.getElementById("color-settings");
        if (!colorSettingsContainer) return;

        // Sz√≠nbe√°ll√≠t√°sok gener√°l√°sa
        Object.entries(SHIFT_COLORS).forEach(
            ([type, [bgColor, textColor]]) => {
            const row = this.createColorSettingRow(type, bgColor, textColor);
            colorSettingsContainer.appendChild(row);
            }
        );

        this.updateColorPreviews();
        }

        createColorSettingRow(type, bgColor, textColor) {
            const row = document.createElement("div");
            row.className = "color-row";
        
            const preview = document.createElement("div");
            preview.className = `color-preview ${this.normalizeClassName(type)}-preview`;
            preview.textContent = type;
        
            const buttonsContainer = document.createElement("div");
            buttonsContainer.className = "color-buttons";
        
            const bgButton = document.createElement("button");
            bgButton.className = "color-picker";
            bgButton.setAttribute("data-shift-type", type.toLowerCase());
            bgButton.setAttribute("data-color-type", "bg");
            bgButton.textContent = "H√°tt√©rsz√≠n";
        
            const textButton = document.createElement("button");
            textButton.className = "color-picker";
            textButton.setAttribute("data-shift-type", type.toLowerCase());
            textButton.setAttribute("data-color-type", "text");
            textButton.textContent = "Sz√∂vegsz√≠n";
        
            buttonsContainer.appendChild(bgButton);
            buttonsContainer.appendChild(textButton);
        
            row.appendChild(preview);
            row.appendChild(buttonsContainer);
        
            return row;
        }

        handleColorChange(key, colorType, newColor) {
            if (colorType === "bg") {
                SHIFT_COLORS[key][0] = newColor;
            } else {
                SHIFT_COLORS[key][1] = newColor;
            }
            this.updateColorPreviews();
            this.generateCalendar();
            this.saveColorSettings();
        }

        createColorButton(shiftType, colorType, label) {
        const button = document.createElement("button");
        button.className = "color-picker";
        button.setAttribute("data-shift-type", shiftType.toLowerCase());
        button.setAttribute("data-color-type", colorType);
        button.textContent = label;

        button.addEventListener("click", (e) =>
            this.handleColorPickerClick(e)
        );
        return button;
        }

        normalizeClassName(text) {
        return text
            .toLowerCase()
            .normalize("NFD")
            .replace(/[\u0300-\u036f]/g, "");
        }

        handleColorPickerClick(event) {
            event.preventDefault();
            const button = event.target;
            const shiftType = button.getAttribute("data-shift-type");
            const colorType = button.getAttribute("data-color-type");
            const key = Object.keys(SHIFT_COLORS).find(k => 
                k.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "") === 
                shiftType.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "")
            );
        
            if (!key) return;
        
            // Viewport m√©retek √©s modal m√©retek sz√°m√≠t√°sa
            const viewportWidth = window.innerWidth;
            const viewportHeight = window.innerHeight;
            const modalWidth = Math.round(viewportWidth * 0.8);
            const modalHeight = Math.round(viewportHeight * 0.8);

            // A canvasSize most m√°r nagyobb, a modal m√©ret√©nek 95%-a
            const canvasSize = Math.round(Math.min(modalWidth * 1, modalHeight * 0.9));

        
            // Overlay l√©trehoz√°sa
            const overlay = document.createElement("div");
            overlay.style.position = "fixed";
            overlay.style.top = "0";
            overlay.style.left = "0";
            overlay.style.width = "100%";
            overlay.style.height = "100%";
            overlay.style.backgroundColor = "rgba(0, 0, 0, 0.5)";
            overlay.style.zIndex = "999";
            overlay.style.display = "flex";
            overlay.style.alignItems = "center";
            overlay.style.justifyContent = "center";
        
            // Modal l√©trehoz√°sa
            const modal = document.createElement("div");
            modal.style.backgroundColor = "#333";
            modal.style.padding = "15px"; // cs√∂kkentett padding
            modal.style.borderRadius = "10px";
            modal.style.width = "modalWidth";
            modal.style.height = "modalHeight";
            modal.style.boxSizing = "border-box";
            modal.style.display = "flex";
            modal.style.flexDirection = "column";
            modal.style.alignItems = "center";
            modal.style.gap = "8px"; // kisebb gap az elemek k√∂z√∂tt
            modal.style.overflow = "hidden";
        
            // Sz√≠nv√°laszt√≥ canvas
            const canvas = document.createElement("canvas");
            canvas.width = canvasSize;
            canvas.height = canvasSize;
            canvas.style.cursor = "crosshair";
        
            // Canvas kont√©ner
            const canvasContainer = document.createElement("div");
            canvasContainer.style.position = "relative";
            canvasContainer.style.width = canvasSize + "px";
            canvasContainer.style.height = canvasSize + "px";
            canvasContainer.style.margin = "0"; // nincs margin
        
            // K√∂r jelz≈ë
            const colorSelector = document.createElement("div");
            colorSelector.style.position = "absolute";
            colorSelector.style.width = "10px";
            colorSelector.style.height = "10px";
            colorSelector.style.border = "2px solid white";
            colorSelector.style.borderRadius = "50%";
            colorSelector.style.pointerEvents = "none";
            colorSelector.style.transform = "translate(-50%, -50%)";
            colorSelector.style.boxShadow = "0 0 0 1px black";
        
            canvasContainer.appendChild(canvas);
            canvasContainer.appendChild(colorSelector);
        
            // Sz√≠ns√°v kont√©ner
            const hueContainer = document.createElement("div");
            hueContainer.style.position = "relative";
            hueContainer.style.width = canvasSize + "px";
            hueContainer.style.height = "40px";
            hueContainer.style.margin = "5px 0"; // kisebb margin
        
            // Sz√≠ns√°v l√©trehoz√°sa - a sz√©less√©g ugyanakkora mint a f≈ë canvas
            const hueCanvas = document.createElement("canvas");
            hueCanvas.width = canvasSize;
            hueCanvas.height = 40;  // magasabb, hogy jobban l√°that√≥ legyen
            hueCanvas.style.cursor = "pointer";
        
            // Sz√≠ns√°v cs√∫szka
            const hueSlider = document.createElement("div");
            hueSlider.style.position = "absolute";
            hueSlider.style.top = "0";
            hueSlider.style.width = "4px";
            hueSlider.style.height = "40px";
            hueSlider.style.backgroundColor = "white";
            hueSlider.style.border = "1px solid black";
            hueSlider.style.pointerEvents = "none";
            hueSlider.style.transform = "translateX(-50%)";
        
            hueContainer.appendChild(hueCanvas);
            hueContainer.appendChild(hueSlider);
        
            // RGB kijelz≈ë
            const rgbDisplay = document.createElement("div");
            rgbDisplay.style.backgroundColor = "#222";
            rgbDisplay.style.padding = "5px";  // nagyobb padding
            rgbDisplay.style.borderRadius = "5px";
            rgbDisplay.style.color = "white";
            rgbDisplay.style.fontFamily = "monospace";
            rgbDisplay.style.fontSize = "14px";  // nagyobb bet≈±m√©ret
            rgbDisplay.style.textAlign = "center";
            rgbDisplay.style.width = "100%";
            rgbDisplay.style.maxWidth = canvasSize + "px";
            rgbDisplay.style.marginTop = "5px";
        
            // El≈ën√©zeti panel
            const colorPreview = document.createElement("div");
            colorPreview.style.width = "100%";
            colorPreview.style.maxWidth = canvasSize + "px";
            colorPreview.style.height = "40px";  // magasabb el≈ën√©zeti panel
            colorPreview.style.border = "2px solid #444";
            colorPreview.style.borderRadius = "5px";
        
            let currentHue = 0;
            let currentPos = { x: 0, y: 0 };
            let isDragging = false;
            let isHueDragging = false;
            let currentColor = colorType === "bg" ? SHIFT_COLORS[key][0] : SHIFT_COLORS[key][1];
            colorPreview.style.backgroundColor = currentColor;
        
            // Kontextek l√©trehoz√°sa
            const ctx = canvas.getContext("2d", { willReadFrequently: true });
            const hueCtx = hueCanvas.getContext("2d", { willReadFrequently: true });
        
            // Sz√≠ns√°v rajzol√°sa
            const drawHueBar = () => {
                const gradient = hueCtx.createLinearGradient(0, 0, hueCanvas.width, 0);
                for (let i = 0; i <= 360; i += 30) {
                    gradient.addColorStop(i / 360, `hsl(${i}, 100%, 50%)`);
                }
                hueCtx.fillStyle = gradient;
                hueCtx.fillRect(0, 0, hueCanvas.width, hueCanvas.height);
            };
        
            // Sz√≠nspektrum rajzol√°sa
            const drawSpectrum = (hue) => {
                const pureColor = `hsl(${hue}, 100%, 50%)`;
                
                const whiteGrad = ctx.createLinearGradient(0, 0, canvas.width, 0);
                whiteGrad.addColorStop(0, "rgb(255,255,255)");
                whiteGrad.addColorStop(1, pureColor);
                ctx.fillStyle = whiteGrad;
                ctx.fillRect(0, 0, canvas.width, canvas.height);
        
                const blackGrad = ctx.createLinearGradient(0, 0, 0, canvas.height);
                blackGrad.addColorStop(0, "rgba(0,0,0,0)");
                blackGrad.addColorStop(1, "rgba(0,0,0,1)");
                ctx.fillStyle = blackGrad;
                ctx.fillRect(0, 0, canvas.width, canvas.height);
            };
        
            const validateRGB = (r, g, b) => {
                return {
                    r: Math.max(0, Math.min(255, Math.round(r))),
                    g: Math.max(0, Math.min(255, Math.round(g))),
                    b: Math.max(0, Math.min(255, Math.round(b)))
                };
            };
        
            const updateColor = (x, y) => {
                x = Math.max(0, Math.min(x, canvas.width - 1));
                y = Math.max(0, Math.min(y, canvas.height - 1));
                
                const pixel = ctx.getImageData(x, y, 1, 1).data;
                const rgb = validateRGB(pixel[0], pixel[1], pixel[2]);
                
                currentColor = `#${rgb.r.toString(16).padStart(2,'0')}${rgb.g.toString(16).padStart(2,'0')}${rgb.b.toString(16).padStart(2,'0')}`;
                rgbDisplay.textContent = `RGB: ${rgb.r}, ${rgb.g}, ${rgb.b}`;
                colorPreview.style.backgroundColor = currentColor;
                
                colorSelector.style.left = `${x}px`;
                colorSelector.style.top = `${y}px`;
                currentPos = { x, y };
            };
        
            const updateHue = (x) => {
                x = Math.max(0, Math.min(x, hueCanvas.width));
                currentHue = (x / hueCanvas.width) * 360;
                drawSpectrum(currentHue);
                hueSlider.style.left = `${x}px`;
                if (currentPos.x !== undefined && currentPos.y !== undefined) {
                    updateColor(currentPos.x, currentPos.y);
                }
            };
        
            const handleHueSelect = (e) => {
                const rect = hueCanvas.getBoundingClientRect();
                const x = Math.max(0, Math.min(e.clientX - rect.left, hueCanvas.width));
                updateHue(x);
            };
        
            const handleColorSelect = (e) => {
                const rect = canvas.getBoundingClientRect();
                const x = Math.max(0, Math.min(e.clientX - rect.left, canvas.width - 1));
                const y = Math.max(0, Math.min(e.clientY - rect.top, canvas.height - 1));
                updateColor(x, y);
            };
        
            // Mouse esem√©nyek
            canvas.addEventListener("mousedown", (e) => {
                e.preventDefault();
                isDragging = true;
                handleColorSelect(e);
            });
        
            hueCanvas.addEventListener("mousedown", (e) => {
                e.preventDefault();
                isHueDragging = true;
                handleHueSelect(e);
            });
        
            document.addEventListener("mousemove", (e) => {
                if (isDragging) handleColorSelect(e);
                if (isHueDragging) handleHueSelect(e);
            });
        
            document.addEventListener("mouseup", () => {
                isDragging = false;
                isHueDragging = false;
            });
        
            // Touch esem√©nyek
            canvas.addEventListener("touchstart", (e) => {
                e.preventDefault();
                isDragging = true;
                const touch = e.touches[0];
                const rect = canvas.getBoundingClientRect();
                const x = Math.max(0, Math.min(touch.clientX - rect.left, canvas.width - 1));
                const y = Math.max(0, Math.min(touch.clientY - rect.top, canvas.height - 1));
                updateColor(x, y);
            });
        
            hueCanvas.addEventListener("touchstart", (e) => {
                e.preventDefault();
                isHueDragging = true;
                const touch = e.touches[0];
                handleHueSelect(touch);
            });
        
            document.addEventListener("touchmove", (e) => {
                e.preventDefault();
                const touch = e.touches[0];
                if (isDragging) {
                    const rect = canvas.getBoundingClientRect();
                    const x = Math.max(0, Math.min(touch.clientX - rect.left, canvas.width - 1));
                    const y = Math.max(0, Math.min(touch.clientY - rect.top, canvas.height - 1));
                    updateColor(x, y);
                }
                if (isHueDragging) {
                    handleHueSelect(touch);
                }
            });
        
            document.addEventListener("touchend", () => {
                isDragging = false;
                isHueDragging = false;
            });
        
            // Gombok
            const buttonContainer = document.createElement("div");
            buttonContainer.style.display = "flex";
            buttonContainer.style.height = "60px";
            buttonContainer.style.gap = "8px";
            buttonContainer.style.width = canvasSize + "px";
            buttonContainer.style.marginTop = "5px";
        
            const saveButton = document.createElement("button");
            saveButton.textContent = "Ment√©s";
            saveButton.style.flex = "1";
            saveButton.style.padding = "10px";
            saveButton.style.fontSize = "25px";
            saveButton.style.backgroundColor = "#4CAF50";
            saveButton.style.color = "white";
            saveButton.style.border = "none";
            saveButton.style.borderRadius = "5px";
            saveButton.style.cursor = "pointer";
        
            const cancelButton = document.createElement("button");
            cancelButton.textContent = "M√©gse";
            cancelButton.style.flex = "1";
            cancelButton.style.padding = "10px";
            cancelButton.style.fontSize = "25px";
            cancelButton.style.backgroundColor = "#f44336";
            cancelButton.style.color = "white";
            cancelButton.style.border = "none";
            cancelButton.style.borderRadius = "5px";
            cancelButton.style.cursor = "pointer";
        
            buttonContainer.appendChild(saveButton);
            buttonContainer.appendChild(cancelButton);
        
            // Modal √∂ssze√°ll√≠t√°sa
            modal.appendChild(canvasContainer);
            modal.appendChild(hueContainer);
            modal.appendChild(rgbDisplay);
            modal.appendChild(colorPreview);
            modal.appendChild(buttonContainer);
            overlay.appendChild(modal);
            document.body.appendChild(overlay);
        
            // Kezdeti √°llapot be√°ll√≠t√°sa
            drawHueBar();
            drawSpectrum(currentHue);
        
            // Kezdeti sz√≠n be√°ll√≠t√°sa
            const setInitialPosition = () => {
                const r = parseInt(currentColor.slice(1,3), 16);
                const g = parseInt(currentColor.slice(3,5), 16);
                const b = parseInt(currentColor.slice(5,7), 16);
                
                let minDiff = Infinity;
                let bestX = 0;
                let bestY = 0;
                
                for(let x = 0; x < canvas.width; x += 5) {
                    for(let y = 0; y < canvas.height; y += 5) {
                        const pixel = ctx.getImageData(x, y, 1, 1).data;
                        const diff = Math.abs(pixel[0] - r) + Math.abs(pixel[1] - g) + Math.abs(pixel[2] - b);
                        if(diff < minDiff) {
                            minDiff = diff;
                            bestX = x;
                            bestY = y;
                        }
                    }
                }
                
                const hsl = rgbToHsl(r, g, b);
                const hueX = (hsl.h / 360) * hueCanvas.width;
                updateHue(hueX);
                    updateColor(bestX, bestY);
                };

                // RGB to HSL konvert√°l√≥
                const rgbToHsl = (r, g, b) => {
                    r /= 255;
                    g /= 255;
                    b /= 255;

                    const max = Math.max(r, g, b);
                    const min = Math.min(r, g, b);
                    let h, s, l = (max + min) / 2;

                    if (max === min) {
                        h = s = 0;
                    } else {
                        const d = max - min;
                        s = l > 0.5 ? d / (2 - max - min) : d / (max + min);

                        switch (max) {
                            case r: h = (g - b) / d + (g < b ? 6 : 0); break;
                            case g: h = (b - r) / d + 2; break;
                            case b: h = (r - g) / d + 4; break;
                        }

                        h = Math.round(h * 60);
                        if (h < 0) h += 360;
                    }

                    return { h, s, l };
                };

                // Gomb esem√©nyek
                saveButton.addEventListener("click", () => {
                    if (colorType === "bg") {
                        SHIFT_COLORS[key][0] = currentColor;
                    } else {
                        SHIFT_COLORS[key][1] = currentColor;
                    }
                    this.updateColorPreviews();
                    this.generateCalendar();
                    this.saveColorSettings();
                    document.body.removeChild(overlay);
                });

                cancelButton.addEventListener("click", () => {
                    document.body.removeChild(overlay);
                });

                // Overlay bez√°r√°sa kattint√°sra
                overlay.addEventListener("click", (e) => {
                    if (e.target === overlay) {
                        document.body.removeChild(overlay);
                    }
                });

                // K√©sleltetett kezdeti poz√≠ci√≥ be√°ll√≠t√°s
                setTimeout(setInitialPosition, 50);
            }
        
        generatePayrollTable() {
            try {
                // Ellen≈ërizz√ºk √©s inicializ√°ljuk az adott √©v adatait
                if (!this.yearlyData[this.currentPayrollYear]) {
                    this.yearlyData[this.currentPayrollYear] = {
                        settings: {
                            besorolasi_ber: "300000",
                            szabadsag: "25",
                            muszakrend: "1",
                            other_income: "0",
                            children_count: "0",
                            under25: {
                                enabled: false,
                                birthYear: "",
                                birthMonth: "",
                            },
                            midyear_changes: [],
                        },
                        calendar_data: {},
                        bonusEntries: {},
                        restaurantEntries: {},
                    };
                }
        
                // Ha nincs m√©g calendar_data az adott h√≥napra, inicializ√°ljuk
                if (!this.yearlyData[this.currentPayrollYear].calendar_data[this.currentPayrollMonth]) {
                    this.yearlyData[this.currentPayrollYear].calendar_data[this.currentPayrollMonth] = {};
                    // Gener√°ljuk ki a m≈±szakrendet
                    const daysInMonth = new Date(this.currentPayrollYear, this.currentPayrollMonth + 1, 0).getDate();
                    for (let day = 1; day <= daysInMonth; day++) {
                        const shiftValue = this.generateShiftPattern(day);
                        if (shiftValue !== " ") {
                            this.yearlyData[this.currentPayrollYear].calendar_data[this.currentPayrollMonth][day] = shiftValue;
                        }
                    }
                    this.saveYearlyData();
                }
        
                const payrollBody = document.getElementById("payroll-body");
                const currentPayrollMonthElement = document.getElementById("current-payroll-month");
        
                const months = [
                    "JANU√ÅR", "FEBRU√ÅR", "M√ÅRCIUS", "√ÅPRILIS", "M√ÅJUS", "J√öNIUS",
                    "J√öLIUS", "AUGUSZTUS", "SZEPTEMBER", "OKT√ìBER", "NOVEMBER", "DECEMBER"
                ];
        
                currentPayrollMonthElement.textContent = 
                    `${months[this.currentPayrollMonth]} ${this.currentPayrollYear}`;
        
                payrollBody.innerHTML = "";
        
                // T√©telek √©s ut√≥tagok defin√≠ci√≥ja
                const items = [
                    { label: "Ledolgozand√≥ napok", suffix: " nap" },
                    { label: "Ledolgozott napok", suffix: " nap" },
                    { label: "Szabads√°g kiv√©t (√≥ra)", suffix: " √≥ra" },
                    { label: "T√∫l√≥ra (100%)", suffix: " √≥ra" },
                    { label: "H√©tv√©gi p√≥tl√©k 50%", suffix: " √≥ra" },
                    { label: "M≈±szakp√≥tl√©k 40%", suffix: " √≥ra" },
                    { label: "Alapb√©r", suffix: " Ft" },
                    { label: "T√∫l√≥ra alap", suffix: " Ft" },
                    { label: "Szabads√°gra jut√≥ fizet√©s", suffix: " Ft" },
                    { label: "T√°voll√©ti d√≠j", suffix: " Ft" },
                    { label: "Fizetett √ºnnepnap", suffix: " Ft" },
                    { label: "T√∫l√≥rap√≥tl√©k", suffix: " Ft" },
                    { label: "H√©tv√©gi p√≥tl√©k (50%)", suffix: " Ft" },
                    { label: "M≈±szakp√≥tl√©k (40%)", suffix: " Ft" },
                    { label: "Teljes√≠tm√©ny pr√©mium", suffix: " Ft" },
                    { label: "B√≥nusz", suffix: "" },
                    { label: "√âttermi fogyaszt√°s", suffix: " Ft" },
                    { label: "Brutt√≥ b√©r", suffix: " Ft" },
                    { label: "TB J√°rul√©k 18,5%", suffix: " Ft" },
                    { label: "Rendszeres SZJA el≈ëleg", suffix: " Ft" },
                    { label: "Csal√°di ad√≥kedvezm√©ny", suffix: " Ft" },
                    { label: "Nett√≥", suffix: " Ft" },
                    { label: "Megmaradt szabads√°gok", suffix: " nap" },
                ];
        
                items.forEach((item) => {
                    const row = document.createElement("tr");
                    const labelCell = document.createElement("td");
                    const valueCell = document.createElement("td");
        
                    labelCell.textContent = item.label;
        
                    if (item.label === "B√≥nusz") {
                        const input = document.createElement("input");
                        input.type = "number";
                        input.min = "0";
                        input.max = "2";
                        input.step = "1";
                        input.className = "w-24 text-right px-2 py-1 border rounded";
        
                        const value = this.yearlyData[this.currentPayrollYear].bonusEntries?.[this.currentPayrollMonth] ?? 2;
                        input.value = value;
                        valueCell.appendChild(input);
        
                        input.addEventListener("change", (e) => {
                            window.validateBonus(e.target, this.currentPayrollMonth);
                        });
                    } 
                    else if (item.label === "√âttermi fogyaszt√°s") {
                        const input = document.createElement("input");
                        input.type = "number";
                        input.min = "0";
                        input.step = "1";
                        input.className = "w-24 text-right px-2 py-1 border rounded";
        
                        const value = this.yearlyData[this.currentPayrollYear].restaurantEntries?.[this.currentPayrollMonth] || 0;
                        input.value = value;
                        valueCell.appendChild(input);
        
                        input.addEventListener("change", (e) => {
                            window.validateRestaurant(e.target, this.currentPayrollMonth);
                        });
                    } 
                    else {
                        // Norm√°l √©rt√©kek megjelen√≠t√©se ut√≥taggal
                        const value = this.calculator.calculateMonthlyValue(
                            item.label,
                            this.currentPayrollMonth,
                            this.currentPayrollYear
                        );
        
                        // √ârt√©k form√°z√°sa a t√≠pus szerint
                        let formattedValue;
                        if (item.suffix === " nap") {
                            formattedValue = parseFloat(value).toFixed(1);
                        } else if (item.suffix === " Ft") {
                            formattedValue = Math.round(value);
                        } else {
                            formattedValue = Math.round(value);
                        }
        
                        // Ezres tagol√°s hozz√°ad√°sa √©s ut√≥tag
                        valueCell.textContent = formattedValue !== 0
                            ? formattedValue.toLocaleString("hu-HU") + item.suffix
                            : "0" + item.suffix;
                    }
        
                    row.appendChild(labelCell);
                    row.appendChild(valueCell);
                    payrollBody.appendChild(row);
                });
            } catch (error) {
                console.error("Hiba a b√©rsz√°mfejt√©si t√°bl√°zat gener√°l√°sa sor√°n:", error);
            }
        }

        loadData() {
        try {
            const savedData = localStorage.getItem("berszamfejtoData");

            if (savedData) {
            const parsedData = JSON.parse(savedData);
            console.log("Bet√∂lt√∂tt adatok:", parsedData);

            // Az adatok visszat√∂lt√©se a yearData objektumba
            this.yearData = {
                calendar_data: parsedData.calendar_data || {},
                bonusEntries: parsedData.bonusEntries || {},
                restaurantEntries: parsedData.restaurantEntries || {},
                settings: {
                besorolasi_ber:
                    this.settings.baseSalary?.toString() || "300000",
                szabadsag: this.settings.vacationDays?.toString() || "25",
                muszakrend: this.settings.shiftPattern || "1",
                },
            };
            }
        } catch (error) {
            console.error("Hiba az adatok bet√∂lt√©se sor√°n:", error);
        }
        }

        updateColorPreviews() {
        Object.entries(SHIFT_COLORS).forEach(
            ([type, [bgColor, textColor]]) => {
            // Normaliz√°ljuk a class nevet (√©kezetek elt√°vol√≠t√°sa)
            const previewClass =
                type
                .toLowerCase()
                .normalize("NFD")
                .replace(/[\u0300-\u036f]/g, "") + "-preview";

            const preview = document.querySelector(`.${previewClass}`);
            if (preview) {
                preview.style.backgroundColor = bgColor;
                preview.style.color = textColor;
                preview.textContent = type;
            }
            }
        );
        }

        saveColorSettings() {
        localStorage.setItem("shiftColors", JSON.stringify(SHIFT_COLORS));
        }

        loadColorSettings() {
        const savedColors = localStorage.getItem("shiftColors");
        if (savedColors) {
            const parsedColors = JSON.parse(savedColors);
            Object.entries(parsedColors).forEach(([key, value]) => {
            if (SHIFT_COLORS[key]) {
                SHIFT_COLORS[key] = value;
            }
            });
            this.updateColorPreviews();
        }
        }

        saveSettings() {
            try {
                const shiftPatternSelect = document.getElementById("shift-pattern-select");
                const baseSalaryInput = document.getElementById("base-salary");
                const vacationDaysInput = document.getElementById("vacation-days");
                const otherIncomeInput = document.getElementById("other-income");
                const under25Checkbox = document.getElementById("under25-checkbox");
                const birthYearInput = document.getElementById("birth-year");
                const birthMonthInput = document.getElementById("birth-month");
                const currentMonth = this.currentMonth;
                const childrenCountInput = document.getElementById("children-count");
                
        
                if (!shiftPatternSelect || !baseSalaryInput) {
                    throw new Error("Hi√°nyz√≥ form elemek");
                }
        
                // Az el≈ëz≈ë m≈±szakrend lek√©r√©se az √∂sszehasonl√≠t√°shoz
                const oldShiftPattern = this.yearlyData[this.currentSettingsYear]?.settings?.muszakrend || "1";
                const newShiftPattern = shiftPatternSelect.value;
                const shiftPatternChanged = oldShiftPattern !== newShiftPattern;
        
                // A be√°ll√≠t√°sok friss√≠t√©se az aktu√°lis √©vre
                if (!this.yearlyData[this.currentSettingsYear]) {
                    this.yearlyData[this.currentSettingsYear] = {
                        settings: {
                            besorolasi_ber: "300000",
                            szabadsag: "25",
                            muszakrend: "1",
                            other_income: "0",
                            children_count: "0",
                            under25: {
                                enabled: false,
                                birthYear: "",
                                birthMonth: ""
                            },
                            midyear_changes: []
                        },
                        calendar_data: {},
                        bonusEntries: {},
                        restaurantEntries: {}
                    };
                }
        
                // A be√°ll√≠t√°sok ment√©se
                this.yearlyData[this.currentSettingsYear].settings = {
                    ...this.yearlyData[this.currentSettingsYear].settings,
                    besorolasi_ber: baseSalaryInput.value,
                    szabadsag: vacationDaysInput?.value || "25",
                    muszakrend: newShiftPattern,
                    other_income: otherIncomeInput?.value || "0",
                    children_count: childrenCountInput?.value || "0",
                    under25: {
                        enabled: under25Checkbox?.checked || false,
                        birthYear: birthYearInput?.value || "",
                        birthMonth: birthMonthInput?.value || ""
                    }
                };
        
                // Csak akkor gener√°ljuk √∫jra a napt√°rat, ha v√°ltozott a m≈±szakrend
                    if (shiftPatternChanged) {
                        const year = this.currentSettingsYear;
                        
                        // Ha v√°ltozott a m≈±szakrend, teljesen √∫j calendar_data-t hozunk l√©tre
                        this.yearlyData[year].calendar_data = {};
                        
                        // √öj napt√°r gener√°l√°sa minden h√≥napra
                        for (let month = 0; month < 12; month++) {
                            this.yearlyData[year].calendar_data[month] = {};
                            
                            const daysInMonth = new Date(year, month + 1, 0).getDate();
                            for (let day = 1; day <= daysInMonth; day++) {
                                const previousYear = this.currentYear;
                                this.currentYear = year;
                                this.currentMonth = month;
                                
                                const shiftValue = this.generateShiftPattern(day);
                                
                                this.currentYear = previousYear;
                                this.currentMonth = this.currentMonth;

                                if (shiftValue !== " ") {
                                    this.yearlyData[year].calendar_data[month][day] = shiftValue;
                                }
                            }
                        }
                    }
        
                // Adatok ment√©se
                this.saveYearlyData();
                
                // Napt√°r √©s b√©rsz√°mfejt√©s friss√≠t√©se
                this.currentMonth = currentMonth;
                this.generateCalendar();
                this.generatePayrollTable();
        
            } catch (error) {
                console.error("Hiba a be√°ll√≠t√°sok ment√©se sor√°n:", error);
                alert("Hiba t√∂rt√©nt a be√°ll√≠t√°sok ment√©se sor√°n!");
            }
        }
    }

    document.addEventListener("DOMContentLoaded", () => {
        console.log("DOMContentLoaded started"); // Debug log
        window.app = new BerszamfejtoApp(); // Glob√°lis v√°ltoz√≥k√©nt t√°roljuk
    });
        // Service Worker regisztr√°l√°sa
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('/naptar/service-worker.js', {
                scope: '/naptar/'
            })
            .then(registration => {
                console.log('ServiceWorker regisztr√°lva:', registration);
            })
            .catch(error => {
                console.log('ServiceWorker regisztr√°l√°si hiba:', error);
            });
        });
    }
    </script>
</body>
</html>
