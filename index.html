<!DOCTYPE html>
<html lang="hu">
<head>
    <!-- További favicon támogatás különböző eszközökhöz -->
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
    <meta charset="UTF-8" />
    <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <link rel="manifest" href="manifest.json" crossorigin="use-credentials">
    <link rel="icon" type="image/png" href="./icon.png">
    <title>Műszak Naptár</title>
    <style>
    * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
        touch-action: manipulation;
    }

    body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
        sans-serif;
        background-color: #f4f4f4;
        height: 100vh;
        display: flex;
        flex-direction: column;
        padding-top: 100px;
    }

    #navbar {
        background-color: #000;
        color: white;
        display: flex;
        width: 100%;
        height: 90px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        position: fixed;
        top: 0;
        left: 0;
        z-index: 1000;
        justify-content: space-between;
        padding: 0 5px;
        gap: 2px;
    }
    
    #navbar button {
        background-color: transparent;
        border: none;
        color: white;
        height: 90px;
        font-size: 16px;
        padding: 0 10px;
        white-space: nowrap;
        display: flex;
        align-items: center;
        justify-content: center;
        flex: 0 1 auto;
    }
    
    #calendar-btn {
        flex: 1.2;
    }
    
    #payroll-btn {
        flex: 1.5;
    }
    
    #settings-btn {
        flex: 1.3;
    }
    
    #help-btn {
        flex: 0.8;
    }


    .section {
        display: none;
    }

    .section.active {
        display: block;
    }

    #content {
    width: 100%;
    box-sizing: border-box;
    height: calc(100vh - 90px);
    overflow-y: auto;
    }

    #calendar-header {
        display: flex;
        flex-shrink: 0;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
    }

    #calendar-header button {
        background-color: #000;
        color: white;
        border: none;
        margin: 5px;
        padding: 10px 15px;
        font-size: 30px;
        border-radius: 5px;
    }

    #current-month {
        font-size: 30px;
        margin: 0;
    }

    #current-payroll-month {
        font-size: 30px;
        margin: 0;   
    }

    #calendarTable {
        flex-grow: 1;
        min-height: 80%;
        height: 85%;
        width: 100%;
        border-collapse: collapse;
        table-layout: fixed;
        margin-bottom: 0;
    }

    #calendarTable th {
        border: 3px groove #000;
        border-radius: 10px;
        padding: 1px;
        text-align: center;
        vertical-align: center;
        height: 40px;
        width: 14.28571%;   
    }
    #calendarTable td {
        border: 3px groove #ddd;
        border-radius: 10px;
        padding: 1px;
        text-align: center;
        vertical-align: top;
        height: 80px;
        width: 14.28571%;
    }

    .date-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        height: 100%;
        width: 100%;
        user-select: none;
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
    }

    .date-number {
        font-weight: bold;
        margin: 3px 3px;
        font-size: 10px;
        color: #333;
        width: 30px;
        height: 40px;
        background-color: #f0f0f0;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        align-self: center;
    }

    /* Színbeállítások stílusai */
    .color-row {
        display: flex;
        align-items: center;
        margin: 10px 0;
        padding: 10px;
        background-color: #f5f5f5;
        border-radius: 8px;
        min-width: 0; /* Flexbox túlcsordulás megakadályozása */
        flex-wrap: wrap; /* Mobilon tördelés engedélyezése */
        gap: 10px; /* Elemek közötti távolság */
    }

    .color-row span {
        width: 33.3%;
        margin-right: 10px;
    }

    .color-buttons {
        display: flex;
        flex: 1;
        gap: 10px;
        min-width: 0; /* Flexbox túlcsordulás megakadályozása */
    }
    
    .color-picker {
        flex: 1;
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        background: white;
        cursor: pointer;
        min-width: 0; /* Flexbox túlcsordulás megakadályozása */
        white-space: nowrap; /* Szöveg egy sorban tartása */
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .color-picker:hover {
        background: #f0f0f0;
    }

    .color-preview {
        width: 100%;
        max-width: 120px; /* Maximum szélesség megadása */
        min-width: 80px; /* Minimum szélesség megadása */
        height: 50px;
        border: 1px solid #ddd;
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        text-align: center;
        padding: 4px;
        font-size: 12px;
        font-weight: bold;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        flex-shrink: 0; /* Megakadályozza a zsugorodást */
    }

    @media (max-width: 480px) {
        .color-row {
            padding: 8px;
        }
    
        .color-preview {
            width: 100%;
            max-width: none;
            margin-bottom: 5px;
        }
    
        .color-buttons {
            width: 100%;
            flex-direction: row;
        }
    
        .color-picker {
            padding: 6px 8px;
            font-size: 14px;
        }
    }

    /* Alapértelmezett színek a preview-khoz */
    .nappal-preview {
        background-color: #ffd700;
        color: black;
    }

    .ejszaka-preview {
        background-color: #4169e1;
        color: white;
    }

    .szabadsag-preview {
        background-color: #09fd00;
        color: black;
    }

    .tulora-preview {
        background-color: #ff0000;
        color: white;
    }

    .csuszo-preview {
        background-color: #dda0dd;
        color: black;
    }

    .tappenz-preview {
        background-color: #000000;
        color: white;
    }

    /* Hétvégék kiemelése */
    #calendarTable tr td:nth-child(6),
    #calendarTable tr td:nth-child(7) {
        background-color: #f9f9f9;
    }

    /* Ünnepnapok piros színnel */
    .holiday {
        background-color: #ff5353 !important; /* Halvány piros */
        border-radius: 0 !important;
    }
    
    .holiday .date-number {
        color: #ff0000 !important; /* Sötétpiros szöveg */
        font-weight: bold;
    }

    #calendar-section {
        touch-action: pan-y;
        flex-grow: 1;
        height: 100%;
        display: flex;
        flex-direction: column;
    }

    .mobile-button {
        display: block;
        width: 100%;
        padding: 15px;
        margin: 10px 0;
        background-color: #fff;
        color: black;
        border: black 1px solid;
        border-radius: 5px;
        font-size: 16px;
        text-align: center;
    }

    /* Beállítások szekció stílusai */
    #settings-section {
        padding: 20px;
        text-align: center;
    }

    .settings-group {
        display: flex;
        align-items: center;
        justify-content: space-between;
        width: 100%;
        padding: 10px 0;
      }
      
    .settings-group > * {
        flex: 1;
    }

    /* Új stílusok a settings szekcióhoz */
    .settings-content {
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
    }

    .flex-row {
        display: flex;
        gap: 10px;
        margin-bottom: 10px;
    }

    .flex-row > * {
        flex: 1;
    }

    .checkbox-container {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 10px;
        padding: 10px;
        background: #f5f5f5;
        border-radius: 5px;
    }

    .midyear-change-container {
        display: flex;
        align-items: center;
        justify-content: space-between;
        width: 100%;
      }
      
      .midyear-change-container > * {
        flex: 1;
      }

    #settings-header {
        font-size: 30px;
        margin: 0;
    }

    #settings-header button {
        background-color: #000;
        color: white;
        border: none;
        padding: 10px 15px;
        font-size: 24px;
        border-radius: 5px;
    }

    .midyear-change-item {
        background: white;
        padding: 10px;
        margin-top: 10px;
        border-radius: 5px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        width: 100%;
    }

    #color-settings {
        max-width: 100%;
        overflow-x: hidden; /* Vízszintes görgetés megakadályozása */
        padding: 15px;
        background-color: white;
        border: 1px solid black;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    /* Alap stílusok minden shift-select elemre */
    .shift-select {
        width: 100%;
        font-size: 10px;
        padding: 0px;
        margin-top: 3px;
        border: 1px solid #ddd;
        border-radius: 4px;
        height: 100%;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: wrap;
        cursor: pointer;
        text-align: center;
        word-break: break-all;
    }

    select.shift-select {
        appearance: menulist;
        -webkit-appearance: menulist;
        -moz-appearance: menulist;
    }

    div.shift-select {
        display: flex;
        align-items: center;
        justify-content: center;
    }


    .shift-select-modal {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 80%;
        max-width: 400px;
        max-height: 80vh; /* Maximum magasság a viewport 80%-a */
        background-color: white;
        border: 2px solid #4a90e2;
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        z-index: 1000;
        overflow-y: auto; /* Görgetés engedélyezése */
        -webkit-overflow-scrolling: touch; /* Jobb görgetés mobilon */
    }

    /* Opcionális: görgetősáv stílusa */
    .shift-select-modal::-webkit-scrollbar {
        width: 8px;
    }

    .shift-select-modal::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 4px;
    }

    .shift-select-modal::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 4px;
    }

    .shift-select-modal::-webkit-scrollbar-thumb:hover {
        background: #555;
    }

    .shift-select-modal select {
        width: 100%;
        font-size: 16px;
        padding: 10px;
        margin-bottom: 7px;
    }

    .shift-select-modal button {
        font-size: 14px; /* Nagyobb betűméret a modal gomboknak */
        padding: 12px; /* Több padding */
    }

    .shift-select-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 999;
    }

    #payroll-table {
        width: 100%;
        border-collapse: collapse;
    }

    #payroll-table th,
    #payroll-table td {
        border: 5px groove #000;
        padding: 8px;
        text-align: left;
        font-weight: bold;
    }

    #payroll-table tr:nth-child(even) {
        background-color: #f2f2f2;
    }

    #payroll-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
    }

    #payroll-header button {
        background-color: #000;
        color: white;
        border: none;
        margin: 5px;
        padding: 10px 15px;
        font-size: 30px;
        border-radius: 5px;
    }

    .w-24 {
        width: 6rem;
    }

    .text-right {
        text-align: right;
    }

    .px-2 {
        padding-left: 0.5rem;
        padding-right: 0.5rem;
    }

    .py-1 {
        padding-top: 0.25rem;
        padding-bottom: 0.25rem;
    }

    .border {
        border: 1px solid #e2e8f0;
    }

    .rounded {
        border-radius: 0.25rem;
    }

    /* Input mező stílusok */
    #payroll-body input[type="number"] {
        border: 1px solid #e2e8f0;
        padding: 4px 8px;
        font-size: 16px;
        font-weight: bold;
        width: 100px;
        text-align: center;
    }

    #payroll-body input[type="number"]:focus {
        outline: none;
        border-color: #4a90e2;
        box-shadow: 0 0 0 2px rgba(74, 144, 226, 0.2);
    }

    salary-container {
      position: relative;
      display: flex;
      align-items: center;
      width: 100%;
    }
    
    .salary-input {
      width: 100%;
      transition: all 0.3s ease;
    }
    
    .visibility-toggle {
      position: absolute;
      right: 10px;
      background: none;
      border: none;
      cursor: pointer;
      padding: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 40px;
      height: 40px;
      transition: transform 0.3s ease;
    }
    
    .visibility-toggle:active {
      transform: scale(0.9);
    }
    
    @keyframes fadeMask {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    .masked-value {
      animation: fadeMask 0.3s ease;
    }

    @keyframes slideInRight {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
    
    @keyframes slideInLeft {
        from {
            transform: translateX(-100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
    
    @keyframes slideOutRight {
        from {
            transform: translateX(0);
            opacity: 1;
        }
        to {
            transform: translateX(100%);
            opacity: 0;
        }
    }
    
    @keyframes slideOutLeft {
        from {
            transform: translateX(0);
            opacity: 1;
        }
        to {
            transform: translateX(-100%);
            opacity: 0;
        }
    }
    
    #calendar-section, #payroll-section {
        position: relative;
        overflow: hidden;
    }
    
    #calendar-body, #payroll-body {
        animation-duration: 0.2s;
        animation-fill-mode: both;
    }
    
    .slide-in-right {
        animation-name: slideInRight;
    }
    
    .slide-in-left {
        animation-name: slideInLeft;
    }
    
    .slide-out-right {
        animation-name: slideOutRight;
    }
    
    .slide-out-left {
        animation-name: slideOutLeft;
    }

    @keyframes slideYearInRight {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
    
    @keyframes slideYearInLeft {
        from {
            transform: translateX(-100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
    
    @keyframes slideYearOutRight {
        from {
            transform: translateX(0);
            opacity: 1;
        }
        to {
            transform: translateX(100%);
            opacity: 0;
        }
    }
    
    @keyframes slideYearOutLeft {
        from {
            transform: translateX(0);
            opacity: 1;
        }
        to {
            transform: translateX(-100%);
            opacity: 0;
        }
    }
    
    #settings-content {
        position: relative;
        overflow: hidden;
    }
    
    .slide-year-in-right {
        animation: slideYearInRight 0.2s forwards;
    }
    
    .slide-year-in-left {
        animation: slideYearInLeft 0.2s forwards;
    }
    
    .slide-year-out-right {
        animation: slideYearOutRight 0.2s forwards;
    }
    
    .slide-year-out-left {
        animation: slideYearOutLeft 0.2s forwards;
    }
        
    </style>
</head>
<body>
    <div id="navbar">
    <button id="calendar-btn">Naptár</button>
    <button id="payroll-btn">Bérszámfejtés</button>
    <button id="settings-btn">Beállítások</button>
    <button id="help-btn">Súgó</button>
    </div>

    <div id="content">
    <div id="calendar-section" class="section active">
        <div id="calendar-header">
        <button id="prev-month-btn">←</button>
        <h2 id="current-month">Január 2024</h2>
        <button id="next-month-btn">→</button>
        </div>
        <table id="calendarTable">
        <thead>
            <tr>
            <th>H</th>
            <th>K</th>
            <th>SZE</th>
            <th>CS</th>
            <th>P</th>
            <th>SZO</th>
            <th>V</th>
            </tr>
        </thead>
        <tbody id="calendar-body">
            <!-- Naptár tartalma ide generálódik -->
        </tbody>
        </table>
    </div>

    <div id="payroll-section" class="section">
        <div id="payroll-header">
        <button id="prev-payroll-month-btn">←</button>
        <h2 id="current-payroll-month">Január 2024</h2>
        <button id="next-payroll-month-btn">→</button>
        </div>
        <div id="payroll-content">
        <table id="payroll-table">
            <thead>
            <tr>
                <th>Tétel</th>
                <th>Érték</th>
            </tr>
            </thead>
            <tbody id="payroll-body">
            <!-- Ide generálódnak a bérszámfejtési tételek -->
            </tbody>
        </table>
        </div>
    </div>

    <div id="settings-section" class="section">
        <!-- Fejléc az év váltáshoz -->
        <div
        id="settings-header"
        style="
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        "
        >
        <button
            id="prev-settings-year-btn"
            style="
            background-color: #000;
            color: white;
            border: none;
            padding: 10px 15px;
            font-size: 40px;
            margin-left: -10px;
            border-radius: 5px;
            "
        >
            ←
        </button>
        <h2 id="current-settings-year"></h2>
        <button
            id="next-settings-year-btn"
            style="
            background-color: #000;
            color: white;
            border: none;
            padding: 10px 15px;
            font-size: 30px;
            margin-right: -10px;
            border-radius: 5px;
            "
        >
            →
        </button>
        </div>

        <!-- Műszakrend -->
        <div class="setting-group">
        <h3>Műszakrend</h3>
        <select id="shift-pattern-select" class="mobile-button">
            <option value="1">1. Műszakrend</option>
            <option value="2">2. Műszakrend</option>
            <option value="3">3. Műszakrend</option>
            <option value="4">4. Műszakrend</option>
            <option value="A">A Műszakrend</option>
            <option value="B">B Műszakrend</option>
            <option value="C">C Műszakrend</option>
        </select>
        </div>

        <!-- Besorolási bér -->
        <div class="setting-group">
        <h3>Besorolási bér</h3>
        <div style="position: relative;">
            <input
                type="number"
                id="base-salary"
                class="mobile-button salary-input"
                placeholder="Besorolási bér"
                style="padding-right: 45px;"
            />
        </div>
        <div class="setting-group">
            <h3>Éves szabadság</h3>
            <input type="number" id="vacation-days" class="mobile-button" placeholder="Éves szabadságnapok">
        </div>

        <!-- Évközi változás -->
        <div style="margin-top: 10px">
            <h3>Évközi bérváltozás beállítása</h3>
            <select
            id="midyear-month"
            class="mobile-button"
            style="width: 65%; display: inline-block"
            >
            <option value="">Válassz hónapot...</option>
            <option value="0">Január</option>
            <option value="1">Február</option>
            <option value="2">Március</option>
            <option value="3">Április</option>
            <option value="4">Május</option>
            <option value="5">Június</option>
            <option value="6">Július</option>
            <option value="7">Augusztus</option>
            <option value="8">Szeptember</option>
            <option value="9">Október</option>
            <option value="10">November</option>
            <option value="11">December</option>
            </select>
            <input
            type="number"
            id="midyear-salary"
            class="mobile-button"
            placeholder="Új besorolási bér"
            style="width: 65%; display: inline-block"
            />
        </div>
        <button id="add-midyear-change" class="mobile-button">
            Évközi változás hozzáadása
        </button>
        <div id="midyear-changes-list" style="margin-top: 10px"></div>
        </div>

        <div class="setting-group">
            <h3>Családi adókedvezmény</h3>
            <input type="number" id="children-count" class="mobile-button" placeholder="Gyermekek száma" min="0" max="99"/>
        </div>

        <!-- Egyéb jövedelem -->
        <div class="setting-group">
        <h3>Egyéb jövedelem</h3>
        <input
            type="number"
            id="other-income"
            class="mobile-button"
            placeholder="Egyéb jövedelem"
        />
        </div>

        <!-- 25 év alatti kedvezmény -->
        <div class="setting-group">
        <h3>25 év alatti kedvezmény</h3>
        <div style="margin-bottom: 10px">
            <input
            type="checkbox"
            id="under25-checkbox"
            style="margin-right: 10px"
            />
            <label for="under25-checkbox">25 év alatti vagyok</label>
        </div>
        <div id="birth-date-container" style="display: none">
            <input
            type="number"
            id="birth-year"
            class="mobile-button"
            placeholder="Születési év"
            style="width: 49%; display: inline-block"
            />
            <select
            id="birth-month"
            class="mobile-button"
            style="width: 49%; display: inline-block"
            >
            <option value="">Születési hónap</option>
            <option value="1">Január</option>
            <option value="2">Február</option>
            <option value="3">Március</option>
            <option value="4">Április</option>
            <option value="5">Május</option>
            <option value="6">Június</option>
            <option value="7">Július</option>
            <option value="8">Augusztus</option>
            <option value="9">Szeptember</option>
            <option value="10">Október</option>
            <option value="11">November</option>
            <option value="12">December</option>
            </select>
        </div>
        </div>

        <!-- Színbeállítások -->
        <div class="setting-group">
        <h3>Színbeállítások</h3>
        <div id="color-settings">
            <!-- Nappali műszak -->
            <div class="color-row">
            <div class="color-preview nappal-preview">Nappal</div>
            <div class="color-buttons">
                <button
                class="color-picker"
                data-shift-type="nappal"
                data-color-type="bg"
                >
                Háttérszín
                </button>
                <button
                class="color-picker"
                data-shift-type="nappal"
                data-color-type="text"
                >
                Szövegszín
                </button>
            </div>
            </div>

            <!-- Éjszakai műszak -->
            <div class="color-row">
            <div class="color-preview ejszaka-preview">Éjszaka</div>
            <div class="color-buttons">
                <button
                class="color-picker"
                data-shift-type="ejszaka"
                data-color-type="bg"
                >
                Háttérszín
                </button>
                <button
                class="color-picker"
                data-shift-type="ejszaka"
                data-color-type="text"
                >
                Szövegszín
                </button>
            </div>
            </div>

            <!-- Szabadság -->
            <div class="color-row">
            <div class="color-preview szabadsag-preview">Szabadság</div>
            <div class="color-buttons">
                <button
                class="color-picker"
                data-shift-type="szabadsag"
                data-color-type="bg"
                >
                Háttérszín
                </button>
                <button
                class="color-picker"
                data-shift-type="szabadsag"
                data-color-type="text"
                >
                Szövegszín
                </button>
            </div>
            </div>

            <!-- Túlóra -->
            <div class="color-row">
            <div class="color-preview tulora-preview">Túlóra</div>
            <div class="color-buttons">
                <button
                class="color-picker"
                data-shift-type="tulora"
                data-color-type="bg"
                >
                Háttérszín
                </button>
                <button
                class="color-picker"
                data-shift-type="tulora"
                data-color-type="text"
                >
                Szövegszín
                </button>
            </div>
            </div>

            <!-- Csúszó -->
            <div class="color-row">
            <div class="color-preview csuszo-preview">Csúszó</div>
            <div class="color-buttons">
                <button
                class="color-picker"
                data-shift-type="csuszo"
                data-color-type="bg"
                >
                Háttérszín
                </button>
                <button
                class="color-picker"
                data-shift-type="csuszo"
                data-color-type="text"
                >
                Szövegszín
                </button>
            </div>
            </div>

            <!-- Táppénz -->
            <div class="color-row">
            <div class="color-preview tappenz-preview">Táppénz</div>
            <div class="color-buttons">
                <button
                class="color-picker"
                data-shift-type="tappenz"
                data-color-type="bg"
                >
                Háttérszín
                </button>
                <button
                class="color-picker"
                data-shift-type="tappenz"
                data-color-type="text"
                >
                Szövegszín
                </button>
            </div>
            </div>
        </div>
        </div>

        <!-- Mentés gomb --> 
        <button id="save-settings" class="mobile-button">Mentés</button>
    </div>

    <div id="help-section" class="section">
    <div style="margin: 15px; text-align: left; padding: 15px; line-height: 1.6;">
        <h3>A program használata:</h3>
        
        <h4>Év választó:</h4>
        <p>Az aktuálisan kiválasztott év Naptár, Bérszámfejtés és Beállításai fognak megjelenni mindig. Ha egy másik évet szeretnél szerkeszteni, akkor az Év választóban csak válaszd ki az új évet.</p>
        
        <h4>Beállítások:</h4>
        <ol>
            <li><strong>Besorolási bér:</strong> Ebből az adatból fogja kiszámolni a program mennyit keresel a hónapban.</li>
            <li><strong>Éves szabadság:</strong> Ide az éves szabadságodat kell beírni (pl. 25). A bérszámfejtésben nyomon tudod követni, mennyi szabadságod marad a hónap végén.</li>
            <li><strong>Műszakrend (1-2-3-4-A-B-C):</strong> A program a kiválasztott műszakrend szerint elkészíti a műszakrendet a kiválaszott évre. Hogyha új műszakrendet adsz meg, akkor az törölni fogja a Naptárba bevitt adatokat például Szabadság, Túlóra stb. ezért újra be kell őket írni.</li>
            <li><strong>Egyéb jövedelmek:</strong> Ide írhatod az olyan jövedelmeket mint például a gyerekek után járó kedvezmény. Fontos hogy nettóban írd be az összeget. Ha csak a bruttót tudod, akkor azt az értéket például 50.000, szorozd meg 0,665-el és így megkapod a nettó értéket. Ha nem tudod mennyi a Bruttó és a Nettó sem, akkor érdemes az interneten kutatni.</li>
            <li><strong>25 év alatti kedvezmény:</strong> Ha bepipálod akkor meg kell adnod a születési éved és hónapod, a program eszerint fogja a kedvezményt megadni. Minden évben meg kell adni. A 2026-os évre előre nem lehet tudni mennyi lesz a kedvezmény, úgyhogy a 2025-ös évet használja a program.</li>
            <li><strong>Év közbeni besorolási bér változás:</strong> Ha év közben új besorolási bért kapsz, akkor azt ide kell beírnod és attól a hónaptól kezdve amit kiválasztasz, a program már az új béreddel fog számolni. Az eredeti besorolási bért NE változtasd meg, illetve figyelj oda hogy a megfelelő év van kiválasztva.</li>
        </ol>

        <h4>Naptár:</h4>
        <ol>
            <li>A Naptárt a műszakrend szerint a program elkészíti, amit utána bármikor módosíthatsz.</li>
            <li><strong>FONTOS</strong> hogy a megfelelő adat legyen kiválasztva, tehát ha Éjszakás vagy és szabadságra mész, akkor a Szabadság éjszaka opciók közül kell választanod és ugyanígy mindenhol ahol ilyen opció van.</li>
            <li>Ha rossz adatokat választasz ki, akkor a program nem fog pontosan számolni. (Szabadság, Túlóra, Csúszó)</li>
            <li>Nem mindegy hogyműszakot csúszol le, vagy pedig a túlóra keretedből veszel el. Ha csak műszakot csúszol vagy műszakot cserélsz, akkor az eredeti műszakodat töröld ki és az új dátum helyére add meg a műszakot.</li>
            <li>Ha a túlóra keretedből veszel el, akkor kell használni a "Csúszó" adatokat. Itt is odafigyelve hogy éjszaka vagy sima nappal. Ha kombinálod a Csúszót és a Szabadságot, akkor csak a Szabadságot kell kiválasztani. Példa: 8 óra szabadság + 4 óra Csúszó, akkor csak a Szabadság 8 óra adatot kell kiválasztani.</li>
        </ol>

        <h4>Bérszámfejtési Számítások Magyarázata:</h4>
        <p>A program a Naptárba és a Beállításokba bevitt adatok alapján dolgozik, kivével a Bónusz(0,1 vagy 2) és az Éttermi fogyasztást. Ezeket kézzel kell beírni minden hónapban(és évben). Mindig ellenőrizd hogy meg-e volt mindkét bónuszod, mivel ha már az egyik nem volt meg, akkor az már könnyen meglátszódik a nettó béren.</p>
        <div style="background-color: #fff3cd; color: #856404; padding: 15px; border: 1px solid #ffeeba; border-radius: 5px; margin-bottom: 20px;">
            <h4 style="color: #856404; margin-top: 0;">Figyelmeztetés!</h4>
            <p>Ez a program kizárólag tájékoztató jellegű számításokat végez. A programban szereplő számítások és eredmények nem tekinthetők hivatalos bérszámfejtésnek. A program használata saját felelősségre történik. Eltérés esetén először bizonyosodj meg hogy valóban hiba történt és nem a program nem jó használata miatt történt hiba. A program hibázhat, ezt mindig vedd figyelembe.</p>
        </div>
    </div>
    </div>
    </div>

    <script>
    let app;

    function initSalaryVisibility() {
        const salaryInput = document.getElementById('base-salary');
        const toggleButton = document.createElement('button');
        toggleButton.id = 'toggle-salary-visibility';
        toggleButton.className = 'visibility-toggle';
        toggleButton.innerHTML = '👁️‍🗨️';
        let isVisible = false;
        let originalValue = salaryInput?.value || '';
        let hideTimeout;
    
        // CSS animációk
        const style = document.createElement('style');
        style.textContent = `
            .salary-input {
                transition: opacity 0.3s ease-in-out;
            }
            .salary-fade {
                opacity: 0.5;
            }
            .visibility-toggle {
                transition: transform 0.2s ease;
            }
            .visibility-toggle:active {
                transform: translateY(-50%) scale(0.9);
            }
        `;
        document.head.appendChild(style);
    
        // Stílusok beállítása
        toggleButton.style.cssText = `
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            padding: 15px;
            font-size: 24px;
            z-index: 10;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        `;
    
        // Érték maszkolása
        const maskValue = (value) => '•'.repeat(String(value).length);
    
        // Érték megjelenítés kezelése
        const updateInputVisibility = () => {
            if (isVisible) {
                salaryInput.type = 'number';
                salaryInput.value = originalValue;
            } else {
                // Először állítsuk be text típusúra
                salaryInput.type = 'text';
                // Majd maszkoljuk az értéket
                salaryInput.value = maskValue(originalValue);
            }
        };
    
        if (salaryInput) {
            salaryInput.parentElement.style.position = 'relative';
            salaryInput.style.paddingRight = '45px';
            salaryInput.parentElement.appendChild(toggleButton);
    
            // Kezdeti állapot beállítása
            updateInputVisibility();
    
            // Input eseménykezelő
            salaryInput.addEventListener('input', function(e) {
                clearTimeout(hideTimeout);
                if (this.type === 'number') {
                    originalValue = this.value;
                    
                    if (!isVisible) {
                        hideTimeout = setTimeout(() => {
                            this.type = 'text';
                            this.value = maskValue(originalValue);
                        }, 1500);
                    }
                }
            });
    
            // Láthatóság váltás kezelése
            const toggleVisibility = (e) => {
                e.preventDefault();
                e.stopPropagation();
                
                isVisible = !isVisible;
                clearTimeout(hideTimeout);
                
                updateInputVisibility();
                toggleButton.innerHTML = isVisible ? '👁️' : '👁️‍🗨️';
            };
    
            // Touch és click események
            toggleButton.addEventListener('touchstart', toggleVisibility, { passive: false });
            toggleButton.addEventListener('touchend', (e) => {
                e.preventDefault();
                e.stopPropagation();
            }, { passive: false });
            toggleButton.addEventListener('click', toggleVisibility);
    
            // Focus események
            salaryInput.addEventListener('focus', function() {
                clearTimeout(hideTimeout);
                if (!isVisible) {
                    this.type = 'number';
                    this.value = originalValue;
                }
            });
    
            salaryInput.addEventListener('blur', function() {
                if (!isVisible) {
                    originalValue = this.value;
                    this.type = 'text';
                    this.value = maskValue(originalValue);
                }
            });
        }
    
        return {
            getValue: () => originalValue,
            setValue: (value) => {
                originalValue = value;
                if (salaryInput) {
                    if (!isVisible) {
                        salaryInput.type = 'text';
                        salaryInput.value = maskValue(value);
                    } else {
                        salaryInput.type = 'number';
                        salaryInput.value = value;
                    }
                }
            }
        };
    }
    
    const SHIFT_COLORS = {
        Nappal: ["#FFD700", "black"],
        Éjszaka: ["#4169E1", "white"],
        Szabadság: ["#09fd00", "black"],
        Túlóra: ["#FF0000", "white"],
        Csúszó: ["#DDA0DD", "black"],
        Táppénz: ["#000000", "white"],
    };

    const MINIMUM_WAGE = {
        2024: 266800,
        2025: 290812,
        2026: 328618,
        2027: 374624,
    };

    function normalizeKey(key) {
        return key
        .toLowerCase()
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "");
    }

    // Az ablak validateBonus függvényének javítása
    window.validateBonus = function(entry, monthIndex) {
        try {
            let bonus = entry.value === "" ? 2 : parseInt(entry.value);
            
            // Érték korlátozása 0 és 2 közé
            if (isNaN(bonus) || bonus < 0) {
                bonus = 0;
            } else if (bonus > 2) {
                bonus = 2;
            }
            
            // Az input mező értékének frissítése
            entry.value = bonus.toString();
            
            // Ellenőrizzük és inicializáljuk az évet és a bonusEntries objektumot
            const currentYear = window.app.currentPayrollYear;
            if (!window.app.yearlyData[currentYear]) {
                window.app.yearlyData[currentYear] = {
                    settings: {
                        besorolasi_ber: "300000",
                        szabadsag: "25",
                        muszakrend: "1",
                        other_income: "0",
                        under25: {
                            enabled: false,
                            birthYear: "",
                            birthMonth: ""
                        },
                        midyear_changes: []
                    },
                    calendar_data: {},
                    bonusEntries: {},
                    restaurantEntries: {}
                };
            }

            // Inicializáljuk a bonusEntries objektumot, ha nem létezik
            if (!window.app.yearlyData[currentYear].bonusEntries) {
                window.app.yearlyData[currentYear].bonusEntries = {};
            }
            
            // Frissítjük a bonusEntries értékét
            window.app.yearlyData[currentYear].bonusEntries[monthIndex] = bonus;
            
            // Újraszámoljuk a kapcsolódó értékeket
            window.app.generatePayrollTable();
            window.app.saveYearlyData();
            
            return true;
        } catch (error) {
            console.error("Bónusz validálási hiba:", error);
            return false;
        }
    };

    // Az ablak validateRestaurant függvényének javítása
    window.validateRestaurant = function(entry, monthIndex) {
        try {
            const restaurant = entry.value === "" ? 0 : parseInt(entry.value);
            if (isNaN(restaurant) || restaurant < 0) {
                entry.value = "0";
                throw new Error("Az éttermi fogyasztás nem lehet negatív");
            }

            // Ellenőrizzük és inicializáljuk az évet és a restaurantEntries objektumot
            const currentYear = window.app.currentPayrollYear;
            if (!window.app.yearlyData[currentYear]) {
                window.app.yearlyData[currentYear] = {
                    settings: {
                        besorolasi_ber: "300000",
                        szabadsag: "25",
                        muszakrend: "1",
                        other_income: "0",
                        under25: {
                            enabled: false,
                            birthYear: "",
                            birthMonth: ""
                        },
                        midyear_changes: []
                    },
                    calendar_data: {},
                    bonusEntries: {},
                    restaurantEntries: {}
                };
            }

            // Inicializáljuk a restaurantEntries objektumot, ha nem létezik
            if (!window.app.yearlyData[currentYear].restaurantEntries) {
                window.app.yearlyData[currentYear].restaurantEntries = {};
            }

            // Frissítjük a restaurantEntries értékét
            window.app.yearlyData[currentYear].restaurantEntries[monthIndex] = restaurant;

            // Újraszámoljuk a kapcsolódó értékeket
            window.app.generatePayrollTable();
            window.app.saveYearlyData();

            return true;
        } catch (error) {
            console.error("Éttermi fogyasztás validálási hiba:", error);
            return false;
        }
    };

    class BerszamfejtoCalculator {
        constructor(app) {
            if (!app) {
                throw new Error("App must be provided to BerszamfejtoCalculator");
            }
            this.app = app;
            this.tavolletCache = new Map();
            this.MINIMUM_WAGE = {
                2024: 266800,
                2025: 290812,
                2026: 328618,
                2027: 374624,
                2028: 426160,
            };
        }

        isShiftType(shiftValue, type) {
        // Normalizáljuk a stringeket
        const normalizedShift = String(shiftValue || "")
            .toLowerCase()
            .trim();
        const normalizedType = type.toLowerCase().trim();

        // Rugalmas illeszkedés
        return normalizedShift.includes(normalizedType);
        }

        calculateEaster(year) {
            const a = year % 19;
            const b = Math.floor(year / 100);
            const c = year % 100;
            const d = Math.floor(b / 4);
            const e = b % 4;
            const f = Math.floor((b + 8) / 25);
            const g = Math.floor((b - f + 1) / 3);
            const h = (19 * a + b - d - g + 15) % 30;
            const i = Math.floor(c / 4);
            const k = c % 4;
            const l = (32 + 2 * e + 2 * i - h - k) % 7;
            const m = Math.floor((a + 11 * h + 22 * l) / 451);
            const month = Math.floor((h + l - 7 * m + 114) / 31) - 1;
            const day = ((h + l - 7 * m + 114) % 31) + 1;
            
            return new Date(year, month, day);
        }
    
        getHolidays(year) {
            try {
                // Fix ünnepnapok
                const fixedHolidays = [
                    { month: 0, day: 1 },    // Újév
                    { month: 2, day: 15 },   // Március 15.
                    { month: 4, day: 1 },    // Munka ünnepe
                    { month: 7, day: 20 },   // Államalapítás ünnepe
                    { month: 9, day: 23 },   // Október 23.
                    { month: 10, day: 1 },   // Mindenszentek
                    { month: 11, day: 25 },  // Karácsony
                    { month: 11, day: 26 }   // Karácsony másnapja
                ];
    
                // Húsvét és kapcsolódó ünnepek kiszámítása
                const easter = this.calculateEaster(year);
                
                // Nagypéntek (Húsvét vasárnap előtti péntek)
                const goodFriday = new Date(easter);
                goodFriday.setDate(easter.getDate() - 2);
                
                // Húsvétvasárnap
                const easterSunday = new Date(easter);
                
                // Húsvéthétfő
                const easterMonday = new Date(easter);
                easterMonday.setDate(easter.getDate() + 1);
                
                // Pünkösdhétfő (Húsvét után 50 nappal)
                const pentecostMonday = new Date(easter);
                pentecostMonday.setDate(easter.getDate() + 50);
    
                // Mozgó ünnepek hozzáadása
                const movingHolidays = [
                    { month: goodFriday.getMonth(), day: goodFriday.getDate() },           // Nagypéntek
                    { month: easterSunday.getMonth(), day: easterSunday.getDate() },       // Húsvétvasárnap
                    { month: easterMonday.getMonth(), day: easterMonday.getDate() },       // Húsvéthétfő
                    { month: pentecostMonday.getMonth(), day: pentecostMonday.getDate() }  // Pünkösdhétfő
                ];
    
                // Összes ünnep összefűzése
                const allHolidays = [...fixedHolidays, ...movingHolidays];
    
                return allHolidays;
            } catch (error) {
                console.error("Hiba az ünnepnapok meghatározása során:", error);
                return [];
            }
        }
    
        isHoliday(year, month, day) {
            try {
                const holidays = this.getHolidays(year);
                return holidays.some(
                    (holiday) => holiday.month === month && holiday.day === day
                );
            } catch (error) {
                console.error("Hiba az ünnepnap ellenőrzése során:", error);
                return false;
            }
        }

        calculateHolidayValue(year, month) {
        const holidays = this.getHolidays(year);
        let holidayValue = 0;
        let holidayCount = 0;

        holidays.forEach((holiday) => {
            if (holiday.month === month) {
            const calendarData = this.yearData.calendar_data[month] || {};
            const dayData = calendarData[holiday.day];

            if (
                dayData &&
                (dayData.includes("Nappal") || dayData.includes("Éjszaka"))
            ) {
                holidayValue += 12;
                holidayCount += 1;
            }
            }
        });

        return { holidayValue, holidayCount };
        }

        calculateChildTaxBenefit(childCount, date) {
            if (childCount <= 0) return 0;
            
            const currentDate = new Date(date);
            let benefitPerChild = 0;
            
            if (currentDate < new Date('2025-06-30')) {
                if (childCount === 1) benefitPerChild = 10000;
                else if (childCount === 2) benefitPerChild = 20000;
                else if (childCount >= 3) benefitPerChild = 33000;
            } 
            else if (currentDate < new Date('2026-01-01')) {
                if (childCount === 1) benefitPerChild = 15000;
                else if (childCount === 2) benefitPerChild = 30000;
                else if (childCount >= 3) benefitPerChild = 49500;
            }
            else {
                if (childCount === 1) benefitPerChild = 20000;
                else if (childCount === 2) benefitPerChild = 40000;
                else if (childCount >= 3) benefitPerChild = 66000;
            }
            
            return childCount * benefitPerChild;
        }

        getYearData(year) {
        if (year < 2024 || year > 2028) {
            throw new Error(`Érvénytelen év: ${year}`);
        }
        return this.app.yearlyData[year];
        }

        getMonthData(year, month) {
        const yearData = this.getYearData(year);
        return yearData.calendar_data[month] || {};
        }

        getEffectiveSalary(year, month) {
            try {
                // Érvényesítjük az évet
                if (year < 2024 || year > 2028) {
                    console.warn(`Érvénytelen év: ${year}, az alapértelmezett 2024 lesz használva`);
                    year = 2024;
                }
        
                const yearData = this.app.yearlyData[year];
                if (!yearData) {
                    console.warn(`Nem található adat a ${year} évre`);
                    return 300000; // Alapértelmezett érték
                }
        
                // Az alapbér lekérése
                const baseSalary = parseInt(yearData.settings?.besorolasi_ber) || 300000;
                
                // Évközi változások ellenőrzése
                if (yearData.settings?.midyear_changes?.length > 0) {
                    // Rendezzük a változásokat dátum szerint csökkenő sorrendbe
                    const sortedChanges = [...yearData.settings.midyear_changes]
                        .sort((a, b) => b.month - a.month);
        
                    // Keressük meg az első változást, ami a jelenlegi hónap előtt vagy abban történt
                    const applicableChange = sortedChanges.find(change => 
                        change.month <= month
                    );
        
                    if (applicableChange) {
                        console.log(`Évközi változás alkalmazva: ${applicableChange.salary} Ft (${year}.${month + 1})`);
                        return parseInt(applicableChange.salary);
                    }
                }

                return baseSalary;
                
            } catch (error) {
                console.error("Hiba az érvényes bér meghatározása során:", error);
                return 300000; // Alapértelmezett érték hiba esetén
            }
        }

        getTuloraOrak(monthIndex, year) {
            try {
                if (!this.app.yearlyData[year]?.calendar_data?.[monthIndex]) {
                    return { normal: 0, sunday: 0 };
                }
        
                const monthData = this.app.yearlyData[year].calendar_data[monthIndex];
                const pattern = this.app.yearlyData[year]?.settings?.muszakrend || "1";
                let normalOrak = 0;
                let vasarnapiOrak = 0;
        
                Object.entries(monthData).forEach(([day, shiftValue]) => {
                    if (shiftValue && shiftValue.includes("Túlóra")) {
                        const date = new Date(year, monthIndex, parseInt(day));
                        const isSunday = date.getDay() === 0;
                        let hours = 0;
        
                        // Órák meghatározása
                        if (shiftValue.includes("12 óra")) hours = 12;
                        else if (shiftValue.includes("8 óra")) hours = 8;
                        else if (shiftValue.includes("4 óra")) hours = 4;
        
                        // A-B-C műszakrend speciális kezelése
                        if (["A", "B", "C"].includes(pattern) && isSunday) {
                            vasarnapiOrak += hours;
                        } else {
                            normalOrak += hours;
                        }
                    }
                });
        
                return { normal: normalOrak, sunday: vasarnapiOrak };
            } catch (error) {
                console.error("Hiba a túlóra órák számításában:", error);
                return { normal: 0, sunday: 0 };
            }
        }

        calculateQuarterlyOvertime(year, monthIndex) {
    try {
        const startMonth = Math.floor(monthIndex / 3) * 3;
        const months = [startMonth, startMonth + 1, startMonth + 2];
        
        let totalWorkingDays = 0;
        let totalHavi8 = 0;
        let totalLedolgozottOrak = 0;
        let totalCsuszoHours = 0;

        months.forEach(month => {
            const monthData = this.app.yearlyData[year]?.calendar_data[month] || {};
            
            let monthWorkingDays = 0;
            Object.entries(monthData).forEach(([day, shiftValue]) => {
                if (!shiftValue) return;

                // Ledolgozott napok számolása
                if (shiftValue?.includes("Nappal") || 
                    shiftValue?.includes("Éjszaka") ||
                    shiftValue?.includes("Szabadság") ||
                    shiftValue?.includes("Csúszó") ||
                    shiftValue?.includes("Táppénz")) {
                    monthWorkingDays++;
                }

                // Ledolgozott órák számolása (csúszók nélkül)
                if (shiftValue?.includes("Nappal") || shiftValue?.includes("Éjszaka")) {
                    if (shiftValue.includes("12 óra")) {
                        totalLedolgozottOrak += 12;
                    } else if (shiftValue.includes("8 óra")) {
                        totalLedolgozottOrak += 8;
                    } else if (shiftValue.includes("4 óra")) {
                        totalLedolgozottOrak += 4;
                    }
                }
                
                // Csúszó órák számolása
                if (shiftValue?.includes("Csúszó")) {
                    if (shiftValue.includes("12 óra")) {
                        totalCsuszoHours += 12;
                    } else if (shiftValue.includes("8 óra")) {
                        totalCsuszoHours += 8;
                    } else if (shiftValue.includes("4 óra")) {
                        totalCsuszoHours += 4;
                    }
                }
            });
            
            totalWorkingDays += monthWorkingDays;
            const havi8 = this.calculateWorkingDays(year, month) * 8;
            totalHavi8 += havi8;
        });

        // Túlóra keret számítása:
        // 1. Először kiszámoljuk az összes ledolgozandó órát (12 órás műszakok)
        const totalRequiredHours = totalWorkingDays * 12;
        
        // 2. Kivonjuk belőle a havi 8 órás munkaidőt
        // 3. Kivonjuk a csúszó órákat
        const tuloraKeret = totalRequiredHours - totalHavi8 - totalCsuszoHours;
        
        console.log(`Túlóra keret számítás (${monthIndex + 1}. hónap):
            - 3 havi ledolgozandó napok: ${totalWorkingDays} (${totalRequiredHours} óra)
            - 3 havi havi8: ${totalHavi8} óra
            - Levont csúszó órák: ${totalCsuszoHours} óra
            - Túlóra keret: ${Math.max(0, tuloraKeret)} óra`);

        return Math.max(0, tuloraKeret);
    } catch (error) {
        console.error("Hiba a negyedéves túlóra számításában:", error);
        return 0;
    }
        }

        calculateWorkingDays(year, month) {
            try {
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const holidays = this.getHolidays(year);
                let workingDays = 0;
        
                for (let day = 1; day <= daysInMonth; day++) {
                    const date = new Date(year, month, day);
                    const dayOfWeek = date.getDay();
                    
                    // Csak hétköznapi napok (hétfő-péntek) vizsgálata
                    const isWeekday = dayOfWeek >= 1 && dayOfWeek <= 5;
                    
                    // Ünnepnap ellenőrzés
                    const isHoliday = holidays.some(
                        (h) => h.month === month && h.day === day
                    );
                    
                    // Hétvégi ünnepnapok kizárása
                    const isWeekendHoliday = isHoliday && (dayOfWeek === 0 || dayOfWeek === 6);
                    
                    // Csak hétköznapi nem hétvégi ünnepnapok számítása
                    if (isWeekday && isHoliday && !isWeekendHoliday) {
                        // Hétköznapi ünnepnap
                        workingDays += 0; // Nem számoljuk munkanapnak
                    } else if (isWeekday && !isHoliday) {
                        // Normál munkanap
                        workingDays += 1;
                    }
                }
        
                return workingDays;
            } catch (error) {
                console.error("Hiba a munkanapok számításánál:", error);
                return 0;
            }
        }

        calculateShiftValues(monthData, date) {
        try {
            const isWeekend = date.getDay() === 0;
            const isHoliday = this.isHoliday(
            date.getFullYear(),
            date.getMonth(),
            date.getDate()
            );

            return {
            isWeekend,
            isHoliday,
            shiftHours: this.getShiftHours(monthData),
            nightShiftHours: this.getNightShiftHours(monthData),
            weekendHours: isWeekend ? this.getWeekendHours(monthData) : 0,
            holidayHours: isHoliday ? this.getHolidayHours(monthData) : 0,
            };
        } catch (error) {
            console.error("Hiba a műszak értékek számításánál:", error);
            return {
            isWeekend: false,
            isHoliday: false,
            shiftHours: 0,
            nightShiftHours: 0,
            weekendHours: 0,
            holidayHours: 0,
            };
        }
        }

        calculateMonthlyValue(label, monthIndex, year) {
            try {
                // Érvényesítjük az évet
                if (!year || year < 2024 || year > 2028) {
                    console.warn(`Érvénytelen év: ${year}, alapértelmezett 2024 használata`);
                    year = 2024;
                }
        
                const yearData = this.app.yearlyData[year];
                const monthData = yearData.calendar_data[monthIndex] || {};
                
                // Az érvényes besorolási bér lekérése az adott hónapra
                const effectiveSalary = this.getEffectiveSalary(year, monthIndex);
                
                // Munkanapok számítása
                const workingDays = this.calculateWorkingDays(year, monthIndex);
                const havi8 = workingDays * 8;
        
                // Alapváltozók inicializálása
                let ledolgozando = 0;
                let ledolgozott = 0;
                let szabadsagOra = 0;
                let tappenzNapok = 0;
                let tulora100 = 0;
                let hetvegiPotlek50 = 0;
                let muszakPotlek40 = 0;
                let holidayCount = 0;
                let holidayValue = 0;
        
                // Napi értékek számítása
                Object.entries(monthData).forEach(([day, shiftValue]) => {
                    if (!shiftValue) return;
        
                    const date = new Date(year, monthIndex, parseInt(day));
                    const isWeekend = date.getDay() === 0 || date.getDay() === 6;
                    const isHoliday = this.isHoliday(year, monthIndex, parseInt(day));
        
                    // Ledolgozandó napok számítása
                    if (shiftValue.includes("Nappal") || 
                        shiftValue.includes("Éjszaka") ||
                        shiftValue.includes("Szabadság") ||
                        shiftValue.includes("Csúszó") ||
                        shiftValue.includes("Táppénz")) {
                        ledolgozando += 1;
                    }
        
                    // Ledolgozott napok számítása
                    if (shiftValue.includes("Nappal") || shiftValue.includes("Éjszaka") || shiftValue.includes("Csúszó")) {
                        ledolgozott += 1;
                    } else if (shiftValue.includes("Szabadság")) {
                        if (shiftValue.includes("12 óra")) {
                            ledolgozott += 0;
                        } else if (shiftValue.includes("8 óra")) {
                            ledolgozott += 1/3;
                        } else if (shiftValue.includes("4 óra")) {
                            ledolgozott += 2/3;
                        }
                    }
        
                    // Szabadság órák számítása
                    if (shiftValue.includes("Szabadság 12 óra") ||
                        shiftValue.includes("Szabadság éj 12 óra")) {
                        szabadsagOra += 12;
                    } else if (shiftValue.includes("Szabadság 8 óra") ||
                              shiftValue.includes("Szabadság éj 8 óra")) {
                        szabadsagOra += 8;
                    } else if (shiftValue.includes("Szabadság 4 óra") ||
                              shiftValue.includes("Szabadság éj 4 óra")) {
                        szabadsagOra += 4;
                    }
        
                    // Túlóra számítása
                    if (shiftValue.includes("Túlóra 12 óra") ||
                        shiftValue.includes("Túlóra éj 12 óra")) {
                        tulora100 += 12;
                    } else if (shiftValue.includes("Túlóra 8 óra") ||
                              shiftValue.includes("Túlóra éj 8 óra")) {
                        tulora100 += 8;
                    }
        
                    // Hétvégi pótlék számítása
                    if (isWeekend) {
                        if (shiftValue.includes("Nappal") ||
                            shiftValue.includes("Éjszaka")) {
                            hetvegiPotlek50 += 12;
                        } else if (shiftValue.includes("Szabadság 8 óra") ||
                                shiftValue.includes("Szabadság éj 8 óra") ||
                                   shiftValue.includes("Csúszó éj 8 óra") ||
                                  shiftValue.includes("Csúszó 8 óra")) {
                            hetvegiPotlek50 += 4;
                        } else if (shiftValue.includes("Szabadság 4 óra") ||
                                   shiftValue.includes("Szabadság éj 4 óra") ||
                                   shiftValue.includes("Csúszó éj 4 óra") ||
                                  shiftValue.includes("Csúszó 4 óra")) {
                            hetvegiPotlek50 += 8;
                        }
                    }
        
                    // Műszakpótlék számítása
                    if (shiftValue.includes("Éjszaka") ||
                        shiftValue.includes("Túlóra éj 12 óra")) {
                        muszakPotlek40 += 12;
                    } else if (shiftValue.includes("Túlóra éj 8 óra")) {
                        muszakPotlek40 += 8;
                    } else if (shiftValue.includes("Szabadság éj 4 óra") ||
                              shiftValue.includes("Csúszó éj 4 óra")) {
                        muszakPotlek40 += 8;
                    } else if (shiftValue.includes("Szabadság éj 8 óra") ||
                              shiftValue.includes("Csúszó éj 8 óra")) {
                        muszakPotlek40 += 4;
                    }
        
                    // Ünnepnap számítása
                    if (isHoliday) {
                        if (shiftValue.includes("Nappal") ||
                            shiftValue.includes("Éjszaka")) {
                            holidayCount += 1;
                            holidayValue += 12;
                        } else if (shiftValue.includes("Szabadság 12 óra") ||
                                  shiftValue.includes("Szabadság 8 óra")) {
                            holidayCount += 1/3;
                            holidayValue += shiftValue.includes("12 óra") ? 12 : 8;
                        } else if (shiftValue.includes("Szabadság 4 óra")) {
                            holidayCount += 2/3;
                            holidayValue += 4;
                        }
                    }
        
                    // Táppénz számítása
                    if (shiftValue.includes("Táppénz")) {
                        tappenzNapok += 1;
                    }
                });
        
                // Értékek visszaadása a label alapján
                switch (label) {
                    case "Ledolgozandó napok":
                        return ledolgozando;
                    case "Ledolgozott napok":
                        return ledolgozott;
                    case "Szabadság kivét (óra)":
                        return szabadsagOra;
                    case "Túlóra (100%)": {
                        if ((monthIndex + 1) % 3 === 0) {
                            const tuloraKeret = this.calculateQuarterlyOvertime(year, monthIndex);
                            return tulora100 + tuloraKeret;
                        }
                        return tulora100;
                    }
                    case "Hétvégi pótlék 50%": {
                        const monthData = this.app.yearlyData[year]?.calendar_data[monthIndex] || {};
                        let totalWeekendHours = 0;
                        const pattern = this.app.yearlyData[year]?.settings?.muszakrend;
                    
                        Object.entries(monthData).forEach(([day, shiftValue]) => {
                            if (!shiftValue) return;
                            const date = new Date(year, monthIndex, parseInt(day));
                            const isSunday = date.getDay() === 0;  // Csak vasárnapra ellenőrzünk
                    
                            if (isSunday) {  // Csak vasárnapi napokra számolunk
                                if (shiftValue.includes("Nappal") || shiftValue.includes("Éjszaka")) {
                                    totalWeekendHours += 12;
                                } else if (shiftValue.includes("Szabadság 8 óra") || 
                                          shiftValue.includes("Csúszó 8 óra") ||
                                          shiftValue.includes("Szabadság éj 8 óra") || 
                                          shiftValue.includes("Csúszó éj 8 óra")) {
                                    totalWeekendHours += 4;
                                } else if (shiftValue.includes("Szabadság 4 óra") || 
                                          shiftValue.includes("Csúszó 4 óra") ||
                                          shiftValue.includes("Szabadság éj 4 óra") || 
                                          shiftValue.includes("Csúszó éj 4 óra")) {
                                    totalWeekendHours += 8;
                                }
                    
                                // A-B-C műszakrendek esetén a vasárnapi túlórák hozzáadása
                                if (["A", "B", "C"].includes(pattern) && shiftValue.includes("Túlóra")) {
                                    if (shiftValue.includes("12 óra")) {
                                        totalWeekendHours += 12;
                                    } else if (shiftValue.includes("8 óra")) {
                                        totalWeekendHours += 8;
                                    } else if (shiftValue.includes("4 óra")) {
                                        totalWeekendHours += 4;
                                    }
                                }
                            }
                        });
                    
                        return totalWeekendHours;
                    }

                    case "Műszakpótlék 40%":
                        return muszakPotlek40;
                    case "Alapbér":
                        return ledolgozando > 0 ? (effectiveSalary / ledolgozando) * ledolgozott : 0;
                    case "Túlóra alap": {
                        const workingDays = this.calculateWorkingDays(year, monthIndex);
                        const havi8 = workingDays * 8;
                        const effectiveSalary = this.getEffectiveSalary(year, monthIndex);
                        const tuloraOrak = this.getTuloraOrak(monthIndex, year);
                        // Negyedéves túlóra keret számítása
    let tuloraKeret = 0;
    if ((monthIndex + 1) % 3 === 0) {
        tuloraKeret = this.calculateQuarterlyOvertime(year, monthIndex);
    }
                    
                        // A teljes túlóra óraszám figyelembe vétele
                        const osszTuloraOrak = tuloraOrak.normal + tuloraOrak.sunday + tuloraKeret;
                    
                        // Túlóra alapjának számítása a havi 8 óra alapján
                        const tuloraAlap = osszTuloraOrak > 0 
                            ? (effectiveSalary / havi8) * osszTuloraOrak 
                            : 0;
                    
                        return Math.round(tuloraAlap);
                    }
                    case "Szabadságra jutó fizetés":
                        return ledolgozando > 0 ? (effectiveSalary / (ledolgozando * 12)) * szabadsagOra : 0;
                    case "Távolléti díj":
                        return this.calculateTavolletDij(monthIndex, year);
                    case "Fizetett ünnepnap":
                        return ledolgozando > 0 ? (effectiveSalary / ledolgozando) * holidayCount : 0;
                    case "Túlórapótlék": {
                        const effectiveSalary = this.getEffectiveSalary(year, monthIndex);
                        const workingDays = this.calculateWorkingDays(year, monthIndex);
                        const havi8 = workingDays * 8;
                        const tuloraOrak = this.getTuloraOrak(monthIndex, year);
                        const pattern = this.app.yearlyData[year]?.settings?.muszakrend || "1";

                        
    // Negyedéves túlóra keret számítása
    let tuloraKeret = 0;
    if ((monthIndex + 1) % 3 === 0) {
        tuloraKeret = this.calculateQuarterlyOvertime(year, monthIndex);
    }
                    
                        // Normál túlórapótlék (100%)
                        const normalTulorapotlek = (effectiveSalary / 174) * (tuloraOrak.normal + tuloraKeret);
                    
                        // Vasárnapi túlórapótlék speciális kezelése A, B, C műszakrendnél
                        let vasarnapiTulorapotlek = 0;
                        if (["A", "B", "C"].includes(pattern)) {
                            // Vasárnapi túlóra 200%-os pótléka
                            vasarnapiTulorapotlek = (effectiveSalary / 174) * tuloraOrak.sunday * 2;
                        } else {
                            // Egyéb műszakrendek normál 100%-os pótléka
                            vasarnapiTulorapotlek = (effectiveSalary / 174) * tuloraOrak.sunday;
                        }
                    
                        return Math.round(normalTulorapotlek + vasarnapiTulorapotlek);
                    }
                    case "Hétvégi pótlék (50%)": {
                        const weekendHours = this.calculateMonthlyValue("Hétvégi pótlék 50%", monthIndex, year);
                        const effectiveSalary = this.getEffectiveSalary(year, monthIndex);
                        return Math.round((effectiveSalary / 174) * weekendHours * 0.5);
                    }
                    case "Műszakpótlék (40%)":
                        return (effectiveSalary / 174) * muszakPotlek40 * 0.4;
                        case "Teljesítmény prémium": {
                            const yearData = this.app.yearlyData[year];
                            const bonusValue = yearData.bonusEntries?.[monthIndex] || 0;
                            return effectiveSalary * 0.05 * bonusValue;
                        }
                    case "TB Járulék 18,5%": {
                        const bruttoBer = this.calculateMonthlyValue("Bruttó bér", monthIndex, year);
                        return Math.round(bruttoBer * 0.185);
                    }
        
                    case "Rendszeres SZJA előleg": {
                        const bruttoBer = this.calculateMonthlyValue("Bruttó bér", monthIndex, year);
                        return Math.round(bruttoBer * 0.15);
                    }

                    case "Családi adókedvezmény": {
                        const yearData = this.app.yearlyData[year];
                        const childCount = parseInt(yearData.settings.children_count || 0);
                        const date = new Date(year, monthIndex);
                        return this.calculateChildTaxBenefit(childCount, date);
                    }
        
                    case "Nettó": {
                        const yearData = this.app.yearlyData[year];
                        const bruttoBer = this.calculateMonthlyValue("Bruttó bér", monthIndex, year);
                        const otherIncome = parseFloat(yearData.settings.other_income || 0);
                        const restaurantEntry = yearData.restaurantEntries?.[monthIndex] || 0;
                        const under25Discount = this.app.calculateUnder25Discount(year, monthIndex, bruttoBer);
                        const childBenefit = this.calculateMonthlyValue("Családi adókedvezmény", monthIndex, year);
                        
                        const tbJarulek = this.calculateMonthlyValue("TB Járulék 18,5%", monthIndex, year);
                        const szja = this.calculateMonthlyValue("Rendszeres SZJA előleg", monthIndex, year);
                        
                        return Math.round(bruttoBer + under25Discount + otherIncome + childBenefit - tbJarulek - szja - restaurantEntry);
                    }                    
        
                    case "Megmaradt szabadságok": {
                        const yearData = this.app.yearlyData[year];
                        const totalVacationDays = parseInt(yearData.settings.szabadsag || 25);
                        
                        // Az év elejétől a jelenlegi hónapig összesítjük a szabadságokat
                        let totalUsedVacationHours = 0;
                        for (let i = 0; i <= monthIndex; i++) {
                            totalUsedVacationHours += this.calculateMonthlyValue("Szabadság kivét (óra)", i, year);
                        }
                        
                        // Órák átváltása napokra (8 órás munkanappal számolva)
                        const totalUsedVacationDays = totalUsedVacationHours / 8;
                        
                        // Megmaradt szabadságnapok
                        const remainingVacationDays = Math.max(0, totalVacationDays - totalUsedVacationDays);
                        
                        return Math.round(remainingVacationDays * 10) / 10; // Kerekítés 1 tizedesjegyre
                    }

                    case "Bruttó bér": {
                        try {
                            // Minden komponens összegzése
                            const components = [
                                "Alapbér",
                                "Túlóra alap",
                                "Szabadságra jutó fizetés",
                                "Távolléti díj",
                                "Fizetett ünnepnap",
                                "Túlórapótlék",
                                "Hétvégi pótlék (50%)",
                                "Műszakpótlék (40%)",
                                "Teljesítmény prémium"
                            ];
        
                            const total = components.reduce((sum, component) => {
                                const value = this.calculateMonthlyValue(component, monthIndex, year);
                                return sum + value;
                            }, 0);
        
                            return Math.round(total);
                        } catch (error) {
                            console.error("Hiba a bruttó bér számítása során:", error);
                            return 0; 
                        }
                    }
                    default:
                        console.warn(`Ismeretlen tétel: ${label}`);
                        return 0;
                }
            } catch (error) {
                console.error("Hiba a havi érték számítása során:", error, {
                    label, monthIndex, year
                });
                return 0;
            }
        }

        getMonthData(monthIndex, year) {
        console.log("Current month:", this.currentMonth);
        console.log("Current year:", this.currentYear);
        const yearData = this.app.yearData;
        const monthData = {
            workedDays: 0,
            totalWorkingDays: this.calculateWorkingDays(year, monthIndex),
            vacationHours: 0,
            overtimeHours: 0,
            nightShiftHours: 0,
            weekendHours: 0,
            sickDays: 0,
        };

        const calendarData =
            this.app.yearData.calendar_data[monthIndex] || {};

        // Ha üres a calendar_data, térjünk vissza az alapértelmezett adatokkal
        if (Object.keys(calendarData).length === 0) {
            return monthData;
        }

        Object.entries(calendarData).forEach(([day, shiftValue]) => {
            const date = new Date(year, monthIndex, parseInt(day));
            const isWeekend = date.getDay() === 0 || date.getDay() === 6;

            switch (shiftValue) {
            case "Nappal":
                monthData.workedDays += 1;
                if (isWeekend) monthData.weekendHours += 12;
                break;

            case "Éjszaka":
                monthData.workedDays += 1;
                monthData.nightShiftHours += 12;
                if (isWeekend) monthData.weekendHours += 12;
                break;

            case "Szabadság 12 óra":
                monthData.vacationHours += 12;
                break;

            case "Szabadság éj 12 óra":
                monthData.vacationHours += 12;
                monthData.nightShiftHours += 12;
                break;

            case "Szabadság 8 óra":
                monthData.vacationHours += 8;
                break;

            case "Szabadság éj 8 óra":
                monthData.vacationHours += 8;
                monthData.nightShiftHours += 8;
                break;

            case "Szabadság 4 óra":
                monthData.vacationHours += 4;
                break;

            case "Szabadság éj 4 óra":
                monthData.vacationHours += 4;
                monthData.nightShiftHours += 4;
                break;

            case "Túlóra 12 óra":
                monthData.workedDays += 1;
                monthData.overtimeHours += 12;
                if (isWeekend) monthData.weekendHours += 12;
                break;

            case "Túlóra éj 12 óra":
                monthData.workedDays += 1;
                monthData.overtimeHours += 12;
                monthData.nightShiftHours += 12;
                if (isWeekend) monthData.weekendHours += 12;
                break;

            case "Túlóra 8 óra":
                monthData.overtimeHours += 8;
                if (isWeekend) monthData.weekendHours += 8;
                break;

            case "Túlóra éj 8 óra":
                monthData.overtimeHours += 8;
                monthData.nightShiftHours += 8;
                if (isWeekend) monthData.weekendHours += 8;
                break;

            case "Táppénz":
                monthData.sickDays += 1;
                break;
            }
        });
        return monthData;
        }

        calculateTavolletDij(monthIndex, year) {
            try {
                const yearData = this.app.yearlyData[year];
                const settings = yearData?.settings || {};
                const monthData = yearData?.calendar_data[monthIndex] || {};
                const besorolas = parseInt(settings.besorolasi_ber) || 300000;
        
                // Táppénz változók (ezek maradnak a régiek)
                let tappenzTavollet = 0;
                let tappenzKiegeszites = 0;
                let tappenzCount = 0;
                let betegszabadsagCount = settings.felhasznalt_betegszabadsag || 0;
                let szabadsagPotlekDij = 0;
        
                // Előző 6 hónap pótlékainak és munkaóráinak összegzése
                let osszesEjszakaiPotlek = 0;
                let osszesVasarnapiPotlek = 0;
                let osszesLedolgozottOra = 0;
        
                // Előző 6 hónap vizsgálata
                for (let i = 1; i <= 6; i++) {
                    let vizsgaltHonap = monthIndex - i;
                    let vizsgaltEv = year;
                    
                    if (vizsgaltHonap < 0) {
                        vizsgaltHonap += 12;
                        vizsgaltEv--;
                    }
                    
                    const honapiAdat = yearData.calendar_data[vizsgaltHonap] || {};
                    
                    Object.entries(honapiAdat).forEach(([nap, shiftValue]) => {
                        if (!shiftValue) return;
        
                        let orak = 12;
                        if (shiftValue.includes("8 óra")) orak = 8;
                        if (shiftValue.includes("4 óra")) orak = 4;
        
                        // Csak a ténylegesen ledolgozott órák számítanak
                        if (shiftValue.includes("Nappal") || shiftValue.includes("Éjszaka")) {
                            osszesLedolgozottOra += orak;
                            
                            // Éjszakai pótlék számítása
                            if (shiftValue.includes("Éjszaka")) {
                                osszesEjszakaiPotlek += (besorolas / 174) * orak * 0.4;
                            }
        
                            // Vasárnapi pótlék számítása
                            const date = new Date(vizsgaltEv, vizsgaltHonap, parseInt(nap));
                            if (date.getDay() === 0) {
                                osszesVasarnapiPotlek += (besorolas / 174) * orak * 0.5;
                            }
                        }
                    });
                }
        
                // Óránkénti átlagos pótlékok számítása
                const atlagEjszakaiPotlek = osszesLedolgozottOra > 0 ? osszesEjszakaiPotlek / osszesLedolgozottOra : 0;
                const atlagVasarnapiPotlek = osszesLedolgozottOra > 0 ? osszesVasarnapiPotlek / osszesLedolgozottOra : 0;
        
                // Aktuális hónap szabadságainak és táppénzeinek feldolgozása
                Object.entries(monthData).forEach(([day, shiftValue]) => {
                    if (!shiftValue) return;
        
                    if (shiftValue.includes("Táppénz")) {
                        const napiBer = Math.min(besorolas / 30, Math.round((this.MINIMUM_WAGE[year] || this.MINIMUM_WAGE[2024] * 2) / 30));
                        
                        if (betegszabadsagCount < 15) {
                            tappenzTavollet += napiBer * 0.7;
                            tappenzKiegeszites += napiBer * 0.5;
                            betegszabadsagCount++;
                            tappenzCount++;
                        } else {
                            if (tappenzCount < 15) {
                                tappenzTavollet += napiBer * 0.6;
                                tappenzKiegeszites += napiBer * 0.5;
                                tappenzCount++;
                            } else {
                                tappenzTavollet += napiBer * 0.5;
                                tappenzKiegeszites += napiBer * 0.5;
                            }
                        }
                    } else if (shiftValue.includes("Szabadság")) {
                        let orak = 12;
                        if (shiftValue.includes("8 óra")) orak = 8;
                        if (shiftValue.includes("4 óra")) orak = 4;
                        szabadsagPotlekDij += (atlagEjszakaiPotlek + atlagVasarnapiPotlek) * orak;
                    }
                });
        
                if (yearData.settings) {
                    yearData.settings.felhasznalt_betegszabadsag = betegszabadsagCount;
                }
        
                return Math.round(tappenzTavollet + tappenzKiegeszites + szabadsagPotlekDij);
            } catch (error) {
                console.error("Hiba a távolléti díj számításában:", error);
                return 0;
            }
        }
    }

    const SHIFT_START_DATE = new Date(Date.UTC(2024, 0, 1));

    // Általános segédfüggvény a napok közötti különbség számolásához
    function getDaysBetween(startDate, endDate) {
        try {
            // Mindkét dátumot UTC-ben kezeljük és az időt 00:00:00-ra állítjuk
            const start = new Date(Date.UTC(
                startDate.getFullYear(),
                startDate.getMonth(),
                startDate.getDate()
            ));
            const end = new Date(Date.UTC(
                endDate.getFullYear(), 
                endDate.getMonth(), 
                endDate.getDate()
            ));
    
            const millisecondsPerDay = 24 * 60 * 60 * 1000;
            return Math.floor((end - start) / millisecondsPerDay);
        } catch (error) {
            console.error("Hiba a napok közötti különbség számításánál:", error);
            return 0;
        }
    }

    class EventHandlers {
        constructor(app) {
        this.app = app;

        // Év váltás eseménykezelők
        this.initYearChangeHandlers();

        // Beállítások eseménykezelők
        this.initSettingsHandlers();

        // Színbeállítások eseménykezelők
        this.initColorHandlers();
        }

        initYearChangeHandlers() {
        // Naptár év váltás
        document
            .getElementById("prev-month-btn")
            ?.addEventListener("click", () => {
            this.app.changeYear(-1, "calendar");
            });

        document
            .getElementById("next-month-btn")
            ?.addEventListener("click", () => {
            this.app.changeYear(1, "calendar");
            });

        // Bérszámfejtés év váltás
        document
            .getElementById("prev-payroll-month-btn")
            ?.addEventListener("click", () => {
            this.app.changeYear(-1, "payroll");
            });

        document
            .getElementById("next-payroll-month-btn")
            ?.addEventListener("click", () => {
            this.app.changeYear(1, "payroll");
            });

        // Beállítások év váltás
        document
            .getElementById("prev-settings-year-btn")
            ?.addEventListener("click", () => {
            this.app.changeYear(-1, "settings");
            });

        document
            .getElementById("next-settings-year-btn")
            ?.addEventListener("click", () => {
            this.app.changeYear(1, "settings");
            });
        }

        initSettingsHandlers() {
        // Under 25 checkbox kezelése
        const under25Checkbox = document.getElementById("under25-checkbox");
        const birthDateContainer = document.getElementById(
            "birth-date-container"
        );

        under25Checkbox?.addEventListener("change", (e) => {
            if (birthDateContainer) {
            birthDateContainer.style.display = e.target.checked
                ? "block"
                : "none";
            this.app.yearlyData[
                this.app.currentSettingsYear
            ].settings.under25.enabled = e.target.checked;
            }
        });

        // Évközi változás hozzáadása
        document
            .getElementById("add-midyear-change")
            ?.addEventListener("click", () => {
            const monthSelect = document.getElementById("midyear-month");
            const salaryInput = document.getElementById("midyear-salary");

            if (!monthSelect?.value || !salaryInput?.value) {
                alert("Kérlek válassz hónapot és adj meg új besorolási bért!");
                return;
            }

            this.app.addMidyearChange(monthSelect.value, salaryInput.value);

            // Mezők törlése
            monthSelect.value = "";
            salaryInput.value = "";
            });

        // Beállítások mentése
        document
            .getElementById("save-settings")
            ?.addEventListener("click", () => {
            try {
                this.app.saveSettings();
                alert("Beállítások sikeresen mentve!");
            } catch (error) {
                alert("Hiba történt a beállítások mentése során!");
                console.error(error);
            }
            });
        }

        initColorHandlers() {
        const colorPickers = document.querySelectorAll(".color-picker");

        colorPickers.forEach((button) => {
            button.addEventListener("click", (e) => {
            e.preventDefault();

            const input = document.createElement("input");
            input.type = "color";

            const shiftType = button.getAttribute("data-shift-type");
            const colorType = button.getAttribute("data-color-type");

            if (shiftType && colorType) {
                this.handleColorPicker(input, shiftType, colorType);
            }
            });
        });
        }

        handleColorPicker(input, shiftType, colorType) {
        const key = this.findShiftColorKey(shiftType);
        if (!key) return;

        input.value =
            colorType === "bg" ? SHIFT_COLORS[key][0] : SHIFT_COLORS[key][1];

        input.addEventListener("input", (event) => {
            if (colorType === "bg") {
            SHIFT_COLORS[key][0] = event.target.value;
            } else {
            SHIFT_COLORS[key][1] = event.target.value;
            }

            this.app.updateColorPreviews();
            this.app.generateCalendar();
            this.app.saveColorSettings();
        });

        input.click();
        }

        findShiftColorKey(shiftType) {
        return Object.keys(SHIFT_COLORS).find(
            (key) =>
            key
                .toLowerCase()
                .normalize("NFD")
                .replace(/[\u0300-\u036f]/g, "") ===
            shiftType
                .toLowerCase()
                .normalize("NFD")
                .replace(/[\u0300-\u036f]/g, "")
        );
        }
    }

    class ErrorHandler {
        static handle(error, context) {
        console.error(`Hiba a következő művelet során: ${context}`, error);

        let userMessage;
        switch (context) {
            case "saveSettings":
            userMessage =
                "Nem sikerült menteni a beállításokat. Kérlek próbáld újra!";
            break;
            case "loadSettings":
            userMessage =
                "Nem sikerült betölteni a beállításokat. Alapértelmezett értékek kerülnek használatra.";
            break;
            case "calculateSalary":
            userMessage =
                "Hiba történt a bérszámítás során. Kérlek ellenőrizd a megadott adatokat!";
            break;
            default:
            userMessage = "Váratlan hiba történt. Kérlek próbáld újra!";
        }

        alert(userMessage);
        return null;
        }

        static validateInput(value, type) {
        switch (type) {
            case "salary":
            return !isNaN(value) && value >= 0;
            case "year":
            return !isNaN(value) && value >= 2024 && value <= 2028;
            case "month":
            return !isNaN(value) && value >= 0 && value <= 11;
            default:
            return true;
        }
        }
    }

    class BerszamfejtoApp {
        constructor() {
            console.log("App constructor started");
            
            try {
                // Alapvető dátumok inicializálása
                const currentDate = new Date();
                const currentYear = currentDate.getFullYear();
                
                console.log("Current date initialized:", currentDate);
                
                this.currentYear = currentYear >= 2024 && currentYear <= 2028 ? currentYear : 2024;
                this.currentMonth = currentDate.getMonth();
                this.currentPayrollYear = this.currentYear;
                this.currentPayrollMonth = this.currentMonth;
                this.currentSettingsYear = this.currentYear;
                this.calculator = new BerszamfejtoCalculator(this);
        
                console.log("Years initialized:", {
                    currentYear: this.currentYear,
                    currentMonth: this.currentMonth
                });
        
                // Adatstruktúrák inicializálása
                this.initializeYearlyData();
                console.log("YearlyData initialized");
        
                // Betöltjük a mentett adatokat
                this.loadYearlyData();
                console.log("YearlyData loaded");
        
                // További inicializálások
                document.getElementById('current-settings-year').textContent = this.currentSettingsYear;
                this.loadColorSettings();
                
                console.log("Starting navigation initialization");
                this.initNavigation();
                this.initEventListeners();
                this.initSettingsNavigation();
                this.initTouchNavigation();
                this.initSettings();
                this.salaryVisibility = initSalaryVisibility();
        
                console.log("Starting calendar generation");
                this.generateCalendar();
                
                console.log("Starting payroll initialization");
                this.initPayrollNavigation();
                this.generatePayrollTable();
        
            } catch (error) {
                console.error("Hiba az alkalmazás inicializálása során:", error);
                console.error("Hiba részletei:", error.message);
                console.error("Hiba stack:", error.stack);
            }
        }
    
        initializeYearlyData() {
            console.log("YearlyData inicializálása kezdődik");
            this.yearlyData = {};
            // Inicializáljuk az összes évet
            for (let year = 2024; year <= 2028; year++) {
                this.yearlyData[year] = {
                    settings: {
                        besorolasi_ber: "300000",
                        szabadsag: "25",
                        muszakrend: "1",
                        other_income: "0",
                        children_count: "0",
                        under25: {
                            enabled: false,
                            birthYear: "",
                            birthMonth: ""
                        },
                        midyear_changes: []
                    },
                    calendar_data: {},
                    bonusEntries: {},
                    restaurantEntries: {}
                };
    
                console.log(`${year} év adatainak generálása...`);
                // Inicializáljuk a hónapokat és generáljuk a műszakrendet
                for (let month = 0; month < 12; month++) {
                    if (!this.yearlyData[year].calendar_data[month]) {
                        this.yearlyData[year].calendar_data[month] = {};
                    }
                    
                    // Műszakrend generálása minden napra
                    const daysInMonth = new Date(year, month + 1, 0).getDate();
                    for (let day = 1; day <= daysInMonth; day++) {
                        const currentYear = this.currentYear; // Mentjük az eredeti értéket
                        const currentMonth = this.currentMonth;
                        
                        // Beállítjuk ideiglenesen a generáláshoz szükséges értékeket
                        this.currentYear = year;
                        this.currentMonth = month;
                        
                        const shiftValue = this.generateShiftPattern(day);
                        if (shiftValue !== " ") {
                            this.yearlyData[year].calendar_data[month][day] = shiftValue;
                        }
                        
                        // Visszaállítjuk az eredeti értékeket
                        this.currentYear = currentYear;
                        this.currentMonth = currentMonth;
                    }
                    
                    // Alapértelmezett bónusz értékek beállítása (2)
                    if (!this.yearlyData[year].bonusEntries[month]) {
                        this.yearlyData[year].bonusEntries[month] = 2;
                    }
                }
            }
            console.log("YearlyData inicializálása befejezve");
        }       
    
        saveYearlyData() {
            try {
                // Debug: kiírjuk a mentés előtti adatokat
                console.log('Mentés előtti adatok:', 
                    JSON.stringify(this.yearlyData[this.currentYear].calendar_data[this.currentMonth]));
                
                // Mentés előtt kitisztítjuk az undefined értékeket
                const yearData = JSON.parse(JSON.stringify(this.yearlyData));
                Object.keys(yearData).forEach(year => {
                    if (yearData[year].calendar_data) {
                        Object.keys(yearData[year].calendar_data).forEach(month => {
                            Object.keys(yearData[year].calendar_data[month]).forEach(day => {
                                if (yearData[year].calendar_data[month][day] === undefined) {
                                    yearData[year].calendar_data[month][day] = " ";
                                }
                            });
                        });
                    }
                });
                
                localStorage.setItem("berszamfejtoYearlyData", JSON.stringify(yearData));
                
                // Debug: kiírjuk a mentés utáni adatokat
                console.log('Mentés utáni adatok:', 
                    JSON.stringify(yearData[this.currentYear].calendar_data[this.currentMonth]));
            } catch (error) {
                console.error("Hiba az adatok mentése során:", error);
            }
        }
    
        loadYearlyData() {
            try {
                console.log("Mentett adatok betöltése kezdődik");
                const savedData = localStorage.getItem("berszamfejtoYearlyData");
                if (savedData) {
                    const parsedData = JSON.parse(savedData);
                    
                    // Összes év végigiterálása
                    for (let year = 2024; year <= 2028; year++) {
                        console.log(`${year} év adatainak betöltése...`);
                        if (parsedData[year]) {
                            // Settings másolása
                            this.yearlyData[year].settings = parsedData[year].settings || this.yearlyData[year].settings;
                            
                            // Calendar data ellenőrzése és generálása ha szükséges
                            for (let month = 0; month < 12; month++) {
                                // Ha nincs adat az adott hónapra, generáljuk
                                if (!parsedData[year].calendar_data?.[month] || 
                                    Object.keys(parsedData[year].calendar_data[month]).length === 0) {
                                    
                                    if (!this.yearlyData[year].calendar_data[month]) {
                                        this.yearlyData[year].calendar_data[month] = {};
                                    }
                                    
                                    const daysInMonth = new Date(year, month + 1, 0).getDate();
                                    for (let day = 1; day <= daysInMonth; day++) {
                                        const currentYear = this.currentYear;
                                        const currentMonth = this.currentMonth;
                                        
                                        this.currentYear = year;
                                        this.currentMonth = month;
                                        
                                        const shiftValue = this.generateShiftPattern(day);
                                        if (shiftValue !== " ") {
                                            this.yearlyData[year].calendar_data[month][day] = shiftValue;
                                        }
                                        
                                        this.currentYear = currentYear;
                                        this.currentMonth = currentMonth;
                                    }
                                } else {
                                    // Ha van mentett adat, azt használjuk
                                    this.yearlyData[year].calendar_data[month] = {
                                        ...parsedData[year].calendar_data[month]
                                    };
                                }
                            }
                            
                            // Bónuszok és éttermi fogyasztás másolása
                            this.yearlyData[year].bonusEntries = {
                                ...parsedData[year].bonusEntries
                            };
                            this.yearlyData[year].restaurantEntries = {
                                ...parsedData[year].restaurantEntries
                            };
                        }
                    }
                    
                    // Mentjük az esetleges új generált adatokat
                    this.saveYearlyData();
                    console.log("Adatok betöltése és mentése befejezve");
                } else {
                    console.log("Nincs mentett adat, az alapértelmezett értékek maradnak");
                }
            } catch (error) {
                console.error("Hiba a mentett adatok betöltése során:", error);
                console.error("Hiba részletei:", error.stack);
            }
        }

        addMidyearChange(month, salary) {
            try {
                // Ellenőrizzük, hogy van-e már ilyen hónapra változás
                if (!this.yearlyData[this.currentSettingsYear].settings.midyear_changes) {
                    this.yearlyData[this.currentSettingsYear].settings.midyear_changes = [];
                }
        
                // Ellenőrizzük, hogy van-e már változás erre a hónapra
                const existingChangeIndex = this.yearlyData[this.currentSettingsYear].settings.midyear_changes
                    .findIndex(change => change.month === parseInt(month));
        
                const change = {
                    month: parseInt(month),
                    salary: salary,
                    id: Date.now()
                };
        
                if (existingChangeIndex !== -1) {
                    // Ha már van változás erre a hónapra, frissítjük
                    this.yearlyData[this.currentSettingsYear].settings.midyear_changes[existingChangeIndex] = change;
                } else {
                    // Ha nincs még változás erre a hónapra, hozzáadjuk
                    this.yearlyData[this.currentSettingsYear].settings.midyear_changes.push(change);
                }
        
                this.displayMidyearChanges();
                this.saveYearlyData();
                
                // Frissítjük a bérszámfejtési táblázatot is
                this.generatePayrollTable();
            } catch (error) {
                console.error("Hiba az évközi változás hozzáadása során:", error);
                alert("Hiba történt az évközi változás hozzáadása során!");
            }
        }

        // Évközi változások megjelenítése
        // A BerszamfejtoApp osztályban módosítsuk ezt a függvényt:
        removeMidyearChange(id) {
            try {
                // Ellenőrizzük, hogy létezik-e az év és a midyear_changes tömb
                if (!this.yearlyData[this.currentSettingsYear] ||
                    !this.yearlyData[this.currentSettingsYear].settings ||
                    !this.yearlyData[this.currentSettingsYear].settings.midyear_changes) {
                    console.error("Hiányzó adatstruktúra az évközi változások kezeléséhez");
                    return;
                }

                // Töröljük a változást a tömbből
                this.yearlyData[this.currentSettingsYear].settings.midyear_changes = 
                    this.yearlyData[this.currentSettingsYear].settings.midyear_changes.filter(
                        change => change.id !== id
                    );

                // Frissítjük a megjelenítést és mentjük az adatokat
                this.displayMidyearChanges();
                this.saveYearlyData();

                // Frissítjük a bérszámfejtési táblázatot is
                this.generatePayrollTable();
                
                console.log(`Évközi változás törölve: ${id}`);
            } catch (error) {
                console.error("Hiba az évközi változás törlése során:", error);
                alert("Hiba történt a változás törlése során!");
            }
        }

        displayMidyearChanges() {
            try {
                const container = document.getElementById('midyear-changes-list');
                if (!container) return;
        
                container.innerHTML = '';
        
                if (!this.yearlyData[this.currentSettingsYear]) {
                    this.yearlyData[this.currentSettingsYear] = {
                        settings: {
                            besorolasi_ber: "300000",
                            szabadsag: "25",
                            muszakrend: "1",
                            other_income: "0",
                            under25: {
                                enabled: false,
                                birthYear: "",
                                birthMonth: ""
                            },
                            midyear_changes: []
                        },
                        calendar_data: {},
                        bonusEntries: {},
                        restaurantEntries: {}
                    };
                }
        
                const changes = this.yearlyData[this.currentSettingsYear].settings.midyear_changes;
                const months = [
                    "Január", "Február", "Március", "Április", "Május", "Június",
                    "Július", "Augusztus", "Szeptember", "Október", "November", "December"
                ];
        
                changes.forEach(change => {
                    const div = document.createElement('div');
                    div.className = 'midyear-change-item';
        
                    div.innerHTML = `
                        <span>${months[change.month]}: ${parseInt(change.salary).toLocaleString('hu-HU')} Ft</span>
                        <button 
                            data-change-id="${change.id}"
                            class="remove-midyear-change"
                            style="background: none; border: none; color: red; cursor: pointer;"
                        >
                            Törlés
                        </button>
                    `;
                    container.appendChild(div);
                });
        
                // Eseménykezelő hozzáadása a dinamikusan létrehozott gombokhoz
                container.addEventListener('click', (event) => {
                    const removeButton = event.target.closest('.remove-midyear-change');
                    if (removeButton) {
                        const changeId = parseInt(removeButton.getAttribute('data-change-id'));
                        
                        // Biztonságos hívás, ha az app objektum létezik
                        if (window.app && typeof window.app.removeMidyearChange === 'function') {
                            window.app.removeMidyearChange(changeId);
                        } else {
                            console.error('Az app objektum nem elérhető a törlésnél');
                        }
                    }
                });
            } catch (error) {
                console.error("Hiba az évközi változások megjelenítése során:", error);
            }
        }

        changeYear(direction, type = "calendar") {
            let currentYear;
            let minYear = 2024;
            let maxYear = 2028;
        
            switch (type) {
                case "calendar":
                    currentYear = this.currentYear + direction;
                    if (currentYear >= minYear && currentYear <= maxYear) {
                        this.currentYear = currentYear;
                        if (direction < 0 && this.currentMonth === 0) {
                            this.currentMonth = 11;
                            this.currentYear--;
                        } else if (direction > 0 && this.currentMonth === 11) {
                            this.currentMonth = 0;
                            this.currentYear++;
                        }
                    } else {
                        // Ha elérné a korlátokat, nem csinálunk semmit
                        return;
                    }
                    this.generateCalendar();
                    break;
        
                case "payroll":
                    currentYear = this.currentPayrollYear + direction;
                    if (currentYear >= minYear && currentYear <= maxYear) {
                        this.currentPayrollYear = currentYear;
                        if (direction < 0 && this.currentPayrollMonth === 0) {
                            this.currentPayrollMonth = 11;
                            this.currentPayrollYear--;
                        } else if (direction > 0 && this.currentPayrollMonth === 11) {
                            this.currentPayrollMonth = 0;
                            this.currentPayrollYear++;
                        }
                    } else {
                        // Ha elérné a korlátokat, nem csinálunk semmit
                        return;
                    }
                    this.generatePayrollTable();
                    break;
        
                case "settings":
                    currentYear = this.currentSettingsYear + direction;
                    if (currentYear >= minYear && currentYear <= maxYear) {
                        this.currentSettingsYear = currentYear;
                        this.loadYearSettings(this.currentSettingsYear);
                    } else {
                        // Ha elérné a korlátokat, nem csinálunk semmit
                        return;
                    }
                    break;
            }
        }

        // 25 év alatti kedvezmény számítása
        calculateUnder25Discount(year, month, grossSalary) {
            if (year < 2024 || year > 2028) return 0;
        
            const yearData = this.yearlyData[year];
            if (!yearData?.settings?.under25?.enabled) return 0;
        
            const birthYear = parseInt(yearData.settings.under25.birthYear);
            const birthMonth = parseInt(yearData.settings.under25.birthMonth);
        
            if (!birthYear || !birthMonth) return 0;
        
            // Pontos életkor számítás
            const birthDate = new Date(birthYear, birthMonth - 1);
            const currentDate = new Date(year, month);
            
            // Életkor számítása pontosan
            let age = currentDate.getFullYear() - birthDate.getFullYear();
            if (currentDate < new Date(currentDate.getFullYear(), birthDate.getMonth(), birthDate.getDate())) {
                age--;
            }
        
            if (age >= 25) return 0;
        
            const maxDiscount = {
                2024: 1037880,
                2025: 1182213,
                2026: 1182213,
                2027: 1182213,
                2028: 1182213,
            };
        
            const maxMonthlyDiscount = maxDiscount[year] / 12;
        
            // Havi arányosítás, ha az adott évben nem teljes évig jogosult
            const firstEligibleMonth = birthDate.getMonth() + (birthDate.getFullYear() === year ? 1 : 0);
            const lastEligibleMonth = birthDate.getMonth() + 12;
            const eligibleMonthsInYear = Math.min(12, lastEligibleMonth - firstEligibleMonth + 1);
        
            const monthlyDiscountRate = eligibleMonthsInYear / 12;
            const adjustedMaxMonthlyDiscount = maxMonthlyDiscount * monthlyDiscountRate;
        
            // A bruttó bér 15%-a és a maximális havi kedvezmény közül a kisebb
            return Math.min(grossSalary * 0.15, adjustedMaxMonthlyDiscount);
        }

        debugCalendarData() {
        // Aktuális hónap napjainak száma
        const daysInMonth = new Date(
            this.currentYear,
            this.currentMonth + 1,
            0
        ).getDate();

        console.log("Debug - Naptár adatok ellenőrzése:");
        console.log(
            `Év: ${this.currentYear}, Hónap: ${this.currentMonth + 1}`
        );
        console.log(`Napok száma ebben a hónapban: ${daysInMonth}`);

        if (this.yearData.calendar_data[this.currentMonth]) {
            Object.entries(this.yearData.calendar_data[this.currentMonth])
            .sort(([a], [b]) => parseInt(a) - parseInt(b))
            .forEach(([day, shift]) => {
                const dayNum = parseInt(day);
                if (dayNum <= daysInMonth) {
                console.log(`Nap ${dayNum}: ${shift}`);
                } else {
                console.error(`Érvénytelen nap talált: ${dayNum}`);
                }
            });
        } else {
            console.log("Nincs adat erre a hónapra.");
        }
        }

        initTouchNavigation() {
        const calendarSection = document.getElementById("calendar-section");
        let startX = 0;
        let endX = 0;

        calendarSection.addEventListener("touchstart", (e) => {
            startX = e.touches[0].clientX;
        });

        calendarSection.addEventListener("touchend", (e) => {
            endX = e.changedTouches[0].clientX;
            this.handleSwipe(startX, endX);
        });
        }

        handleSwipe(startX, endX) {
        // Minimum elmozdulás érzékeléséhez
        const minSwipeDistance = 100;

        if (startX - endX > minSwipeDistance) {
            // Balra húzás - következő hónap
            this.changeMonth(1);
        } else if (endX - startX > minSwipeDistance) {
            // Jobbra húzás - előző hónap
            this.changeMonth(-1);
        }
        }

        initNavigation() {
        const navButtons = {
            "calendar-btn": "calendar-section",
            "payroll-btn": "payroll-section",
            "settings-btn": "settings-section",
            "help-btn": "help-section",
        };

        Object.entries(navButtons).forEach(([btnId, sectionId]) => {
            document.getElementById(btnId).addEventListener("click", () => {
            this.showSection(sectionId);
            });
        });
        }

        showSection(sectionId) {
            // Elrejtjük az összes szekciót, de megőrizzük az esetleges animációs osztályokat
            document.querySelectorAll(".section").forEach((section) => {
                const classes = Array.from(section.classList)
                    .filter(cls => !cls.includes('section') && !cls.includes('active'));
                section.className = `section ${classes.join(' ')}`;
                section.style.display = "none";
            });
        
            // Kijelölt szekció megjelenítése
            const selectedSection = document.getElementById(sectionId);
            if (selectedSection) {
                const classes = Array.from(selectedSection.classList)
                    .filter(cls => !cls.includes('section') && !cls.includes('active'));
                selectedSection.className = `section active ${classes.join(' ')}`;
                selectedSection.style.display = "block";
            }
        }

        loadSettings() {
        const savedSettings = localStorage.getItem("appSettings");
        return savedSettings
            ? JSON.parse(savedSettings)
            : {
                shiftPattern: "1",
                baseSalary: 0,
                vacationDays: 20,
            };
        }

        initEventListeners() {
        try {
            // Hónap navigáció
            const prevMonthBtn = document.getElementById("prev-month-btn");
            const nextMonthBtn = document.getElementById("next-month-btn");

            if (prevMonthBtn) {
            prevMonthBtn.addEventListener("click", () =>
                this.changeMonth(-1)
            );
            }
            if (nextMonthBtn) {
            nextMonthBtn.addEventListener("click", () => this.changeMonth(1));
            }

            // Műszakrend és egyéb beállítások inicializálása
            const shiftPatternSelect = document.getElementById(
            "shift-pattern-select"
            );
            const baseSalaryInput = document.getElementById("base-salary");
            const vacationDaysInput = document.getElementById("vacation-days");

            // Ellenőrizzük, hogy léteznek-e az elemek és van-e settings objektum
            if (
            shiftPatternSelect &&
            this.yearlyData[this.currentYear].settings
            ) {
            shiftPatternSelect.value =
                this.yearlyData[this.currentYear].settings.muszakrend || "1";
            }
            if (baseSalaryInput && this.yearlyData[this.currentYear].settings) {
            baseSalaryInput.value =
                this.yearlyData[this.currentYear].settings.besorolasi_ber ||
                "300000";
            }
            if (
            vacationDaysInput &&
            this.yearlyData[this.currentYear].settings
            ) {
            vacationDaysInput.value =
                this.yearlyData[this.currentYear].settings.szabadsag || "25";
            }

            // 25 év alatti checkbox kezelése
            const under25Checkbox = document.getElementById("under25-checkbox");
            if (under25Checkbox) {
            under25Checkbox.addEventListener("change", (e) => {
                const birthDateContainer = document.getElementById(
                "birth-date-container"
                );
                if (birthDateContainer) {
                birthDateContainer.style.display = e.target.checked
                    ? "block"
                    : "none";
                }
            });
            }

            // Évközi változás hozzáadása
            const midyearAddButton =
            document.getElementById("add-midyear-change");
            if (midyearAddButton) {
            midyearAddButton.addEventListener("click", () => {
                const monthSelect = document.getElementById("midyear-month");
                const salaryInput = document.getElementById("midyear-salary");

                if (
                monthSelect &&
                salaryInput &&
                monthSelect.value &&
                salaryInput.value
                ) {
                this.addMidyearChange(monthSelect.value, salaryInput.value);
                }
            });
            }
        } catch (error) {
            console.error(
            "Hiba az eseménykezelők inicializálása során:",
            error
            );
        }
        }

        initSettingsNavigation() {
        document
            .getElementById("prev-settings-year-btn")
            .addEventListener("click", () => {
            this.changeSettingsYear(-1);
            });

        document
            .getElementById("next-settings-year-btn")
            .addEventListener("click", () => {
            this.changeSettingsYear(1);
            });
        }

        changeSettingsYear(direction) {
            const settingsContent = document.getElementById("settings-section");
            
            // Add slide out animation
            settingsContent.className = `section ${direction > 0 ? 'slide-year-out-left' : 'slide-year-out-right'}`;
            
            setTimeout(() => {
                this.currentSettingsYear += direction;
        
                // Korlátozzuk az éveket 2024 és 2028 között
                if (this.currentSettingsYear < 2024) {
                    this.currentSettingsYear = 2024;
                    return;
                } else if (this.currentSettingsYear > 2028) {
                    this.currentSettingsYear = 2028;
                    return;
                }
        
                // Frissítsük az év kijelzést
                document.getElementById("current-settings-year").textContent = this.currentSettingsYear;
        
                // Töltsük be az adott év beállításait
                this.loadYearSettings(this.currentSettingsYear);
                
                // Add slide in animation
                settingsContent.className = `section active ${direction > 0 ? 'slide-year-in-right' : 'slide-year-in-left'}`;
            }, 200);
        }

        loadYearSettings(year) {
            console.log(`loadYearSettings meghívva a következő évvel: ${year}`);
            console.log(`Jelenlegi rendszeridő éve: ${new Date().getFullYear()}`);
            
            // Frissítsük a kijelzett évet
            document.getElementById('current-settings-year').textContent = year;
            this.currentSettingsYear = year;
        
            // Biztosítjuk, hogy létezik az adott év
            if (!this.yearlyData[year]) {
                this.yearlyData[year] = {
                    settings: {
                        besorolasi_ber: "300000",
                        szabadsag: "25",
                        muszakrend: "1", // Alapértelmezett érték visszaállítása
                        other_income: "0",
                        under25: {
                            enabled: false,
                            birthYear: "",
                            birthMonth: ""
                        },
                        midyear_changes: []
                    },
                    calendar_data: {},
                    bonusEntries: {},
                    restaurantEntries: {}
                };
            }
        
            const yearData = this.yearlyData[year];
            
            // Form mezők feltöltése
            const shiftPatternSelect = document.getElementById('shift-pattern-select');
            if (shiftPatternSelect) {
                // Ha nem létezik beállított műszakrend, alapértelmezetten '1'-et használjuk
                shiftPatternSelect.value = yearData.settings.muszakrend || "1";
            }
            
            const baseSalaryInput = document.getElementById('base-salary');
            if (baseSalaryInput && this.salaryVisibility) {
                this.salaryVisibility.setValue(yearData.settings.besorolasi_ber || "300000");
            }
            
            const otherIncomeInput = document.getElementById('other-income');
            if (otherIncomeInput) {
                otherIncomeInput.value = yearData.settings.other_income || "0";
            }

            const vacationDaysInput = document.getElementById('vacation-days');
            if (vacationDaysInput) {
                vacationDaysInput.value = yearData.settings.szabadsag || "25";
            }
            
            // 25 év alatti beállítások
            const under25 = yearData.settings.under25 || { enabled: false };
            const under25Checkbox = document.getElementById('under25-checkbox');
            const birthYearInput = document.getElementById('birth-year');
            const birthMonthInput = document.getElementById('birth-month');
            const birthDateContainer = document.getElementById('birth-date-container');
        
            if (under25Checkbox) under25Checkbox.checked = under25.enabled;
            if (birthYearInput) birthYearInput.value = under25.birthYear || '';
            if (birthMonthInput) birthMonthInput.value = under25.birthMonth || '';
            if (birthDateContainer) birthDateContainer.style.display = under25.enabled ? 'block' : 'none';
        
            // Évközi változások megjelenítése
            this.displayMidyearChanges();
            
            console.log(`Betöltött év: ${year}, műszakrend: ${yearData.settings.muszakrend}`); // Debug log
        }

        initSettings() {
            try {
                // Színbeállítások kezelése
                const colorPickers = document.querySelectorAll(".color-picker");
                colorPickers.forEach(button => {
                    button.addEventListener("click", (e) => this.handleColorPickerClick(e));
                });
        
                // Under 25 checkbox kezelése
                const under25Checkbox = document.getElementById("under25-checkbox");
                const birthDateContainer = document.getElementById("birth-date-container");
        
                if (under25Checkbox && birthDateContainer) {
                    under25Checkbox.addEventListener("change", (e) => {
                        birthDateContainer.style.display = e.target.checked ? "block" : "none";
                    });
                }
        
                // Évközi változás hozzáadása gomb kezelése
                const addMidyearChangeBtn = document.getElementById("add-midyear-change");
                if (addMidyearChangeBtn) {
                    addMidyearChangeBtn.addEventListener("click", () => {
                        const monthSelect = document.getElementById("midyear-month");
                        const salaryInput = document.getElementById("midyear-salary");
        
                        if (monthSelect && salaryInput && monthSelect.value && salaryInput.value) {
                            this.addMidyearChange(monthSelect.value, salaryInput.value);
                        }
                    });
                }
        
                // Beállítások mentése gomb kezelése
                const saveSettingsBtn = document.getElementById("save-settings");
                    if (saveSettingsBtn) {
                        // Először töröljük az összes korábban hozzáadott eseménykezelőt
                        saveSettingsBtn.removeEventListener('click', this.saveSettingsHandler);
                
                        // Dedikált eseménykezelő metódus
                        this.saveSettingsHandler = () => {
                            try {
                                this.saveSettings();
                                alert("Beállítások sikeresen mentve!");
                            } catch (error) {
                                console.error("Hiba a beállítások mentése során:", error);
                                alert("Hiba történt a beállítások mentése során!");
                            }
                        };
                
                        // Eseménykezelő hozzáadása
                        saveSettingsBtn.addEventListener('click', this.saveSettingsHandler);
                    }
        
                // Műszakrend és egyéb beállítások inicializálása
                const shiftPatternSelect = document.getElementById("shift-pattern-select");
                const baseSalaryInput = document.getElementById("base-salary");
                const vacationDaysInput = document.getElementById("vacation-days");
                const otherIncomeInput = document.getElementById("other-income");
        
                // Ellenőrizzük, hogy léteznek-e az elemek és van-e settings objektum
                if (shiftPatternSelect && this.yearlyData[this.currentYear]?.settings) {
                    shiftPatternSelect.value = this.yearlyData[this.currentYear].settings.muszakrend || "1";
                }
                if (baseSalaryInput && this.yearlyData[this.currentYear]?.settings) {
                    baseSalaryInput.value = this.yearlyData[this.currentYear].settings.besorolasi_ber || "300000";
                }
                if (vacationDaysInput && this.yearlyData[this.currentYear]?.settings) {
                    vacationDaysInput.value = this.yearlyData[this.currentYear].settings.szabadsag || "25";
                }
                if (otherIncomeInput && this.yearlyData[this.currentYear]?.settings) {
                    otherIncomeInput.value = this.yearlyData[this.currentYear].settings.other_income || "0";
                }
        
                // 25 év alatti beállítások betöltése
                if (under25Checkbox && this.yearlyData[this.currentYear]?.settings?.under25) {
                    under25Checkbox.checked = this.yearlyData[this.currentYear].settings.under25.enabled;
                    if (birthDateContainer) {
                        birthDateContainer.style.display = under25Checkbox.checked ? "block" : "none";
                    }
        
                    const birthYearInput = document.getElementById("birth-year");
                    const birthMonthInput = document.getElementById("birth-month");
        
                    if (birthYearInput) {
                        birthYearInput.value = this.yearlyData[this.currentYear].settings.under25.birthYear || "";
                    }
                    if (birthMonthInput) {
                        birthMonthInput.value = this.yearlyData[this.currentYear].settings.under25.birthMonth || "";
                    }
                }
                            // Besorolási bér mező kezelése
                    const handleSalaryVisibility = () => {
                        const salaryInput = document.getElementById('base-salary');
                        const toggleButton = document.getElementById('toggle-salary-visibility');
                        let isVisible = false;
                        let hideTimeout;
                    
                        if (salaryInput && toggleButton) {
                    // Kezdeti érték elrejtése funkció - most pontokat használunk csillagok helyett
                    const maskValue = (value) => '•'.repeat(value.toString().length);
                    
                    // Input eseménykezelő
                    salaryInput.addEventListener('input', function(e) {
                        clearTimeout(hideTimeout);
                        const value = e.target.value;
                        
                        // Érték ideiglenes megjelenítése
                        this.type = 'number';
                        this.value = value;
                        
                        // Időzítő beállítása az elrejtéshez
                        if (!isVisible) {
                            hideTimeout = setTimeout(() => {
                                this.type = 'text';
                                this.value = maskValue(value);
                                this.classList.add('masked-value');
                            }, 1500);
                        }
                    });
            
                    // Láthatóság kapcsoló
                    toggleButton.addEventListener('click', function() {
                        isVisible = !isVisible;
                        const currentValue = salaryInput.value.replace(/[•]/g, '');
                        
                        if (isVisible) {
                            salaryInput.type = 'number';
                            salaryInput.value = currentValue;
                            this.textContent = '×';
                            salaryInput.classList.remove('masked-value');
                        } else {
                            salaryInput.type = 'text';
                            salaryInput.value = maskValue(currentValue);
                            this.textContent = '•••';
                            salaryInput.classList.add('masked-value');
                        }
                        
                        // Gomb animáció
                        this.style.transform = 'scale(0.8)';
                        setTimeout(() => {
                            this.style.transform = 'scale(1)';
                        }, 100);
                    });
            
                    // Kezdeti állapot beállítása
                    salaryInput.type = 'text';
                    salaryInput.value = maskValue(salaryInput.value);
                    salaryInput.classList.add('masked-value');
            
                    // Mobilbarát érintés kezelés
                    toggleButton.addEventListener('touchstart', function(e) {
                        e.preventDefault(); // Megakadályozza az alapértelmezett érintés viselkedést
                    });
                }
            };
        
                // Színbeállítások betöltése és előnézetek frissítése
                this.loadColorSettings();
                this.updateColorPreviews();
        
                // Évközi változások megjelenítése
                this.displayMidyearChanges();
        
            } catch (error) {
                console.error("Hiba a beállítások inicializálása során:", error);
            }
        }

        changeMonth(direction) {
            const calendarBody = document.getElementById("calendar-body");
            const currentMonthElement = document.getElementById("current-month");
            
            // Add slide out animation
            calendarBody.className = direction > 0 ? 'slide-out-left' : 'slide-out-right';
            
            setTimeout(() => {
                // Change month after slide out animation
                this.currentMonth += direction;
                
                if (this.currentMonth < 0) {
                    if (this.currentYear > 2024) {
                        this.currentMonth = 11;
                        this.currentYear--;
                    } else {
                        this.currentMonth = 0;
                        return;
                    }
                } else if (this.currentMonth > 11) {
                    if (this.currentYear < 2028) {
                        this.currentMonth = 0;
                        this.currentYear++;
                    } else {
                        this.currentMonth = 11;
                        return;
                    }
                }
        
                // Generate new calendar
                this.generateCalendar();
                
                // Add slide in animation
                calendarBody.className = direction > 0 ? 'slide-in-right' : 'slide-in-left';
            }, 200); // Match this with animation duration
        }
        
        changePayrollMonth(direction) {
            const payrollBody = document.getElementById("payroll-body");
            const currentPayrollMonthElement = document.getElementById("current-payroll-month");
            
            // Add slide out animation
            payrollBody.className = direction > 0 ? 'slide-out-left' : 'slide-out-right';
            
            setTimeout(() => {
                // Change month after slide out animation
                this.currentPayrollMonth += direction;
                
                if (this.currentPayrollMonth < 0) {
                    if (this.currentPayrollYear > 2024) {
                        this.currentPayrollMonth = 11;
                        this.currentPayrollYear--;
                    } else {
                        this.currentPayrollMonth = 0;
                        return;
                    }
                } else if (this.currentPayrollMonth > 11) {
                    if (this.currentPayrollYear < 2028) {
                        this.currentPayrollMonth = 0;
                        this.currentPayrollYear++;
                    } else {
                        this.currentPayrollMonth = 11;
                        return;
                    }
                }
        
                // Generate new payroll table
                this.generatePayrollTable();
                
                // Add slide in animation
                payrollBody.className = direction > 0 ? 'slide-in-right' : 'slide-in-left';
            }, 200); // Match this with animation duration
        }

        getHolidays(year) {
            // Fix ünnepnapok
            const fixedHolidays = [
                { month: 0, day: 1 },    // Újév
                { month: 2, day: 15 },   // Március 15.
                { month: 4, day: 1 },    // Munka ünnepe
                { month: 7, day: 20 },   // Államalapítás ünnepe
                { month: 9, day: 23 },   // Október 23.
                { month: 10, day: 1 },   // Mindenszentek
                { month: 11, day: 25 },  // Karácsony
                { month: 11, day: 26 }   // Karácsony másnapja
            ];
        
            // Húsvét és kapcsolódó ünnepek kiszámítása
            const easter = this.calculateEaster(year);
            
            // Nagypéntek (Húsvét vasárnap előtti péntek)
            const goodFriday = new Date(easter);
            goodFriday.setDate(easter.getDate() - 2);
            
            // Húsvéthétfő
            const easterMonday = new Date(easter);
            easterMonday.setDate(easter.getDate() + 1);
            
            // Pünkösd (Húsvét után 49 nappal)
            const pentecost = new Date(easter);
            pentecost.setDate(easter.getDate() + 49);
            
            // Pünkösdhétfő
            const pentecostMonday = new Date(pentecost);
            pentecostMonday.setDate(pentecost.getDate() + 1);
        
            // Mozgó ünnepek hozzáadása
            const movingHolidays = [
                { month: goodFriday.getMonth(), day: goodFriday.getDate() },           // Nagypéntek
                { month: easterMonday.getMonth(), day: easterMonday.getDate() },       // Húsvéthétfő
                { month: pentecostMonday.getMonth(), day: pentecostMonday.getDate() }  // Pünkösdhétfő
            ];
        
            // Összes ünnep összefűzése
            const allHolidays = [...fixedHolidays, ...movingHolidays];
        
            return allHolidays;
        }
        
        // Húsvét vasárnap kiszámítása (Meeus/Jones/Butcher algoritmus)
        calculateEaster(year) {
            const a = year % 19;
            const b = Math.floor(year / 100);
            const c = year % 100;
            const d = Math.floor(b / 4);
            const e = b % 4;
            const f = Math.floor((b + 8) / 25);
            const g = Math.floor((b - f + 1) / 3);
            const h = (19 * a + b - d - g + 15) % 30;
            const i = Math.floor(c / 4);
            const k = c % 4;
            const l = (32 + 2 * e + 2 * i - h - k) % 7;
            const m = Math.floor((a + 11 * h + 22 * l) / 451);
            const month = Math.floor((h + l - 7 * m + 114) / 31) - 1;
            const day = ((h + l - 7 * m + 114) % 31) + 1;
            
            return new Date(year, month, day);
        }

        isHoliday(year, month, day) {
            return this.calculator.isHoliday(year, month, day);
        }

        applyShiftColors(value, shiftDiv, dateSpan) {
            try {
                // Ha üres vagy undefined érték, fehér háttér fekete szöveggel
                if (!value || value === undefined || value.trim() === " " || value.trim() === "") {
                    shiftDiv.style.backgroundColor = "white";
                    shiftDiv.style.color = "black";
                    dateSpan.style.backgroundColor = "#f0f0f0";
                    dateSpan.style.color = "#333";
                    return;
                }
        
                // Keressük a megfelelő színt
                let found = false;
                Object.entries(SHIFT_COLORS).forEach(([type, [bgColor, textColor]]) => {
                    // Normalizáljuk mindkét stringet az összehasonlításhoz
                    const normalizedValue = value.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                    const normalizedType = type.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                    
                    if (normalizedValue.includes(normalizedType)) {
                        shiftDiv.style.backgroundColor = bgColor;
                        shiftDiv.style.color = textColor;
                        dateSpan.style.backgroundColor = bgColor;
                        dateSpan.style.color = textColor;
                        found = true;
                    }
                });
        
                // Ha nem találtunk színt, alapértelmezett színek
                if (!found) {
                    console.log(`Nem található szín: ${value}`); // Debug log
                    shiftDiv.style.backgroundColor = "white";
                    shiftDiv.style.color = "black";
                    dateSpan.style.backgroundColor = "#f0f0f0";
                    dateSpan.style.color = "#333";
                }
            } catch (error) {
                console.error("Hiba a színek alkalmazása során:", error);
            }
        }

        // Naptár generálása
        generateCalendar() {
            try {
                // DOM elemek lekérése
                const calendarBody = document.getElementById("calendar-body");
                const currentMonthElement = document.getElementById("current-month");
                
                if (!calendarBody || !currentMonthElement) {
                    throw new Error("Hiányzó DOM elemek a naptár generálásához");
                }
        
                // Ünnepnapok lekérése az aktuális évre
                const holidays = this.calculator.getHolidays(this.currentYear);
        
                // Hónapok nevei
                const months = [
                    "Január", "Február", "Március", "Április", "Május", "Június",
                    "Július", "Augusztus", "Szeptember", "Október", "November", "December"
                ];
        
                // Hónap és év kiírása a fejlécbe
                currentMonthElement.textContent = `${months[this.currentMonth]} ${this.currentYear}`;
        
                // Adatstruktúrák inicializálása
                if (!this.yearlyData[this.currentYear]) {
                    this.yearlyData[this.currentYear] = {
                        settings: {
                            besorolasi_ber: "300000",
                            szabadsag: "25",
                            muszakrend: "1",
                            other_income: "0",
                            under25: {
                                enabled: false,
                                birthYear: "",
                                birthMonth: ""
                            },
                            midyear_changes: []
                        },
                        calendar_data: {},
                        bonusEntries: {},
                        restaurantEntries: {}
                    };
                }
        
                // Calendar_data inicializálása az aktuális hónapra
                if (!this.yearlyData[this.currentYear].calendar_data[this.currentMonth]) {
                    this.yearlyData[this.currentYear].calendar_data[this.currentMonth] = {};
                }
        
                // Naptár generálás előkészítése
                calendarBody.innerHTML = "";
                const firstDay = new Date(this.currentYear, this.currentMonth, 1).getDay();
                const daysInMonth = new Date(this.currentYear, this.currentMonth + 1, 0).getDate();
                const today = new Date();
                
                // Vasárnap (0) átkonvertálása hétfőre (6)
                const adjustedFirstDay = firstDay === 0 ? 6 : firstDay - 1;
        
                let currentDate = 1;
                let currentWeek = document.createElement("tr");
        
                // Első hét üres celláinak hozzáadása
                for (let i = 0; i < adjustedFirstDay; i++) {
                    const emptyCell = document.createElement("td");
                    currentWeek.appendChild(emptyCell);
                }
        
                // Naptár feltöltése
                while (currentDate <= daysInMonth) {
                    // Ha új hét kezdődik
                    if ((adjustedFirstDay + currentDate - 1) % 7 === 0 && currentDate !== 1) {
                        calendarBody.appendChild(currentWeek);
                        currentWeek = document.createElement("tr");
                    }
        
                    const cell = document.createElement("td");
                    
                    // Ünnepnap ellenőrzése
                    const isCurrentDayHoliday = holidays.some(holiday => 
                        holiday.month === this.currentMonth && holiday.day === currentDate
                    );
        
                    // Mai nap ellenőrzése
                    const isToday = 
                        this.currentYear === today.getFullYear() &&
                        this.currentMonth === today.getMonth() &&
                        currentDate === today.getDate();
        
                    // Dátum konténer létrehozása
                    const dateContainer = document.createElement("div");
                    dateContainer.className = "date-container";
        
                    // Dátum szám létrehozása
                    const dateSpan = document.createElement("span");
                    dateSpan.className = "date-number";
                    dateSpan.textContent = currentDate;
                    dateContainer.appendChild(dateSpan);
        
                    // Műszak div létrehozása
                    const shiftDiv = document.createElement("div");
                    shiftDiv.className = "shift-select";
        
                    // Eseménykezelő hozzáadása
                    shiftDiv.addEventListener("click", (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        
                        const clickedDay = parseInt(dateSpan.textContent);
                        console.log(`Kattintás a következő napra: ${clickedDay}`);
        
                        // Modal létrehozása
                        const overlay = document.createElement("div");
                        overlay.className = "shift-select-overlay";
                        
                        const modal = document.createElement("div");
                        modal.className = "shift-select-modal";
                        
                        // Modal címe
                        const title = document.createElement("h2");
                        title.textContent = `${this.currentYear}. ${this.currentMonth + 1}. ${clickedDay}.`;
                        title.style.marginBottom = "15px";
                        modal.appendChild(title);
        
                        // Műszak opciók
                        const shifts = [
                            "", // Szabadnap
                            "Nappal",
                            "Éjszaka",
                            "Szabadság 12 óra",
                            "Szabadság éj 12 óra",
                            "Szabadság 8 óra",
                            "Szabadság éj 8 óra",
                            "Szabadság 4 óra",
                            "Szabadság éj 4 óra",
                            "Túlóra 12 óra",
                            "Túlóra éj 12 óra",
                            "Túlóra 8 óra",
                            "Túlóra éj 8 óra",
                            "Csúszó 12 óra",
                            "Csúszó éj 12 óra",
                            "Csúszó 8 óra",
                            "Csúszó éj 8 óra",
                            "Csúszó 4 óra",
                            "Csúszó éj 4 óra",
                            "Táppénz"
                        ];
        
                        shifts.forEach(shiftName => {
                            const button = document.createElement("button");
                            button.textContent = shiftName === "" ? "Szabadnap" : shiftName;
                            button.style.display = "block";
                            button.style.width = "100%";
                            button.style.padding = "10px";
                            button.style.marginBottom = "20px";
                            button.style.border = "none";
                            button.style.borderRadius = "5px";
                            
                            const matchedKey = Object.keys(SHIFT_COLORS).find(
                                key => shiftName.includes(key)
                            );
                            
                            if (matchedKey) {
                                const [bgColor, textColor] = SHIFT_COLORS[matchedKey];
                                button.style.backgroundColor = bgColor;
                                button.style.color = textColor;
                            } else if (shiftName === "") {
                                button.style.backgroundColor = "white";
                                button.style.color = "black";
                                button.style.border = "1px solid #ddd";
                            } else {
                                button.style.backgroundColor = "#4a90e2";
                                button.style.color = "white";
                            }
        
                            button.addEventListener("click", () => {
                                const newShift = shiftName === "" ? " " : shiftName;  // Üres string helyett szóköz
                                
                                shiftDiv.textContent = newShift;
                                this.applyShiftColors(newShift, shiftDiv, dateSpan);
                                
                                // Mindig mentsük el az értéket, még ha üres is
                                this.yearlyData[this.currentYear].calendar_data[this.currentMonth][clickedDay] = newShift;
                                
                                console.log(`Módosítás: ${this.currentYear}.${this.currentMonth+1}.${clickedDay} - Új érték: "${newShift}"`);
                                console.log('Módosítás után a hónap adatai:', 
                                    JSON.stringify(this.yearlyData[this.currentYear].calendar_data[this.currentMonth]));
                                
                                this.saveYearlyData();
                                
                                this.currentPayrollMonth = this.currentMonth;
                                this.currentPayrollYear = this.currentYear;
                                this.generatePayrollTable();
                                
                                document.body.removeChild(overlay);
                            });
                            
                            modal.appendChild(button);
                        });
        
                        // Mégsem gomb
                        const closeButton = document.createElement("button");
                        closeButton.textContent = "Mégsem";
                        closeButton.style.display = "block";
                        closeButton.style.width = "100%";
                        closeButton.style.padding = "10px";
                        closeButton.style.backgroundColor = "#ff4d4d";
                        closeButton.style.color = "white";
                        closeButton.style.border = "none";
                        closeButton.style.borderRadius = "5px";
                        
                        closeButton.addEventListener("click", () => {
                            document.body.removeChild(overlay);
                        });
                        
                        modal.appendChild(closeButton);
                        overlay.appendChild(modal);
                        document.body.appendChild(overlay);
        
                        overlay.addEventListener("click", (event) => {
                            if (event.target === overlay) {
                                document.body.removeChild(overlay);
                            }
                        });
                    });
        
                    // Műszak érték meghatározása
                    let shiftValue = this.yearlyData[this.currentYear].calendar_data[this.currentMonth][currentDate];

                    // Csak akkor generáljunk új értéket, ha nincs mentett érték
                    if (shiftValue === undefined) {
                        shiftValue = this.generateShiftPattern(currentDate);
                        
                        // Ha a generált érték nem üres, akkor mentsük el
                        if (shiftValue !== " ") {
                            this.yearlyData[this.currentYear].calendar_data[this.currentMonth][currentDate] = shiftValue;
                        }
                    }
        
                    shiftDiv.textContent = shiftValue;
                    this.applyShiftColors(shiftValue, shiftDiv, dateSpan);
        
                    if (isToday) {
                        cell.classList.add("today");
                    }
                    if (isCurrentDayHoliday) {
                        cell.classList.add("holiday");
                    }
        
                    dateContainer.appendChild(shiftDiv);
                    cell.appendChild(dateContainer);
                    currentWeek.appendChild(cell);
        
                    currentDate++;
                }
        
                // Utolsó hét hozzáadása
                if (currentWeek.hasChildNodes()) {
                    calendarBody.appendChild(currentWeek);
                }
        
                // Adatok mentése
                this.saveYearlyData();
                
            } catch (error) {
                console.error("Hiba a naptár generálása során:", error);
            }
        }

        // Ünnepnapok ellenőrzése
        isHoliday(year, month, day) {
        const holidays = [
            { month: 0, day: 1 }, // Újév
            { month: 2, day: 15 }, // Március 15.
            { month: 3, day: 1 }, // Munka ünnepe
            { month: 4, day: 19 }, // Pünkösd
            { month: 7, day: 20 }, // Államalapítás ünnepe
            { month: 9, day: 23 }, // Nemzeti ünnep
            { month: 11, day: 25 }, // Karácsony
            { month: 11, day: 26 }, // Karácsony másnapja
        ];

        return holidays.some(
            (holiday) => holiday.month === month && holiday.day === day
        );
        }

        generateShiftPattern(day) {
            try {
                const currentDate = new Date(this.currentYear, this.currentMonth, day);
                const currentPattern = this.yearlyData[this.currentYear]?.settings?.muszakrend || "1";
                let shiftValue;
                
                switch (currentPattern) {
                    case "A":
                        // A, B, C műszakrendnél ne generáljon műszakot ünnepnapon
                        if (this.calculator.isHoliday(this.currentYear, this.currentMonth, day)) {
                            return " ";
                        }
                        shiftValue = this.generateAShiftPattern(this.currentYear, this.currentMonth, day);
                        break;
                    case "B":
                        if (this.calculator.isHoliday(this.currentYear, this.currentMonth, day)) {
                            return " ";
                        }
                        shiftValue = this.generateBShiftPattern(this.currentYear, this.currentMonth, day);
                        break;
                    case "C":
                        if (this.calculator.isHoliday(this.currentYear, this.currentMonth, day)) {
                            return " ";
                        }
                        shiftValue = this.generateCShiftPattern(this.currentYear, this.currentMonth, day);
                        break;
                    case "1":
                        shiftValue = this.generateClassicShiftPattern1(currentDate);
                        break;
                    case "2":
                        shiftValue = this.generateClassicShiftPattern2(currentDate);
                        break;
                    case "3":
                        shiftValue = this.generateClassicShiftPattern3(currentDate);
                        break;
                    case "4":
                        shiftValue = this.generateClassicShiftPattern4(currentDate);
                        break;
                    default:
                        shiftValue = " ";
                }
                
                return shiftValue;
            } catch (error) {
                console.error("Hiba a műszakrend generálásánál:", error);
                return " ";
            }
        }
        
        generateAShiftPattern(year, month, day) {
            const shiftCycle = [
                "Nappal", "Nappal", " ", 
                "Éjszaka", "Éjszaka", " ", " ", " ", " ", 
                "Nappal", "Nappal", "Nappal", " ", " ", 
                "Éjszaka", "Éjszaka", "Éjszaka", " ", " ", " ", " "
            ];
        
            // Ha ünnepnap, azonnal térjünk vissza üres értékkel
            if (this.calculator.isHoliday(year, month, day)) {
                return " ";
            }
        
            // UTC dátumokat használunk
            const startDate = new Date(Date.UTC(2025, 0, 6));  // 2025. január 6.
            const currentDate = new Date(Date.UTC(year, month, day));
            const daysDiff = getDaysBetween(startDate, currentDate);
        
            if (daysDiff < 0) {
                const negativeDaysDiff = Math.abs(daysDiff);
                const cycleLength = shiftCycle.length;
                const negativeIndex = (cycleLength - (negativeDaysDiff % cycleLength)) % cycleLength;
                return shiftCycle[negativeIndex];
            }
        
            return shiftCycle[daysDiff % shiftCycle.length];
        }
        
        generateBShiftPattern(year, month, day) {
            const shiftCycle = [
                "Nappal", "Nappal", " ", 
                "Éjszaka", "Éjszaka", " ", " ", " ", " ", 
                "Nappal", "Nappal", "Nappal", " ", " ", 
                "Éjszaka", "Éjszaka", "Éjszaka", " ", " ", " ", " "
            ];
        
            // Ha ünnepnap, azonnal térjünk vissza üres értékkel
            if (this.calculator.isHoliday(year, month, day)) {
                return " ";
            }
        
            const startDate = new Date(Date.UTC(2025, 0, 20));  // 2025. január 20.
            const currentDate = new Date(Date.UTC(year, month, day));
            const daysDiff = getDaysBetween(startDate, currentDate);
        
            if (daysDiff < 0) {
                const negativeDaysDiff = Math.abs(daysDiff);
                const cycleLength = shiftCycle.length;
                const negativeIndex = (cycleLength - (negativeDaysDiff % cycleLength)) % cycleLength;
                return shiftCycle[negativeIndex];
            }
        
            return shiftCycle[daysDiff % shiftCycle.length];
        }
        
        generateCShiftPattern(year, month, day) {
            const shiftCycle = [
                "Nappal", "Nappal", " ", 
                "Éjszaka", "Éjszaka", " ", " ", " ", " ", 
                "Nappal", "Nappal", "Nappal", " ", " ", 
                "Éjszaka", "Éjszaka", "Éjszaka", " ", " ", " ", " "
            ];
        
            // Ha ünnepnap, azonnal térjünk vissza üres értékkel
            if (this.calculator.isHoliday(year, month, day)) {
                return " ";
            }
        
            const startDate = new Date(Date.UTC(2025, 0, 13));  // 2025. január 13.
            const currentDate = new Date(Date.UTC(year, month, day));
            const daysDiff = getDaysBetween(startDate, currentDate);
        
            if (daysDiff < 0) {
                const negativeDaysDiff = Math.abs(daysDiff);
                const cycleLength = shiftCycle.length;
                const negativeIndex = (cycleLength - (negativeDaysDiff % cycleLength)) % cycleLength;
                return shiftCycle[negativeIndex];
            }
        
            return shiftCycle[daysDiff % shiftCycle.length];
        }

        generateClassicShiftPattern1(currentDate) {
            const utcDate = new Date(
                Date.UTC(
                    currentDate.getFullYear(),
                    currentDate.getMonth(),
                    currentDate.getDate()
                )
            );
            const startDate = new Date(Date.UTC(2024, 0, 1));
        
            const daysFromStart = getDaysBetween(startDate, utcDate);
            const cycleDay = ((daysFromStart % 8) + 8) % 8;
        
            return [6, 7].includes(cycleDay)
                ? "Nappal"
                : [2, 3].includes(cycleDay)
                ? "Éjszaka"
                : " ";
        }
        
        generateClassicShiftPattern2(currentDate) {
            const utcDate = new Date(
                Date.UTC(
                    currentDate.getFullYear(),
                    currentDate.getMonth(),
                    currentDate.getDate()
                )
            );
            const startDate = new Date(Date.UTC(2024, 0, 1));
        
            const daysFromStart = getDaysBetween(startDate, utcDate);
            const cycleDay = ((daysFromStart % 8) + 8) % 8;
        
            return [6, 7].includes(cycleDay)
                ? "Éjszaka"
                : [2, 3].includes(cycleDay)
                ? "Nappal"
                : " ";
        }
        
        generateClassicShiftPattern3(currentDate) {
            const utcDate = new Date(
                Date.UTC(
                    currentDate.getFullYear(),
                    currentDate.getMonth(),
                    currentDate.getDate()
                )
            );
            const startDate = new Date(Date.UTC(2024, 0, 1));
        
            const daysFromStart = getDaysBetween(startDate, utcDate);
            const cycleDay = ((daysFromStart % 8) + 8) % 8;
        
            return [0, 1].includes(cycleDay)
                ? "Éjszaka"
                : [4, 5].includes(cycleDay)
                ? "Nappal"
                : " ";
        }
        
        generateClassicShiftPattern4(currentDate) {
            const utcDate = new Date(
                Date.UTC(
                    currentDate.getFullYear(),
                    currentDate.getMonth(),
                    currentDate.getDate()
                )
            );
            const startDate = new Date(Date.UTC(2024, 0, 1));
        
            const daysFromStart = getDaysBetween(startDate, utcDate);
            const cycleDay = ((daysFromStart % 8) + 8) % 8;
        
            return [0, 1].includes(cycleDay)
                ? "Nappal"
                : [4, 5].includes(cycleDay)
                ? "Éjszaka"
                : " ";
        }

        initPayrollNavigation() {
            document.getElementById("prev-payroll-month-btn").addEventListener("click", () => {
                this.changePayrollMonth(-1);
                
                // Évváltás kezelése a 2024-2028 közötti korlátokon belül
                if (this.currentPayrollMonth < 0) {
                    if (this.currentPayrollYear > 2024) {
                        this.currentPayrollMonth = 11;
                        this.currentPayrollYear--;
                    } else {
                        // Ha 2024 januárjánál korábbra próbálunk menni, nem csinálunk semmit
                        this.currentPayrollMonth = 0;
                        return;
                    }
                }
        
                this.generatePayrollTable();
            });
        
            document.getElementById("next-payroll-month-btn").addEventListener("click", () => {
                this.changePayrollMonth(1);
                
                // Évváltás kezelése a 2024-2028 közötti korlátokon belül
                if (this.currentPayrollMonth > 11) {
                    if (this.currentPayrollYear < 2028) {
                        this.currentPayrollMonth = 0;
                        this.currentPayrollYear++;
                    } else {
                        // Ha 2028 decemberénél későbbre próbálunk menni, nem csinálunk semmit
                        this.currentPayrollMonth = 11;
                        return;
                    }
                }
        
                this.generatePayrollTable();
            });

            const payrollSection = document.getElementById("payroll-section");
                let startX = 0;
                let endX = 0;

                payrollSection.addEventListener("touchstart", (e) => {
                    startX = e.touches[0].clientX;
                });

                payrollSection.addEventListener("touchend", (e) => {
                    endX = e.changedTouches[0].clientX;
                    this.handlePayrollSwipe(startX, endX);
                });
        }

        handlePayrollSwipe(startX, endX) {
            // Minimum elmozdulás érzékeléséhez
            const minSwipeDistance = 100;
        
            if (startX - endX > minSwipeDistance) {
                // Balra húzás - következő hónap
                this.changePayrollMonth(1);
            } else if (endX - startX > minSwipeDistance) {
                // Jobbra húzás - előző hónap
                this.changePayrollMonth(-1);
            }
        }

        initColorSettings() {
        const colorSettingsContainer =
            document.getElementById("color-settings");
        if (!colorSettingsContainer) return;

        // Színbeállítások generálása
        Object.entries(SHIFT_COLORS).forEach(
            ([type, [bgColor, textColor]]) => {
            const row = this.createColorSettingRow(type, bgColor, textColor);
            colorSettingsContainer.appendChild(row);
            }
        );

        this.updateColorPreviews();
        }

        createColorSettingRow(type, bgColor, textColor) {
            const row = document.createElement("div");
            row.className = "color-row";
        
            const preview = document.createElement("div");
            preview.className = `color-preview ${this.normalizeClassName(type)}-preview`;
            preview.textContent = type;
        
            const buttonsContainer = document.createElement("div");
            buttonsContainer.className = "color-buttons";
        
            const bgButton = document.createElement("button");
            bgButton.className = "color-picker";
            bgButton.setAttribute("data-shift-type", type.toLowerCase());
            bgButton.setAttribute("data-color-type", "bg");
            bgButton.textContent = "Háttérszín";
        
            const textButton = document.createElement("button");
            textButton.className = "color-picker";
            textButton.setAttribute("data-shift-type", type.toLowerCase());
            textButton.setAttribute("data-color-type", "text");
            textButton.textContent = "Szövegszín";
        
            buttonsContainer.appendChild(bgButton);
            buttonsContainer.appendChild(textButton);
        
            row.appendChild(preview);
            row.appendChild(buttonsContainer);
        
            return row;
        }

        handleColorChange(key, colorType, newColor) {
            if (colorType === "bg") {
                SHIFT_COLORS[key][0] = newColor;
            } else {
                SHIFT_COLORS[key][1] = newColor;
            }
            this.updateColorPreviews();
            this.generateCalendar();
            this.saveColorSettings();
        }

        createColorButton(shiftType, colorType, label) {
        const button = document.createElement("button");
        button.className = "color-picker";
        button.setAttribute("data-shift-type", shiftType.toLowerCase());
        button.setAttribute("data-color-type", colorType);
        button.textContent = label;

        button.addEventListener("click", (e) =>
            this.handleColorPickerClick(e)
        );
        return button;
        }

        normalizeClassName(text) {
        return text
            .toLowerCase()
            .normalize("NFD")
            .replace(/[\u0300-\u036f]/g, "");
        }

        handleColorPickerClick(event) {
            event.preventDefault();
            const button = event.target;
            const shiftType = button.getAttribute("data-shift-type");
            const colorType = button.getAttribute("data-color-type");
            const key = Object.keys(SHIFT_COLORS).find(k => 
                k.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "") === 
                shiftType.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "")
            );
        
            if (!key) return;
        
            // Viewport méretek és modal méretek számítása
            const viewportWidth = window.innerWidth;
            const viewportHeight = window.innerHeight;
            const modalWidth = Math.round(viewportWidth * 0.8);
            const modalHeight = Math.round(viewportHeight * 0.8);

            // A canvasSize most már nagyobb, a modal méretének 95%-a
            const canvasSize = Math.round(Math.min(modalWidth * 1, modalHeight * 0.9));

        
            // Overlay létrehozása
            const overlay = document.createElement("div");
            overlay.style.position = "fixed";
            overlay.style.top = "0";
            overlay.style.left = "0";
            overlay.style.width = "100%";
            overlay.style.height = "100%";
            overlay.style.backgroundColor = "rgba(0, 0, 0, 0.5)";
            overlay.style.zIndex = "999";
            overlay.style.display = "flex";
            overlay.style.alignItems = "center";
            overlay.style.justifyContent = "center";
        
            // Modal létrehozása
            const modal = document.createElement("div");
            modal.style.backgroundColor = "#333";
            modal.style.padding = "15px"; // csökkentett padding
            modal.style.borderRadius = "10px";
            modal.style.width = "modalWidth";
            modal.style.height = "modalHeight";
            modal.style.boxSizing = "border-box";
            modal.style.display = "flex";
            modal.style.flexDirection = "column";
            modal.style.alignItems = "center";
            modal.style.gap = "8px"; // kisebb gap az elemek között
            modal.style.overflow = "hidden";
        
            // Színválasztó canvas
            const canvas = document.createElement("canvas");
            canvas.width = canvasSize;
            canvas.height = canvasSize;
            canvas.style.cursor = "crosshair";
        
            // Canvas konténer
            const canvasContainer = document.createElement("div");
            canvasContainer.style.position = "relative";
            canvasContainer.style.width = canvasSize + "px";
            canvasContainer.style.height = canvasSize + "px";
            canvasContainer.style.margin = "0"; // nincs margin
        
            // Kör jelző
            const colorSelector = document.createElement("div");
            colorSelector.style.position = "absolute";
            colorSelector.style.width = "10px";
            colorSelector.style.height = "10px";
            colorSelector.style.border = "2px solid white";
            colorSelector.style.borderRadius = "50%";
            colorSelector.style.pointerEvents = "none";
            colorSelector.style.transform = "translate(-50%, -50%)";
            colorSelector.style.boxShadow = "0 0 0 1px black";
        
            canvasContainer.appendChild(canvas);
            canvasContainer.appendChild(colorSelector);
        
            // Színsáv konténer
            const hueContainer = document.createElement("div");
            hueContainer.style.position = "relative";
            hueContainer.style.width = canvasSize + "px";
            hueContainer.style.height = "40px";
            hueContainer.style.margin = "5px 0"; // kisebb margin
        
            // Színsáv létrehozása - a szélesség ugyanakkora mint a fő canvas
            const hueCanvas = document.createElement("canvas");
            hueCanvas.width = canvasSize;
            hueCanvas.height = 40;  // magasabb, hogy jobban látható legyen
            hueCanvas.style.cursor = "pointer";
        
            // Színsáv csúszka
            const hueSlider = document.createElement("div");
            hueSlider.style.position = "absolute";
            hueSlider.style.top = "0";
            hueSlider.style.width = "4px";
            hueSlider.style.height = "40px";
            hueSlider.style.backgroundColor = "white";
            hueSlider.style.border = "1px solid black";
            hueSlider.style.pointerEvents = "none";
            hueSlider.style.transform = "translateX(-50%)";
        
            hueContainer.appendChild(hueCanvas);
            hueContainer.appendChild(hueSlider);
        
            // RGB kijelző
            const rgbDisplay = document.createElement("div");
            rgbDisplay.style.backgroundColor = "#222";
            rgbDisplay.style.padding = "5px";  // nagyobb padding
            rgbDisplay.style.borderRadius = "5px";
            rgbDisplay.style.color = "white";
            rgbDisplay.style.fontFamily = "monospace";
            rgbDisplay.style.fontSize = "14px";  // nagyobb betűméret
            rgbDisplay.style.textAlign = "center";
            rgbDisplay.style.width = "100%";
            rgbDisplay.style.maxWidth = canvasSize + "px";
            rgbDisplay.style.marginTop = "5px";
        
            // Előnézeti panel
            const colorPreview = document.createElement("div");
            colorPreview.style.width = "100%";
            colorPreview.style.maxWidth = canvasSize + "px";
            colorPreview.style.height = "40px";  // magasabb előnézeti panel
            colorPreview.style.border = "2px solid #444";
            colorPreview.style.borderRadius = "5px";
        
            let currentHue = 0;
            let currentPos = { x: 0, y: 0 };
            let isDragging = false;
            let isHueDragging = false;
            let currentColor = colorType === "bg" ? SHIFT_COLORS[key][0] : SHIFT_COLORS[key][1];
            colorPreview.style.backgroundColor = currentColor;
        
            // Kontextek létrehozása
            const ctx = canvas.getContext("2d", { willReadFrequently: true });
            const hueCtx = hueCanvas.getContext("2d", { willReadFrequently: true });
        
            // Színsáv rajzolása
            const drawHueBar = () => {
                const gradient = hueCtx.createLinearGradient(0, 0, hueCanvas.width, 0);
                for (let i = 0; i <= 360; i += 30) {
                    gradient.addColorStop(i / 360, `hsl(${i}, 100%, 50%)`);
                }
                hueCtx.fillStyle = gradient;
                hueCtx.fillRect(0, 0, hueCanvas.width, hueCanvas.height);
            };
        
            // Színspektrum rajzolása
            const drawSpectrum = (hue) => {
                const pureColor = `hsl(${hue}, 100%, 50%)`;
                
                const whiteGrad = ctx.createLinearGradient(0, 0, canvas.width, 0);
                whiteGrad.addColorStop(0, "rgb(255,255,255)");
                whiteGrad.addColorStop(1, pureColor);
                ctx.fillStyle = whiteGrad;
                ctx.fillRect(0, 0, canvas.width, canvas.height);
        
                const blackGrad = ctx.createLinearGradient(0, 0, 0, canvas.height);
                blackGrad.addColorStop(0, "rgba(0,0,0,0)");
                blackGrad.addColorStop(1, "rgba(0,0,0,1)");
                ctx.fillStyle = blackGrad;
                ctx.fillRect(0, 0, canvas.width, canvas.height);
            };
        
            const validateRGB = (r, g, b) => {
                return {
                    r: Math.max(0, Math.min(255, Math.round(r))),
                    g: Math.max(0, Math.min(255, Math.round(g))),
                    b: Math.max(0, Math.min(255, Math.round(b)))
                };
            };
        
            const updateColor = (x, y) => {
                x = Math.max(0, Math.min(x, canvas.width - 1));
                y = Math.max(0, Math.min(y, canvas.height - 1));
                
                const pixel = ctx.getImageData(x, y, 1, 1).data;
                const rgb = validateRGB(pixel[0], pixel[1], pixel[2]);
                
                currentColor = `#${rgb.r.toString(16).padStart(2,'0')}${rgb.g.toString(16).padStart(2,'0')}${rgb.b.toString(16).padStart(2,'0')}`;
                rgbDisplay.textContent = `RGB: ${rgb.r}, ${rgb.g}, ${rgb.b}`;
                colorPreview.style.backgroundColor = currentColor;
                
                colorSelector.style.left = `${x}px`;
                colorSelector.style.top = `${y}px`;
                currentPos = { x, y };
            };
        
            const updateHue = (x) => {
                x = Math.max(0, Math.min(x, hueCanvas.width));
                currentHue = (x / hueCanvas.width) * 360;
                drawSpectrum(currentHue);
                hueSlider.style.left = `${x}px`;
                if (currentPos.x !== undefined && currentPos.y !== undefined) {
                    updateColor(currentPos.x, currentPos.y);
                }
            };
        
            const handleHueSelect = (e) => {
                const rect = hueCanvas.getBoundingClientRect();
                const x = Math.max(0, Math.min(e.clientX - rect.left, hueCanvas.width));
                updateHue(x);
            };
        
            const handleColorSelect = (e) => {
                const rect = canvas.getBoundingClientRect();
                const x = Math.max(0, Math.min(e.clientX - rect.left, canvas.width - 1));
                const y = Math.max(0, Math.min(e.clientY - rect.top, canvas.height - 1));
                updateColor(x, y);
            };
        
            // Mouse események
            canvas.addEventListener("mousedown", (e) => {
                e.preventDefault();
                isDragging = true;
                handleColorSelect(e);
            });
        
            hueCanvas.addEventListener("mousedown", (e) => {
                e.preventDefault();
                isHueDragging = true;
                handleHueSelect(e);
            });
        
            document.addEventListener("mousemove", (e) => {
                if (isDragging) handleColorSelect(e);
                if (isHueDragging) handleHueSelect(e);
            });
        
            document.addEventListener("mouseup", () => {
                isDragging = false;
                isHueDragging = false;
            });
        
            // Touch események
            canvas.addEventListener("touchstart", (e) => {
                e.preventDefault();
                isDragging = true;
                const touch = e.touches[0];
                const rect = canvas.getBoundingClientRect();
                const x = Math.max(0, Math.min(touch.clientX - rect.left, canvas.width - 1));
                const y = Math.max(0, Math.min(touch.clientY - rect.top, canvas.height - 1));
                updateColor(x, y);
            });
        
            hueCanvas.addEventListener("touchstart", (e) => {
                e.preventDefault();
                isHueDragging = true;
                const touch = e.touches[0];
                handleHueSelect(touch);
            });
        
            document.addEventListener("touchmove", (e) => {
                e.preventDefault();
                const touch = e.touches[0];
                if (isDragging) {
                    const rect = canvas.getBoundingClientRect();
                    const x = Math.max(0, Math.min(touch.clientX - rect.left, canvas.width - 1));
                    const y = Math.max(0, Math.min(touch.clientY - rect.top, canvas.height - 1));
                    updateColor(x, y);
                }
                if (isHueDragging) {
                    handleHueSelect(touch);
                }
            });
        
            document.addEventListener("touchend", () => {
                isDragging = false;
                isHueDragging = false;
            });
        
            // Gombok
            const buttonContainer = document.createElement("div");
            buttonContainer.style.display = "flex";
            buttonContainer.style.height = "60px";
            buttonContainer.style.gap = "8px";
            buttonContainer.style.width = canvasSize + "px";
            buttonContainer.style.marginTop = "5px";
        
            const saveButton = document.createElement("button");
            saveButton.textContent = "Mentés";
            saveButton.style.flex = "1";
            saveButton.style.padding = "10px";
            saveButton.style.fontSize = "25px";
            saveButton.style.backgroundColor = "#4CAF50";
            saveButton.style.color = "white";
            saveButton.style.border = "none";
            saveButton.style.borderRadius = "5px";
            saveButton.style.cursor = "pointer";
        
            const cancelButton = document.createElement("button");
            cancelButton.textContent = "Mégse";
            cancelButton.style.flex = "1";
            cancelButton.style.padding = "10px";
            cancelButton.style.fontSize = "25px";
            cancelButton.style.backgroundColor = "#f44336";
            cancelButton.style.color = "white";
            cancelButton.style.border = "none";
            cancelButton.style.borderRadius = "5px";
            cancelButton.style.cursor = "pointer";
        
            buttonContainer.appendChild(saveButton);
            buttonContainer.appendChild(cancelButton);
        
            // Modal összeállítása
            modal.appendChild(canvasContainer);
            modal.appendChild(hueContainer);
            modal.appendChild(rgbDisplay);
            modal.appendChild(colorPreview);
            modal.appendChild(buttonContainer);
            overlay.appendChild(modal);
            document.body.appendChild(overlay);
        
            // Kezdeti állapot beállítása
            drawHueBar();
            drawSpectrum(currentHue);
        
            // Kezdeti szín beállítása
            const setInitialPosition = () => {
                const r = parseInt(currentColor.slice(1,3), 16);
                const g = parseInt(currentColor.slice(3,5), 16);
                const b = parseInt(currentColor.slice(5,7), 16);
                
                let minDiff = Infinity;
                let bestX = 0;
                let bestY = 0;
                
                for(let x = 0; x < canvas.width; x += 5) {
                    for(let y = 0; y < canvas.height; y += 5) {
                        const pixel = ctx.getImageData(x, y, 1, 1).data;
                        const diff = Math.abs(pixel[0] - r) + Math.abs(pixel[1] - g) + Math.abs(pixel[2] - b);
                        if(diff < minDiff) {
                            minDiff = diff;
                            bestX = x;
                            bestY = y;
                        }
                    }
                }
                
                const hsl = rgbToHsl(r, g, b);
                const hueX = (hsl.h / 360) * hueCanvas.width;
                updateHue(hueX);
                    updateColor(bestX, bestY);
                };

                // RGB to HSL konvertáló
                const rgbToHsl = (r, g, b) => {
                    r /= 255;
                    g /= 255;
                    b /= 255;

                    const max = Math.max(r, g, b);
                    const min = Math.min(r, g, b);
                    let h, s, l = (max + min) / 2;

                    if (max === min) {
                        h = s = 0;
                    } else {
                        const d = max - min;
                        s = l > 0.5 ? d / (2 - max - min) : d / (max + min);

                        switch (max) {
                            case r: h = (g - b) / d + (g < b ? 6 : 0); break;
                            case g: h = (b - r) / d + 2; break;
                            case b: h = (r - g) / d + 4; break;
                        }

                        h = Math.round(h * 60);
                        if (h < 0) h += 360;
                    }

                    return { h, s, l };
                };

                // Gomb események
                saveButton.addEventListener("click", () => {
                    if (colorType === "bg") {
                        SHIFT_COLORS[key][0] = currentColor;
                    } else {
                        SHIFT_COLORS[key][1] = currentColor;
                    }
                    this.updateColorPreviews();
                    this.generateCalendar();
                    this.saveColorSettings();
                    document.body.removeChild(overlay);
                });

                cancelButton.addEventListener("click", () => {
                    document.body.removeChild(overlay);
                });

                // Overlay bezárása kattintásra
                overlay.addEventListener("click", (e) => {
                    if (e.target === overlay) {
                        document.body.removeChild(overlay);
                    }
                });

                // Késleltetett kezdeti pozíció beállítás
                setTimeout(setInitialPosition, 50);
            }
        
        generatePayrollTable() {
            try {
                // Ellenőrizzük és inicializáljuk az adott év adatait
                if (!this.yearlyData[this.currentPayrollYear]) {
                    this.yearlyData[this.currentPayrollYear] = {
                        settings: {
                            besorolasi_ber: "300000",
                            szabadsag: "25",
                            muszakrend: "1",
                            other_income: "0",
                            children_count: "0",
                            under25: {
                                enabled: false,
                                birthYear: "",
                                birthMonth: "",
                            },
                            midyear_changes: [],
                        },
                        calendar_data: {},
                        bonusEntries: {},
                        restaurantEntries: {},
                    };
                }
        
                // Ha nincs még calendar_data az adott hónapra, inicializáljuk
                if (!this.yearlyData[this.currentPayrollYear].calendar_data[this.currentPayrollMonth]) {
                    this.yearlyData[this.currentPayrollYear].calendar_data[this.currentPayrollMonth] = {};
                    // Generáljuk ki a műszakrendet
                    const daysInMonth = new Date(this.currentPayrollYear, this.currentPayrollMonth + 1, 0).getDate();
                    for (let day = 1; day <= daysInMonth; day++) {
                        const shiftValue = this.generateShiftPattern(day);
                        if (shiftValue !== " ") {
                            this.yearlyData[this.currentPayrollYear].calendar_data[this.currentPayrollMonth][day] = shiftValue;
                        }
                    }
                    this.saveYearlyData();
                }
        
                const payrollBody = document.getElementById("payroll-body");
                const currentPayrollMonthElement = document.getElementById("current-payroll-month");
        
                const months = [
                    "Január", "Február", "Március", "Április", "Május", "Június",
                    "Július", "Augusztus", "Szeptember", "Október", "November", "December"
                ];
        
                currentPayrollMonthElement.textContent = 
                    `${months[this.currentPayrollMonth]} ${this.currentPayrollYear}`;
        
                payrollBody.innerHTML = "";
        
                // Tételek és utótagok definíciója
                const items = [
                    { label: "Ledolgozandó napok", suffix: " nap" },
                    { label: "Ledolgozott napok", suffix: " nap" },
                    { label: "Szabadság kivét (óra)", suffix: " óra" },
                    { label: "Túlóra (100%)", suffix: " óra" },
                    { label: "Hétvégi pótlék 50%", suffix: " óra" },
                    { label: "Műszakpótlék 40%", suffix: " óra" },
                    { label: "Alapbér", suffix: " Ft" },
                    { label: "Túlóra alap", suffix: " Ft" },
                    { label: "Szabadságra jutó fizetés", suffix: " Ft" },
                    { label: "Távolléti díj", suffix: " Ft" },
                    { label: "Fizetett ünnepnap", suffix: " Ft" },
                    { label: "Túlórapótlék", suffix: " Ft" },
                    { label: "Hétvégi pótlék (50%)", suffix: " Ft" },
                    { label: "Műszakpótlék (40%)", suffix: " Ft" },
                    { label: "Teljesítmény prémium", suffix: " Ft" },
                    { label: "Bónusz", suffix: "" },
                    { label: "Éttermi fogyasztás", suffix: " Ft" },
                    { label: "Bruttó bér", suffix: " Ft" },
                    { label: "TB Járulék 18,5%", suffix: " Ft" },
                    { label: "Rendszeres SZJA előleg", suffix: " Ft" },
                    { label: "Családi adókedvezmény", suffix: " Ft" },
                    { label: "Nettó", suffix: " Ft" },
                    { label: "Megmaradt szabadságok", suffix: " nap" },
                ];
        
                items.forEach((item) => {
                    const row = document.createElement("tr");
                    const labelCell = document.createElement("td");
                    const valueCell = document.createElement("td");
        
                    labelCell.textContent = item.label;
        
                    if (item.label === "Bónusz") {
                        const input = document.createElement("input");
                        input.type = "number";
                        input.min = "0";
                        input.max = "2";
                        input.step = "1";
                        input.className = "w-24 text-right px-2 py-1 border rounded";
        
                        const value = this.yearlyData[this.currentPayrollYear].bonusEntries?.[this.currentPayrollMonth] ?? 2;
                        input.value = value;
                        valueCell.appendChild(input);
        
                        input.addEventListener("change", (e) => {
                            window.validateBonus(e.target, this.currentPayrollMonth);
                        });
                    } 
                    else if (item.label === "Éttermi fogyasztás") {
                        const input = document.createElement("input");
                        input.type = "number";
                        input.min = "0";
                        input.step = "1";
                        input.className = "w-24 text-right px-2 py-1 border rounded";
        
                        const value = this.yearlyData[this.currentPayrollYear].restaurantEntries?.[this.currentPayrollMonth] || 0;
                        input.value = value;
                        valueCell.appendChild(input);
        
                        input.addEventListener("change", (e) => {
                            window.validateRestaurant(e.target, this.currentPayrollMonth);
                        });
                    } 
                    else {
                        // Normál értékek megjelenítése utótaggal
                        const value = this.calculator.calculateMonthlyValue(
                            item.label,
                            this.currentPayrollMonth,
                            this.currentPayrollYear
                        );
        
                        // Érték formázása a típus szerint
                        let formattedValue;
                        if (item.suffix === " nap") {
                            formattedValue = parseFloat(value).toFixed(1);
                        } else if (item.suffix === " Ft") {
                            formattedValue = Math.round(value);
                        } else {
                            formattedValue = Math.round(value);
                        }
        
                        // Ezres tagolás hozzáadása és utótag
                        valueCell.textContent = formattedValue !== 0
                            ? formattedValue.toLocaleString("hu-HU") + item.suffix
                            : "0" + item.suffix;
                    }
        
                    row.appendChild(labelCell);
                    row.appendChild(valueCell);
                    payrollBody.appendChild(row);
                });
            } catch (error) {
                console.error("Hiba a bérszámfejtési táblázat generálása során:", error);
            }
        }

        loadData() {
        try {
            const savedData = localStorage.getItem("berszamfejtoData");

            if (savedData) {
            const parsedData = JSON.parse(savedData);
            console.log("Betöltött adatok:", parsedData);

            // Az adatok visszatöltése a yearData objektumba
            this.yearData = {
                calendar_data: parsedData.calendar_data || {},
                bonusEntries: parsedData.bonusEntries || {},
                restaurantEntries: parsedData.restaurantEntries || {},
                settings: {
                besorolasi_ber:
                    this.settings.baseSalary?.toString() || "300000",
                szabadsag: this.settings.vacationDays?.toString() || "25",
                muszakrend: this.settings.shiftPattern || "1",
                },
            };
            }
        } catch (error) {
            console.error("Hiba az adatok betöltése során:", error);
        }
        }

        updateColorPreviews() {
        Object.entries(SHIFT_COLORS).forEach(
            ([type, [bgColor, textColor]]) => {
            // Normalizáljuk a class nevet (ékezetek eltávolítása)
            const previewClass =
                type
                .toLowerCase()
                .normalize("NFD")
                .replace(/[\u0300-\u036f]/g, "") + "-preview";

            const preview = document.querySelector(`.${previewClass}`);
            if (preview) {
                preview.style.backgroundColor = bgColor;
                preview.style.color = textColor;
                preview.textContent = type;
            }
            }
        );
        }

        saveColorSettings() {
        localStorage.setItem("shiftColors", JSON.stringify(SHIFT_COLORS));
        }

        loadColorSettings() {
        const savedColors = localStorage.getItem("shiftColors");
        if (savedColors) {
            const parsedColors = JSON.parse(savedColors);
            Object.entries(parsedColors).forEach(([key, value]) => {
            if (SHIFT_COLORS[key]) {
                SHIFT_COLORS[key] = value;
            }
            });
            this.updateColorPreviews();
        }
        }

        saveSettings() {
            try {
                const shiftPatternSelect = document.getElementById("shift-pattern-select");
                const baseSalaryInput = document.getElementById("base-salary");
                const vacationDaysInput = document.getElementById("vacation-days");
                const otherIncomeInput = document.getElementById("other-income");
                const under25Checkbox = document.getElementById("under25-checkbox");
                const birthYearInput = document.getElementById("birth-year");
                const birthMonthInput = document.getElementById("birth-month");
                const currentMonth = this.currentMonth;
                const childrenCountInput = document.getElementById("children-count");
                
        
                if (!shiftPatternSelect || !baseSalaryInput) {
                    throw new Error("Hiányzó form elemek");
                }
        
                // Az előző műszakrend lekérése az összehasonlításhoz
                const oldShiftPattern = this.yearlyData[this.currentSettingsYear]?.settings?.muszakrend || "1";
                const newShiftPattern = shiftPatternSelect.value;
                const shiftPatternChanged = oldShiftPattern !== newShiftPattern;
        
                // A beállítások frissítése az aktuális évre
                if (!this.yearlyData[this.currentSettingsYear]) {
                    this.yearlyData[this.currentSettingsYear] = {
                        settings: {
                            besorolasi_ber: "300000",
                            szabadsag: "25",
                            muszakrend: "1",
                            other_income: "0",
                            children_count: "0",
                            under25: {
                                enabled: false,
                                birthYear: "",
                                birthMonth: ""
                            },
                            midyear_changes: []
                        },
                        calendar_data: {},
                        bonusEntries: {},
                        restaurantEntries: {}
                    };
                }
        
                // A beállítások mentése
                this.yearlyData[this.currentSettingsYear].settings = {
                    ...this.yearlyData[this.currentSettingsYear].settings,
                    besorolasi_ber: baseSalaryInput.value,
                    szabadsag: vacationDaysInput?.value || "25",
                    muszakrend: newShiftPattern,
                    other_income: otherIncomeInput?.value || "0",
                    children_count: childrenCountInput?.value || "0",
                    under25: {
                        enabled: under25Checkbox?.checked || false,
                        birthYear: birthYearInput?.value || "",
                        birthMonth: birthMonthInput?.value || ""
                    }
                };
        
                // Csak akkor generáljuk újra a naptárat, ha változott a műszakrend
                    if (shiftPatternChanged) {
                        const year = this.currentSettingsYear;
                        
                        // Ha változott a műszakrend, teljesen új calendar_data-t hozunk létre
                        this.yearlyData[year].calendar_data = {};
                        
                        // Új naptár generálása minden hónapra
                        for (let month = 0; month < 12; month++) {
                            this.yearlyData[year].calendar_data[month] = {};
                            
                            const daysInMonth = new Date(year, month + 1, 0).getDate();
                            for (let day = 1; day <= daysInMonth; day++) {
                                const previousYear = this.currentYear;
                                this.currentYear = year;
                                this.currentMonth = month;
                                
                                const shiftValue = this.generateShiftPattern(day);
                                
                                this.currentYear = previousYear;
                                this.currentMonth = this.currentMonth;

                                if (shiftValue !== " ") {
                                    this.yearlyData[year].calendar_data[month][day] = shiftValue;
                                }
                            }
                        }
                    }
        
                // Adatok mentése
                this.saveYearlyData();
                
                // Naptár és bérszámfejtés frissítése
                this.currentMonth = currentMonth;
                this.generateCalendar();
                this.generatePayrollTable();
        
            } catch (error) {
                console.error("Hiba a beállítások mentése során:", error);
                alert("Hiba történt a beállítások mentése során!");
            }
        }
    }

    document.addEventListener("DOMContentLoaded", () => {
        console.log("DOMContentLoaded started"); // Debug log
        window.app = new BerszamfejtoApp(); // Globális változóként tároljuk
    });
        // Service Worker regisztrálása
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('/naptar/service-worker.js', {
                scope: '/naptar/'
            })
            .then(registration => {
                console.log('ServiceWorker regisztrálva:', registration);
            })
            .catch(error => {
                console.log('ServiceWorker regisztrálási hiba:', error);
            });
        });
    }
    </script>
</body>
</html>
